[include moonraker_obico_macros.cfg]
##########################
##### BASE CONFIG #######
##########################

[include mainsail.cfg]
[include ./backup/backup.cfg]

##########################
##### HARDWARE STUFF #####
##########################

[include ./hardware/xyz-stepper.cfg]
[include ./hardware/extruder.cfg]
#[include ./klicky/klicky-probe.cfg]
#[include ./hardware/adxl345.cfg]  This config now in canbus.cfg
[include ./hardware/fans.cfg] # Some fans config in canbus.cfg
[include ./hardware/canbus.cfg]

##########################
##### LIGHTS #############
##########################

[include ./hardware/chamber-lighting.cfg]
[include ./hardware/stealthburner-led.cfg]

##########################
##### CALIBRATION ########
##########################

[include ./calibration/z-tilt.cfg]
[include ./calibration/bed-mesh.cfg]
[include ./macros/unsafe.cfg]
[include ./calibration/pressure_advance.cfg]
[include ./calibration/test_speed.cfg]
[include ./calibration/pika.cfg]
[include ./calibration/microadjust.cfg]
[include ./calibration/sensorless.cfg]
[include test_probe_accuracy.cfg]
[include K-ShakeTune/*.cfg]

##########################
##### MACROS #############
##########################

[include ./macros/chamber-led.cfg]
[include ./macros/conditional-homing.cfg]
[include ./macros/print-end.cfg]
[include ./macros/print-start-mmu.cfg]
[include ./macros/dump-variables.cfg]
[include ./macros/movement-check.cfg]
[include ./macros/cancel-change.cfg]
[include ./macros/pause-resume.cfg]         ; Overridden by ERCF / subsequantly disabled
[include ./macros/load-unload.cfg]
[include ./macros/filament-change.cfg]
[include ./macros/park.cfg]
[include ./macros/heatsoak.cfg]

##########################
##### THIRD PARTY ########
##########################

#[include ./third-party-cfg/nozzle_scrub.cfg]
[include KAMP_Settings.cfg]

##########################
##### ERCF ###############
##########################

[include mmu/base/*.cfg]
[include macros/mmu_adds.cfg]
[include mmu/optional/mmu_ercf_cutter.cfg]

##########################
##### LCD/MENU ###########
##########################

#[include ./third-party-cfg/nozzle_scrub_menu.cfg]
#[include ./menu/printer_menu.cfg]

##########################
##### NOT ENABLED YET ####
##########################

#[include ./todo/mini12864.cfg] Add this after adding mini12864 LED
#[include ./todo/lcd_tweaks.cfg] Need to figure this one out and then implement
#[include ./hardware/nevermore.cfg] Disabled as I prefer to chamber vent outside and needed the PWM

##########################
#### REPLACEMENT #########
##########################

[include ./replacement_macros/replace-m900.cfg]
[include ./replacement_macros/replace-m117.cfg]

[exclude_object]

[gcode_arcs]
resolution: 0.1

[respond]
default_type: echo
default_prefix:  

[force_move]
# Enable commands that force potentially unsafe movement
enable_force_move: True

[idle_timeout]
timeout: 14400

[mcu]
##  Obtain definition by "ls -l /dev/serial/by-id/" then unplug to verify
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_290040000750314D35323820-if00
restart_method: command

[mcu rpi]
# Add Rpi as secondary MCU to allow for ADXL use through SPI ribbon/adapter from LDO
serial: /tmp/klipper_host_mcu

[mcu sht]
canbus_uuid: 30993412e8e0

[printer]
kinematics: corexy
max_velocity: 250           # Changed from 200 on 7.11.23
max_accel: 6000             # tuned on 7.11.23 after beacon install.
max_accel_to_decel: 3000
max_z_velocity: 15          #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 350
square_corner_velocity: 5.0 # Changed on 7.11.23

#####################################################################
#   Input Shaper
#####################################################################

[input_shaper]
shaper_freq_x: 71.0
shaper_type_x: mzv # 14900
shaper_freq_y: 47.8
shaper_type_y: mzv # 6700
damping_ratio_x: 0.043
damping_ratio_y: 0.055
# Not Noisy: 20-22.5 / 60.6-96.7 / 30.2-48 / 111.4-200 mm/s

#####################################################################
#   AutoTune / https://github.com/andrewmcgr/klipper_tmc_autotune
#####################################################################

#[motor_constants ldo-42sth48-2004mah_vrn]
#resistance: 1.45
#inductance: 0.002
#holding_torque: 0.40
#max_current: 2.0
#steps_per_revolution: 400

#[autotune_tmc stepper_x]
#motor: ldo-42sth48-2004mah_vrn
#sg4_thrs: 105
#tuning_goal: silent
#[autotune_tmc stepper_y]
#motor: ldo-42sth48-2004mah_vrn
#tuning_goal: silent

#[autotune_tmc stepper_z]
#motor: ldo-42sth40-1684l300e
#[autotune_tmc stepper_z1]
#motor: ldo-42sth40-1684l300e
#[autotune_tmc stepper_z2]
#motor: ldo-42sth40-1684l300e

#[autotune_tmc extruder]
#motor: moons-cse14hra1l410a

#####################################################################
#   Bed Heater
#####################################################################

##  SSR Pin - HE1
##  Thermistor - TB
[heater_bed]
heater_pin: PA2 #PA2 is LDO default
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF3
##  Adjust Max Power so your heater doesn't warp your bed. Rule of thumb is 0.4 watts / cm^2 .
max_power: 1
min_temp: 0
max_temp: 125
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

#####################################################################
#   Probe
#####################################################################

##  WAS TAP - NOW BEACON in CANBUS

#####################################################################
#   Additional Sensors
#####################################################################

[thermistor CMFB103F3950FANT]
temperature1: 0.0
resistance1: 32116.0
temperature2: 40.0
resistance2: 5309.0
temperature3: 80.0
resistance3: 1228.0

#[temperature_sensor sb_ambient_temp]
## Chamber Temperature - T1
#sensor_type: CMFB103F3950FANT
#sensor_pin: PF5
#min_temp: 0
#max_temp: 100
#gcode_id: chamber_th

[temperature_sensor back_chamber_temp]
## Chamber Temperature - T
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PF6
min_temp: 0
max_temp: 100
gcode_id: chamber_th2

[temperature_sensor RPi4]
sensor_type: temperature_host
min_temp: 0
max_temp: 100

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<5V>

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 39.889
#*# pid_ki = 0.964
#*# pid_kd = 412.851
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.036101, 0.033037, 0.024357, 0.016502, 0.007967, 0.003519, 0.001485, -0.002320, -0.005363, -0.007050, -0.011342, -0.012011, -0.014143, -0.017101, -0.014128, -0.009440, -0.008555, -0.012080, -0.010271, -0.010913, -0.012601, -0.002567, 0.000940, 0.010919, 0.018470
#*# 	  0.039867, 0.031834, 0.019098, 0.011706, 0.005517, -0.000489, -0.005287, -0.009757, -0.010461, -0.012779, -0.017306, -0.020327, -0.018059, -0.019709, -0.022091, -0.019442, -0.014128, -0.016106, -0.016382, -0.015637, -0.014708, -0.011970, -0.004510, 0.001239, 0.008341
#*# 	  0.038703, 0.026646, 0.016254, 0.009139, 0.001195, -0.004912, -0.010232, -0.014560, -0.015562, -0.014779, -0.020226, -0.023668, -0.023061, -0.024152, -0.025747, -0.025349, -0.024305, -0.022793, -0.021670, -0.019499, -0.015426, -0.013770, -0.009567, -0.006662, -0.000446
#*# 	  0.036577, 0.022512, 0.013169, 0.002309, -0.000153, -0.009796, -0.015028, -0.017345, -0.019445, -0.021986, -0.023743, -0.025790, -0.027381, -0.027787, -0.029911, -0.030884, -0.028665, -0.027227, -0.024856, -0.021029, -0.018510, -0.013103, -0.011235, -0.010095, -0.005381
#*# 	  0.036677, 0.024252, 0.013187, 0.004291, -0.002307, -0.008473, -0.013956, -0.017471, -0.018858, -0.021110, -0.023745, -0.026360, -0.026238, -0.027134, -0.029090, -0.030395, -0.028303, -0.027541, -0.024925, -0.020446, -0.015712, -0.012058, -0.010099, -0.010270, -0.005239
#*# 	  0.035761, 0.022995, 0.011383, 0.002792, -0.007942, -0.011055, -0.015141, -0.019691, -0.021089, -0.022857, -0.027005, -0.028737, -0.027097, -0.027090, -0.029085, -0.030937, -0.029620, -0.028461, -0.027511, -0.022672, -0.017458, -0.014918, -0.012892, -0.013604, -0.009772
#*# 	  0.035564, 0.022206, 0.010749, 0.000681, -0.008108, -0.012898, -0.016524, -0.020003, -0.022896, -0.024608, -0.027653, -0.027028, -0.025746, -0.025579, -0.025997, -0.026285, -0.026184, -0.027365, -0.025682, -0.021589, -0.018185, -0.013458, -0.012520, -0.012531, -0.010489
#*# 	  0.040602, 0.028725, 0.016589, 0.004486, -0.003536, -0.009882, -0.014643, -0.017249, -0.018755, -0.020892, -0.024268, -0.023019, -0.020405, -0.018387, -0.017131, -0.016947, -0.018151, -0.020415, -0.019548, -0.014623, -0.013177, -0.008435, -0.007219, -0.007807, -0.006067
#*# 	  0.046701, 0.034793, 0.023082, 0.010964, 0.000392, -0.006951, -0.011166, -0.014277, -0.015385, -0.017380, -0.020216, -0.019775, -0.015736, -0.013123, -0.010380, -0.009864, -0.011815, -0.014230, -0.013943, -0.010843, -0.007941, -0.005263, -0.004407, -0.004636, -0.002141
#*# 	  0.046106, 0.036595, 0.024782, 0.010443, -0.000794, -0.009004, -0.014430, -0.016958, -0.018900, -0.020063, -0.022191, -0.021783, -0.018765, -0.014920, -0.012928, -0.012636, -0.013805, -0.015886, -0.015256, -0.013385, -0.011972, -0.009926, -0.008130, -0.008739, -0.005203
#*# 	  0.046675, 0.037625, 0.025867, 0.010451, -0.001444, -0.009795, -0.015946, -0.019266, -0.020797, -0.021389, -0.023573, -0.023962, -0.020351, -0.017922, -0.016738, -0.016899, -0.017503, -0.018694, -0.018876, -0.018034, -0.017005, -0.014963, -0.014251, -0.012434, -0.008623
#*# 	  0.054604, 0.045227, 0.032527, 0.018735, 0.007786, -0.001423, -0.008218, -0.011725, -0.013003, -0.013395, -0.015462, -0.015446, -0.012751, -0.011091, -0.011446, -0.011980, -0.012470, -0.014103, -0.015870, -0.014820, -0.013384, -0.011855, -0.010088, -0.008349, -0.003187
#*# 	  0.059873, 0.049600, 0.036612, 0.023556, 0.013699, 0.004525, -0.001380, -0.005668, -0.007168, -0.007000, -0.009398, -0.009774, -0.007123, -0.006042, -0.007183, -0.007788, -0.008993, -0.010877, -0.012391, -0.011771, -0.010032, -0.007501, -0.006144, -0.002911, 0.002724
#*# 	  0.063487, 0.052912, 0.039148, 0.026683, 0.018127, 0.010098, 0.004040, 0.000607, -0.000964, -0.000683, -0.003670, -0.003139, -0.000177, -0.000091, -0.001381, -0.002169, -0.002943, -0.005276, -0.006376, -0.006168, -0.003730, -0.000672, 0.001525, 0.004590, 0.009940
#*# 	  0.067872, 0.055977, 0.041451, 0.029462, 0.020142, 0.012780, 0.008074, 0.004738, 0.004193, 0.004042, 0.002681, 0.002055, 0.005290, 0.006433, 0.005061, 0.004627, 0.004052, 0.002436, 0.001495, 0.002236, 0.004795, 0.008346, 0.010621, 0.014139, 0.019729
#*# 	  0.072120, 0.058581, 0.044257, 0.030798, 0.022838, 0.016226, 0.012139, 0.009955, 0.010695, 0.010905, 0.009093, 0.008755, 0.010617, 0.011052, 0.011241, 0.012050, 0.011237, 0.009576, 0.008644, 0.009603, 0.012750, 0.017086, 0.020170, 0.022963, 0.028422
#*# 	  0.071178, 0.057419, 0.042211, 0.030392, 0.021414, 0.017105, 0.014184, 0.013872, 0.015626, 0.015233, 0.011792, 0.010037, 0.011950, 0.012776, 0.013445, 0.014334, 0.014838, 0.013397, 0.013136, 0.014743, 0.017719, 0.022063, 0.025152, 0.028613, 0.034213
#*# 	  0.064759, 0.053712, 0.039260, 0.027749, 0.020659, 0.017263, 0.015753, 0.017236, 0.019368, 0.017870, 0.013879, 0.011367, 0.013159, 0.013489, 0.014193, 0.015486, 0.016308, 0.016289, 0.016917, 0.018355, 0.022142, 0.025479, 0.028712, 0.033061, 0.039301
#*# 	  0.059900, 0.049287, 0.037609, 0.027482, 0.021770, 0.018797, 0.018030, 0.019525, 0.022302, 0.021489, 0.017434, 0.014944, 0.015871, 0.016234, 0.016408, 0.017171, 0.019571, 0.020210, 0.020960, 0.023343, 0.026472, 0.029425, 0.032229, 0.037852, 0.044958
#*# 	  0.053007, 0.042874, 0.032614, 0.024682, 0.020048, 0.017537, 0.016920, 0.018163, 0.020104, 0.019769, 0.015989, 0.015040, 0.016471, 0.016697, 0.017765, 0.018426, 0.019936, 0.021085, 0.021964, 0.023726, 0.026942, 0.029711, 0.032559, 0.038198, 0.046595
#*# 	  0.053214, 0.043397, 0.034870, 0.027781, 0.023903, 0.022599, 0.021155, 0.021619, 0.022169, 0.021733, 0.019541, 0.018904, 0.021656, 0.023067, 0.023581, 0.024952, 0.027136, 0.027303, 0.027750, 0.029340, 0.032128, 0.034944, 0.037155, 0.042883, 0.051792
#*# 	  0.056096, 0.046344, 0.039209, 0.034504, 0.031452, 0.028989, 0.026016, 0.024476, 0.024195, 0.024174, 0.022123, 0.023127, 0.026868, 0.029190, 0.030739, 0.032088, 0.034124, 0.034779, 0.034333, 0.035332, 0.038185, 0.040336, 0.043214, 0.048244, 0.057669
#*# 	  0.059857, 0.050469, 0.044613, 0.040840, 0.038331, 0.035941, 0.032721, 0.029297, 0.026849, 0.026308, 0.025054, 0.028136, 0.032670, 0.035298, 0.037334, 0.039290, 0.040840, 0.040539, 0.040282, 0.041259, 0.043989, 0.046314, 0.048593, 0.053657, 0.062886
#*# 	  0.060041, 0.052128, 0.048497, 0.045179, 0.043092, 0.039732, 0.036056, 0.032474, 0.030417, 0.028949, 0.027650, 0.030966, 0.035890, 0.038452, 0.040299, 0.042097, 0.043668, 0.042730, 0.041670, 0.042815, 0.045826, 0.048091, 0.050261, 0.056510, 0.065187
#*# 	  0.057116, 0.050782, 0.048805, 0.047235, 0.044367, 0.040786, 0.036188, 0.032671, 0.030295, 0.029500, 0.028745, 0.032277, 0.036524, 0.037981, 0.039369, 0.040738, 0.042170, 0.039706, 0.038147, 0.039831, 0.043961, 0.046477, 0.049112, 0.054797, 0.062117
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 210.0
#*# min_y = 30.0
#*# max_y = 208.0
#*#
#*# [beacon model default]
#*# model_coef = 1.4512742510883585,
#*# 	  1.761046808550891,
#*# 	  0.7522864365853444,
#*# 	  0.3549299144690959,
#*# 	  0.31534556763425187,
#*# 	  0.38069145890810696,
#*# 	  -0.06467795303797856,
#*# 	  -0.28719882396266333,
#*# 	  0.145761488672838,
#*# 	  0.19251093552947954
#*# model_domain = 3.1531639165734805e-07,3.326954675116541e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 66.388976
#*# model_offset = 0.06000
#*#
#*# [beacon model pei_hot]
#*# model_coef = 1.9263519575030055,
#*# 	2.1946743347503372,
#*# 	0.6208794249910773,
#*# 	0.2775896555222557,
#*# 	0.06526221562750463,
#*# 	-0.2611119885640586,
#*# 	-0.05461829170887029,
#*# 	0.36810740679885895,
#*# 	0.05685001457152785,
#*# 	-0.15547240310186372
#*# model_domain = 3.351987055417817e-07,3.359664588035842e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 63.925584
#*# model_offset = 0.00000
