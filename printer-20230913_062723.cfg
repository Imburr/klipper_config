##########################
##### BASE CONFIG #######
##########################

[include mainsail.cfg]
[include ./backup/backup.cfg]

##########################
##### HARDWARE STUFF #####
##########################

[include ./hardware/xyz-stepper.cfg]
[include ./hardware/extruder.cfg]
#[include ./klicky/klicky-probe.cfg]
#[include ./hardware/adxl345.cfg]  This config now in canbus.cfg
[include ./hardware/fans.cfg] # Some fans config in canbus.cfg
[include ./hardware/canbus.cfg]

##########################
##### LIGHTS #############
##########################

[include ./hardware/chamber-lighting.cfg]
[include ./hardware/stealthburner-led.cfg]

##########################
##### CALIBRATION ########
##########################

[include ./calibration/z-tilt.cfg]
[include ./calibration/bed-mesh.cfg]
[include ./macros/unsafe.cfg]
[include ./calibration/pressure_advance.cfg]
[include ./calibration/test_speed.cfg]
[include test_probe_accuracy.cfg]

##########################
##### MACROS #############
##########################

[include ./macros/chamber-led.cfg]
[include ./macros/conditional-homing.cfg]
[include ./macros/print-end.cfg]
[include ./macros/print-start-mmu.cfg]
[include ./macros/dump-variables.cfg]
[include ./macros/movement-check.cfg]
[include ./macros/cancel-change.cfg]
[include ./macros/pause-resume.cfg]         ; Overridden by ERCF / subsequantly disabled
[include ./macros/load-unload.cfg]
[include ./macros/filament-change.cfg]
[include ./macros/park.cfg]
#[include ./macros/prusaslicer-accel.cfg]

##########################
##### THIRD PARTY ########
##########################

#[include ./third-party-cfg/nozzle_scrub.cfg]
[include KAMP_Settings.cfg]

##########################
##### ERCF ###############
##########################

[include mmu/base/*.cfg]
#[include ./calibration/ercf_additional.cfg]
#[include ercf_vars.cfg]

##########################
##### LCD/MENU ###########
##########################

#[include ./third-party-cfg/nozzle_scrub_menu.cfg]
#[include ./menu/printer_menu.cfg]

##########################
##### NOT ENABLED YET ####
##########################

#[include ./todo/mini12864.cfg] Add this after adding mini12864 LED
#[include ./todo/lcd_tweaks.cfg] Need to figure this one out and then implement
#[include ./hardware/nevermore.cfg] Disabled as I prefer to chamber vent outside and needed the PWM

##########################
#### REPLACEMENT #########
##########################

[include ./replacement_macros/replace-m900.cfg]
[include ./replacement_macros/replace-m117.cfg]

[exclude_object]

[gcode_arcs]
resolution: 0.1

[respond]
default_type: echo
default_prefix:  

[force_move]
# Enable commands that force potentially unsafe movement
enable_force_move: True

[idle_timeout]
timeout: 14400

[mcu]
##  Obtain definition by "ls -l /dev/serial/by-id/" then unplug to verify
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_290040000750314D35323820-if00
restart_method: command

[mcu rpi]
# Add Rpi as secondary MCU to allow for ADXL use through SPI ribbon/adapter from LDO
serial: /tmp/klipper_host_mcu

[mcu sht]
canbus_uuid: 30993412e8e0

[printer]
kinematics: corexy
max_velocity: 200           # Changed from 200 on 7.11.23
max_accel:  6000            # tuned on 7.11.23 after beacon install.
max_z_velocity: 15          #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 350
square_corner_velocity: 5.0 # Changed on 7.11.23

#####################################################################
#   Input Shaper
#####################################################################

[input_shaper]
#shaper_freq_x: 76.2               ; suggested max_accel <= 22600 mm/sec^2
#shaper_type_x: zv
#shaper_freq_y: 51.8               ; suggested max_accel <= 7900 mm/sec^2
#shaper_type_y: mzv


#####################################################################
#   Bed Heater
#####################################################################

##  SSR Pin - HE1
##  Thermistor - TB
[heater_bed]
heater_pin: PA2 #PA2 is LDO default
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF3
##  Adjust Max Power so your heater doesn't warp your bed. Rule of thumb is 0.4 watts / cm^2 .
max_power: 0.6
min_temp: 0
max_temp: 125
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

#####################################################################
#   Probe
#####################################################################

##  WAS TAP - NOW BEACON in CANBUS
#[probe]
#pin: ^sht:PA2
#x_offset: 0
#y_offset: 25.0
#z_offset: 0
#x_offset: 0
#y_offset: 0
#z_offset: 6.42
#speed: 5.0
#lift_speed: 15
#samples: 3
#samples_result: median
#sample_retract_dist: 2.0
#samples_tolerance: 0.01
#samples_tolerance_retries: 3
# After TAP installation, with PLA, Flow Rate 98%, 0.25mm First Layer, 0.6mm CHT nozzle, Z_Offset is z_offset = -0.450
#activate_gcode:
#    {% set PROBE_TEMP = 150 %}
#    {% set MAX_TEMP = PROBE_TEMP + 5 %}
#    {% set ACTUAL_TEMP = printer.extruder.temperature %}
#    {% set TARGET_TEMP = printer.extruder.target %}
#
#    {% if TARGET_TEMP > PROBE_TEMP %}
#        { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (TARGET_TEMP, PROBE_TEMP)) }
#        M109 S{ PROBE_TEMP }
#    {% else %}
#        # Temperature target is already low enough, but nozzle may still be too hot.
#        {% if ACTUAL_TEMP > MAX_TEMP %}
#            { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (ACTUAL_TEMP, MAX_TEMP)) }
#            TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={ MAX_TEMP }
#        {% endif %}
#    {% endif %}

#####################################################################
#  Filament Runout
#####################################################################

#[filament_motion_sensor RunoutSensor]
#detection_length: 10
#extruder: extruder
#switch_pin: ^PG11
#pause_on_runout: True
#runout_gcode:
#  M117 Filament problem, runout has paused.
#  M118 Filament problem, runout has paused.
#insert_gcode:
#event_delay:
#pause_delay:

#####################################################################
#   Additional Sensors
#####################################################################

[thermistor CMFB103F3950FANT]
temperature1: 0.0
resistance1: 32116.0
temperature2: 40.0
resistance2: 5309.0
temperature3: 80.0
resistance3: 1228.0

#[temperature_sensor sb_ambient_temp]
## Chamber Temperature - T1
#sensor_type: CMFB103F3950FANT
#sensor_pin: PF5
#min_temp: 0
#max_temp: 100
#gcode_id: chamber_th

[temperature_sensor back_chamber_temp]
## Chamber Temperature - T
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PF6
min_temp: 0
max_temp: 100
gcode_id: chamber_th2

[temperature_sensor RPi4]
sensor_type: temperature_host
min_temp: 0
max_temp: 100

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################

#[safe_z_home]
##  XY Location of the Z Endstop Switch
##  Update -10,-10 to the XY coordinates of your endstop pin 
##  (such as 157,305) after going through Z Endstop Pin
##  Location Definition step.
#home_xy_position: 147,256
#speed:100
#z_hop:10
#z_hop_speed:10


########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<5V>

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 39.889
#*# pid_ki = 0.964
#*# pid_kd = 412.851
#*#
#*# [probe]
#*# z_offset = -1.270
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.035695, -0.023734, -0.013969, -0.009900, -0.012601, -0.007047, -0.010977, -0.004342, -0.007096, 0.007391, -0.011984, -0.004018, 0.000991, -0.004095, -0.007789, -0.006771, -0.007430, -0.010095, -0.011740, -0.004836, -0.002580, -0.011837, -0.004760, -0.006764, -0.005791
#*# 	  -0.028625, -0.017559, -0.012955, -0.012840, -0.013226, -0.007901, -0.007046, -0.004232, -0.003363, 0.000227, -0.004425, -0.004614, -0.003175, 0.005467, -0.005135, -0.008900, -0.006546, -0.007842, -0.005636, -0.008284, -0.006447, -0.003087, -0.002112, -0.004705, -0.006486
#*# 	  -0.035558, -0.029643, -0.028726, -0.024010, -0.018508, -0.009425, -0.017004, -0.004823, -0.003075, 0.004131, 0.002366, -0.001212, -0.003864, -0.000920, -0.002523, -0.007892, -0.013858, -0.003453, -0.001951, -0.001920, -0.003360, 0.001565, -0.003777, 0.001258, -0.001855
#*# 	  -0.036355, -0.040898, -0.028337, -0.027237, -0.016988, -0.018218, -0.006311, -0.002914, -0.010568, -0.003029, 0.000221, -0.000772, 0.001512, -0.000614, -0.001109, -0.002905, -0.012342, -0.002635, 0.001019, -0.001522, 0.001799, -0.003168, -0.002796, -0.001511, -0.002148
#*# 	  -0.047031, -0.043900, -0.024277, -0.024299, -0.024847, -0.017311, -0.014293, -0.008656, 0.000793, 0.001505, 0.002591, 0.002299, -0.000311, 0.001448, 0.000307, -0.005461, 0.002993, -0.001374, -0.002675, -0.000333, 0.002154, 0.002449, 0.002033, 0.003263, 0.000199
#*# 	  -0.046126, -0.041858, -0.035929, -0.032025, -0.025972, -0.023115, -0.010727, -0.000851, 0.002117, 0.002522, 0.002267, 0.001615, 0.000260, 0.001605, 0.001295, 0.000138, 0.000513, -0.005479, -0.001562, 0.002838, 0.003311, -0.000372, 0.001974, -0.002833, -0.005686
#*# 	  -0.037779, -0.040044, -0.031346, -0.027414, -0.024593, -0.023998, -0.020166, -0.005051, -0.001785, 0.003013, 0.001970, 0.001340, 0.002437, 0.003653, -0.005074, 0.002940, 0.003532, 0.002504, 0.003981, -0.000797, -0.001073, 0.001230, -0.002045, -0.000352, 0.001664
#*# 	  -0.033248, -0.030762, -0.030163, -0.026057, -0.020063, -0.006637, -0.017359, -0.006156, -0.000479, 0.001249, 0.000184, -0.001643, -0.003245, 0.002498, 0.002802, 0.002895, 0.002106, -0.000112, -0.001663, 0.001747, 0.002461, 0.000904, 0.001969, -0.002691, -0.001605
#*# 	  -0.028970, -0.023780, -0.023146, -0.018731, -0.021055, -0.019869, -0.005534, -0.004484, 0.002074, 0.004766, -0.004925, 0.006951, 0.008336, 0.009464, 0.006852, 0.004810, 0.004124, 0.000916, 0.005191, -0.000554, -0.000126, 0.001187, -0.000339, 0.001084, -0.005045
#*# 	  -0.026178, -0.012767, -0.021793, -0.017736, -0.010707, -0.006518, -0.003435, -0.000290, 0.002651, 0.010406, 0.012965, 0.005559, 0.007460, 0.011946, 0.007693, 0.011118, 0.018552, 0.005206, 0.006703, 0.002742, 0.002006, -0.002215, 0.007971, 0.001363, -0.001395
#*# 	  -0.027232, -0.015066, -0.011665, -0.009924, -0.006310, -0.002093, -0.002909, 0.002703, 0.006640, 0.008177, 0.006316, 0.007085, 0.008859, 0.005675, 0.006450, 0.004529, 0.006113, 0.006226, 0.005869, 0.008903, 0.004877, 0.003165, 0.006037, 0.005306, 0.002788
#*# 	  -0.010744, -0.014930, -0.011627, -0.011838, -0.004517, -0.003530, 0.000902, 0.000864, 0.005624, 0.008892, 0.009318, 0.007364, 0.009020, 0.011544, 0.008023, 0.004263, 0.006141, 0.004911, 0.000547, 0.006254, 0.017809, 0.005912, 0.005026, 0.009800, 0.013139
#*# 	  -0.027392, -0.022617, -0.016277, -0.014485, -0.007871, -0.007167, -0.004987, -0.002337, -0.003416, 0.007888, 0.003392, 0.015303, 0.010817, 0.004439, 0.014011, 0.010694, -0.002651, 0.008059, -0.003113, 0.006917, 0.007717, -0.000654, 0.002806, 0.009752, 0.008519
#*# 	  -0.021814, -0.014991, -0.016063, -0.011139, -0.010448, -0.009906, -0.010137, -0.004898, -0.000682, 0.000250, 0.002588, -0.004059, 0.016890, 0.004395, 0.013047, 0.004317, 0.008100, 0.007654, 0.013303, -0.005729, 0.013486, -0.012371, 0.006100, 0.011696, 0.008712
#*# 	  -0.019586, -0.013340, -0.015564, -0.014513, -0.010800, -0.012946, -0.007991, -0.004904, -0.003032, -0.000626, 0.000123, 0.007272, -0.005494, -0.000493, -0.000675, 0.007319, 0.004316, 0.012668, 0.005040, 0.001702, 0.008177, 0.009392, 0.011995, 0.012510, 0.010713
#*# 	  -0.013772, -0.014777, -0.014135, -0.010520, -0.010528, -0.006880, -0.008886, -0.000142, -0.003326, -0.002803, 0.006989, 0.006418, 0.010749, 0.000540, 0.010687, 0.010857, 0.008708, 0.010414, 0.012918, 0.011780, 0.012762, 0.016123, 0.016091, 0.021335, 0.014156
#*# 	  -0.016963, -0.011012, -0.011326, -0.007038, -0.006593, -0.003396, -0.005619, -0.002996, -0.002003, -0.002750, 0.009335, 0.011576, 0.010706, 0.012932, 0.011786, 0.013068, 0.011042, 0.013720, 0.011771, 0.010761, 0.021775, 0.023001, 0.023110, 0.022313, 0.026153
#*# 	  -0.015869, -0.014783, -0.010884, -0.008509, -0.005655, -0.003440, -0.001525, -0.004811, -0.002143, -0.003006, 0.004517, 0.007770, 0.013088, 0.011203, 0.015234, 0.014167, 0.012531, 0.011272, 0.014644, 0.014967, 0.021796, 0.026133, 0.023446, 0.025117, 0.023202
#*# 	  -0.025770, -0.014565, -0.013248, -0.009557, -0.007273, -0.007245, -0.007299, -0.005725, -0.005280, 0.000284, 0.004755, 0.010030, 0.003793, -0.006929, 0.015533, 0.012085, 0.013057, 0.010888, 0.014205, 0.014518, 0.016822, 0.023233, 0.023473, 0.024219, 0.023511
#*# 	  -0.024147, -0.009130, -0.015296, -0.011456, -0.013129, -0.011130, -0.002540, -0.006902, -0.002452, -0.003586, -0.003509, 0.003249, 0.013518, -0.003561, 0.011674, 0.013826, 0.012743, 0.012439, 0.015993, 0.014185, 0.017300, 0.018865, 0.020504, 0.020931, 0.019205
#*# 	  -0.023467, -0.015025, -0.010614, -0.010445, -0.011135, -0.009215, -0.008575, -0.004160, -0.005140, -0.001537, -0.001933, 0.001626, 0.007979, 0.003581, 0.008255, 0.012843, 0.014745, 0.016367, 0.012956, 0.016144, 0.017149, 0.018686, 0.016466, 0.020631, 0.019565
#*# 	  -0.029138, -0.011898, -0.010167, -0.008561, -0.009100, -0.009642, -0.004935, -0.006625, 0.003743, -0.000706, 0.001427, 0.004820, -0.003515, 0.006371, 0.007018, 0.006396, 0.014675, 0.004023, 0.011106, 0.015557, 0.012939, 0.016490, 0.018114, 0.019875, 0.020171
#*# 	  -0.021710, -0.020684, -0.014644, -0.010422, -0.007513, -0.006005, -0.007515, -0.004598, -0.004815, -0.003585, -0.001736, -0.001383, 0.003874, -0.000630, 0.009518, 0.010068, 0.002013, 0.012901, -0.006082, 0.014417, 0.012895, 0.013809, 0.014896, 0.019381, 0.018893
#*# 	  -0.025858, -0.020530, -0.010097, -0.021057, -0.010330, -0.013385, -0.009864, -0.014161, -0.004709, -0.009787, -0.009372, -0.004781, -0.007320, -0.006072, -0.001457, -0.005471, -0.005614, -0.005469, 0.000457, 0.003908, 0.005191, 0.005959, 0.016304, 0.015477, 0.013435
#*# x_count = 25
#*# y_count = 24
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 210.0
#*# min_y = 38.309
#*# max_y = 210.0
#*#
#*# [beacon model default]
#*# model_coef = 1.9257982386737142,
#*# 	  2.1904011986275074,
#*# 	  0.5881661108028357,
#*# 	  0.30341866940870527,
#*# 	  0.14823890288711727,
#*# 	  -0.42807822476666274,
#*# 	  -0.13716254071061182,
#*# 	  0.612855529187592,
#*# 	  0.08376843001203003,
#*# 	  -0.2664564217100284
#*# model_domain = 3.352922478536077e-07,3.360945745364866e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 72.578002
#*# model_offset = -0.28500
#*#
#*# [input_shaper]
#*# shaper_type_x = zv
#*# shaper_freq_x = 77.4
#*# shaper_type_y = mzv
#*# shaper_freq_y = 51.6
