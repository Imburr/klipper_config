[include moonraker_obico_macros.cfg]
##########################
##### BASE CONFIG #######
##########################

[include mainsail.cfg]
[include ./backup/backup.cfg]

##########################
##### HARDWARE STUFF #####
##########################

[include ./hardware/xyz-stepper.cfg]
[include ./hardware/extruder.cfg]
#[include ./klicky/klicky-probe.cfg]
#[include ./hardware/adxl345.cfg]  This config now in canbus.cfg
[include ./hardware/fans.cfg] # Some fans config in canbus.cfg
[include ./hardware/canbus.cfg]

##########################
##### LIGHTS #############
##########################

[include ./hardware/chamber-lighting.cfg]
[include ./hardware/stealthburner-led.cfg]

##########################
##### CALIBRATION ########
##########################

[include ./calibration/z-tilt.cfg]
[include ./calibration/bed-mesh.cfg]
[include ./macros/unsafe.cfg]
[include ./calibration/pressure_advance.cfg]
[include ./calibration/test_speed.cfg]
[include ./calibration/pika.cfg]
[include ./calibration/microadjust.cfg]
[include ./calibration/sensorless.cfg]
[include test_probe_accuracy.cfg]
[include K-ShakeTune/*.cfg]

##########################
##### MACROS #############
##########################

[include ./macros/chamber-led.cfg]
[include ./macros/conditional-homing.cfg]
[include ./macros/print-end.cfg]
[include ./macros/print-start-mmu.cfg]
[include ./macros/dump-variables.cfg]
[include ./macros/movement-check.cfg]
[include ./macros/cancel-change.cfg]
[include ./macros/pause-resume.cfg]         ; Overridden by ERCF / subsequantly disabled
[include ./macros/load-unload.cfg]
[include ./macros/filament-change.cfg]
[include ./macros/park.cfg]
[include ./macros/heatsoak.cfg]

##########################
##### THIRD PARTY ########
##########################

#[include ./third-party-cfg/nozzle_scrub.cfg]
[include KAMP_Settings.cfg]

##########################
##### ERCF ###############
##########################

[include mmu/base/mmu.cfg]
[include mmu/base/mmu_hardware.cfg]
[include mmu/base/mmu_software.cfg]
[include mmu/base/mmu_parameters.cfg]
[include mmu/base/mmu_sequence.cfg]
[include mmu/base/mmu_form_tip.cfg]
[include mmu/optional/mmu_ercf_cutter.cfg]

##########################
##### LCD/MENU ###########
##########################

#[include ./third-party-cfg/nozzle_scrub_menu.cfg]
#[include ./menu/printer_menu.cfg]

##########################
##### NOT ENABLED YET ####
##########################

#[include ./todo/mini12864.cfg] Add this after adding mini12864 LED
#[include ./todo/lcd_tweaks.cfg] Need to figure this one out and then implement
#[include ./hardware/nevermore.cfg] Disabled as I prefer to chamber vent outside and needed the PWM

##########################
#### REPLACEMENT #########
##########################

[include ./replacement_macros/replace-m900.cfg]
[include ./replacement_macros/replace-m117.cfg]

[exclude_object]

[gcode_arcs]
resolution: 0.1

[respond]
default_type: echo
default_prefix:  

[force_move]
# Enable commands that force potentially unsafe movement
enable_force_move: True

[idle_timeout]
timeout: 14400

[mcu]
##  Obtain definition by "ls -l /dev/serial/by-id/" then unplug to verify
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_290040000750314D35323820-if00
restart_method: command

[mcu rpi]
# Add Rpi as secondary MCU to allow for ADXL use through SPI ribbon/adapter from LDO
serial: /tmp/klipper_host_mcu

[mcu sht]
canbus_uuid: f4416bafceb2 # FLY-SHT36 v2 Ordered from Etsy on 2/12/24

#[mcu mmb]  See MMU.CFG in ERCF Confog
#canbus_uuid: a7f4653c0a73

[printer]
kinematics: corexy           # TESTING HIGHER SPEEDS ON 2/7/24 DUE TO SLICER SLOWWWWWWWW / ALSO SET IN PRINT START
max_velocity: 450            # Changed from 200 on 7.11.23
max_accel: 10000             # tuned on 7.11.23 after beacon install.
max_accel_to_decel:5000
max_z_velocity: 15           #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 350
square_corner_velocity: 5.0 # Changed on 7.11.23

#####################################################################
#   Input Shaper
#####################################################################

[input_shaper]
shaper_freq_x: 71.0
shaper_type_x: mzv # 14900
shaper_freq_y: 47.8
shaper_type_y: mzv # 6700
damping_ratio_x: 0.043
damping_ratio_y: 0.055
# Not Noisy: 20-22.5 / 60.6-96.7 / 30.2-48 / 111.4-200 mm/s

#####################################################################
#   AutoTune / https://github.com/andrewmcgr/klipper_tmc_autotune
#####################################################################

#[motor_constants ldo-42sth48-2004mah_vrn]
#resistance: 1.45
#inductance: 0.002
#holding_torque: 0.40
#max_current: 2.0
#steps_per_revolution: 400

#[autotune_tmc stepper_x]
#motor: ldo-42sth48-2004mah_vrn
#sg4_thrs: 105
#tuning_goal: silent
#[autotune_tmc stepper_y]
#motor: ldo-42sth48-2004mah_vrn
#tuning_goal: silent

#[autotune_tmc stepper_z]
#motor: ldo-42sth40-1684l300e
#[autotune_tmc stepper_z1]
#motor: ldo-42sth40-1684l300e
#[autotune_tmc stepper_z2]
#motor: ldo-42sth40-1684l300e

#[autotune_tmc extruder]
#motor: moons-cse14hra1l410a

#####################################################################
#   Bed Heater
#####################################################################

##  SSR Pin - HE1
##  Thermistor - TB
[heater_bed]
heater_pin: PA2 #PA2 is LDO default
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF3
##  Adjust Max Power so your heater doesn't warp your bed. Rule of thumb is 0.4 watts / cm^2 .
max_power: 1
min_temp: 0
max_temp: 125
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

#####################################################################
#   TEMPORARY
#####################################################################

##  WAS TAP - NOW BEACON in CANBUS

#[beacon]
#serial: /dev/serial/by-path/platform-fd500000.pcie-pci-0000:01:00.0-usb-0:1.3.4:1.0
#serial: /dev/serial/by-path/platform-fd500000.pcie-pci-0000:01:00.0-usb-0:1.3.4:1.0
#   Path to the serial port for the beacon device. Typically has the form
#   /dev/serial/by-id/usb-Beacon_Beacon_...
#speed: 5
#   Z probing dive speed.
#lift_speed: 10
#   Z probing lift speed.
#backlash_comp: 0.5
#   Backlash compensation distance for removing Z backlash before measuring
#   the sensor response.
#x_offset: 0.
#   X offset of beacon from the nozzle.
#y_offset: 21.953
#   Y offset of beacon from the nozzle.
#z_settling_time: 1000
#   Time to wait after dropping Z to read to avoid ringing.
#trigger_distance: 2.
#   Beacon trigger distance for homing.
#trigger_dive_threshold: 1.
#   Threshold for range vs dive mode probing. Beyond `trigger_distance +
#   trigger_dive_threshold` a dive will be used.
#trigger_hysteresis: 0.006
#   Hysteresis on trigger threshold for untriggering, as a percentage of the
#   trigger threshold.
#cal_nozzle_z: 0.1
#   Expected nozzle offset after completing manual Z offset calibration.
#cal_floor: 0.2
#   Minimum z bound on sensor response measurement.
#cal_ceil: 5.
#   Maximum z bound on sensor response measurement.
#cal_speed: 1.
#   Speed while measuring response curve.
#cal_move_speed: 10.
#   Speed while moving to position for response curve measurement.
#default_model_name: default
#   Name of default beacon model to load.
#mesh_main_direction: x
#   Primary travel direction during mesh measurement.
#mesh_overscan: -1
#   Distance to use for direction changes at mesh line ends. Omit this setting
#   and a default will be calculated from line spacing and available travel.
#mesh_cluster_size: 1
#   Radius of mesh grid point clusters.
#mesh_runs: 2
#   Number of passes to make during mesh scan.

#####################################################################
#   TEMPORARY
#####################################################################

#   Connected to MOTOR_6
#   Heater - HE0
#   Thermistor - T0
#[extruder]
#step_pin: PE2
#dir_pin: PE3
#enable_pin: !PD4
##  Update value below when you perform extruder calibration
##  If you ask for 100mm of filament, but in reality it is 98mm:
##  rotation_distance = <previous_rotation_distance> * <actual_extrude_distance> / 100
##  22.6789511 is a good starting point
#rotation_distance: 22.6789511   #Bondtech 5mm Drive Gears
##  Update Gear Ratio depending on your Extruder Type
##  Use 50:10 for Stealthburner/Clockwork 2
##  Use 50:17 for Afterburner/Clockwork (BMG Gear Ratio)
##  Use 80:20 for M4, M3.1
#gear_ratio: 50:10
#microsteps: 32
#full_steps_per_rotation: 200    #200 for 1.8 degree, 400 for 0.9 degree
#nozzle_diameter: 0.400
#filament_diameter: 1.75
## Octopus 1.0 & 1.1.  Octopus PRO 1.0
#heater_pin: PA2
## Octopus PRO 1.1
#heater_pin: PA0
## Check what thermistor type you have. See https://www.klipper3d.org/Config_Reference.html#common-thermistors for common thermistor types.
## Use "Generic 3950" for NTC 100k 3950 thermistors
#sensor_type: ATC Semitec 104NT-4-R025H42G
#sensor_pin: PF4
#heater_pin: PA1 #PA1 is LDO default
#min_temp: -273.15
#max_temp: 99999999
#max_power: 1.0
#min_temp: -273.15
#control = pid
#pid_kp = 26.213
#pid_ki = 1.304
#pid_kd = 131.721
##  Try to keep pressure_advance below 1.0
#pressure_advance: 0.05
##  Default is 0.040, leave stock
#pressure_advance_smooth_time: 0.040

##  E0 on MOTOR6
##  Make sure to update below for your relevant driver (2208 or 2209)
#[tmc2209 extruder]
#uart_pin: PE1
#interpolate: false
#run_current: 0.5
#sense_resistor: 0.110
#stealthchop_threshold: 0


#####################################################################
#   Additional Sensors
#####################################################################

[thermistor CMFB103F3950FANT]
temperature1: 0.0
resistance1: 32116.0
temperature2: 40.0
resistance2: 5309.0
temperature3: 80.0
resistance3: 1228.0

#[temperature_sensor sb_ambient_temp]
## Chamber Temperature - T1
#sensor_type: CMFB103F3950FANT
#sensor_pin: PF5
#min_temp: 0
#max_temp: 100
#gcode_id: chamber_th

[temperature_sensor back_chamber_temp]
## Chamber Temperature - T
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PF6
min_temp: 0
max_temp: 100
gcode_id: chamber_th2

[temperature_sensor RPi4]
sensor_type: temperature_host
min_temp: 0
max_temp: 100

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<5V>

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 39.889
#*# pid_ki = 0.964
#*# pid_kd = 412.851
#*#
#*# [beacon model default]
#*# model_coef = 1.4512742510883585,
#*# 	1.761046808550891,
#*# 	0.7522864365853444,
#*# 	0.3549299144690959,
#*# 	0.31534556763425187,
#*# 	0.38069145890810696,
#*# 	-0.06467795303797856,
#*# 	-0.28719882396266333,
#*# 	0.145761488672838,
#*# 	0.19251093552947954
#*# model_domain = 3.1531639165734805e-07,3.326954675116541e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 66.388976
#*# model_offset = 0.03000
#*#
#*# [beacon model pei_hot]
#*# model_coef = 1.9263519575030055,
#*# 	2.1946743347503372,
#*# 	0.6208794249910773,
#*# 	0.2775896555222557,
#*# 	0.06526221562750463,
#*# 	-0.2611119885640586,
#*# 	-0.05461829170887029,
#*# 	0.36810740679885895,
#*# 	0.05685001457152785,
#*# 	-0.15547240310186372
#*# model_domain = 3.351987055417817e-07,3.359664588035842e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 63.925584
#*# model_offset = 0.00000
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.015770, -0.000098, -0.014724, -0.023024, -0.029584, -0.029732, -0.039740, -0.042937, -0.038455, -0.053915, -0.052225, -0.055403, -0.048930, -0.056771, -0.058477, -0.058330, -0.057109, -0.058684, -0.059956, -0.060723, -0.065636, -0.055673, -0.049036, -0.040355, -0.027733
#*# 	  0.002548, -0.004699, -0.020700, -0.030456, -0.037529, -0.044858, -0.050912, -0.059361, -0.055280, -0.057485, -0.062313, -0.065873, -0.067336, -0.068140, -0.070026, -0.064264, -0.067133, -0.067360, -0.074123, -0.067423, -0.066306, -0.061794, -0.057178, -0.050871, -0.040840
#*# 	  -0.001419, -0.010909, -0.023405, -0.031118, -0.041683, -0.048540, -0.052740, -0.058219, -0.059133, -0.061117, -0.066145, -0.072305, -0.072927, -0.074821, -0.080630, -0.077272, -0.074491, -0.070291, -0.076991, -0.070895, -0.064325, -0.067448, -0.059566, -0.054216, -0.047566
#*# 	  -0.001054, -0.018296, -0.023410, -0.032744, -0.042281, -0.047655, -0.049321, -0.059353, -0.059848, -0.063199, -0.065038, -0.075175, -0.078222, -0.085195, -0.082457, -0.082719, -0.080524, -0.079070, -0.077509, -0.073267, -0.073375, -0.063635, -0.059667, -0.054798, -0.043616
#*# 	  0.003657, -0.012159, -0.017730, -0.027360, -0.032934, -0.041254, -0.046657, -0.050987, -0.056611, -0.058733, -0.066825, -0.071435, -0.079023, -0.081957, -0.083979, -0.084389, -0.081961, -0.079642, -0.076805, -0.074648, -0.064835, -0.058591, -0.053764, -0.049248, -0.040418
#*# 	  0.011459, -0.000342, -0.009767, -0.014549, -0.024457, -0.025070, -0.033670, -0.037930, -0.045100, -0.049464, -0.060931, -0.068594, -0.074642, -0.078266, -0.081319, -0.081301, -0.075274, -0.076670, -0.072767, -0.070243, -0.060141, -0.054946, -0.046000, -0.039576, -0.030686
#*# 	  0.015239, 0.003739, -0.005713, -0.013449, -0.018042, -0.018945, -0.023374, -0.027419, -0.033604, -0.043520, -0.056285, -0.066307, -0.073061, -0.078808, -0.079990, -0.079664, -0.075974, -0.075581, -0.072248, -0.066755, -0.060083, -0.051042, -0.043169, -0.032255, -0.024987
#*# 	  0.021984, 0.012291, 0.002950, -0.003714, -0.003259, -0.008960, -0.010127, -0.007703, -0.018456, -0.030153, -0.044976, -0.053267, -0.062868, -0.066437, -0.072869, -0.069304, -0.068154, -0.067149, -0.067438, -0.059754, -0.052381, -0.045283, -0.036893, -0.024745, -0.016081
#*# 	  0.025496, 0.016241, 0.006772, 0.001743, -0.003452, -0.002778, -0.001224, -0.002500, -0.006543, -0.017799, -0.032872, -0.045546, -0.051970, -0.054891, -0.058034, -0.058401, -0.057344, -0.058392, -0.057632, -0.053093, -0.048605, -0.043922, -0.035424, -0.029132, -0.011755
#*# 	  0.024053, 0.014898, 0.007023, -0.000593, -0.002789, -0.001482, 0.003990, 0.005194, 0.003376, -0.007817, -0.020959, -0.033292, -0.039341, -0.043747, -0.045833, -0.046639, -0.047782, -0.047949, -0.050578, -0.049218, -0.046857, -0.043278, -0.038614, -0.034046, -0.021193
#*# 	  0.018906, 0.011036, 0.002963, -0.003857, -0.004211, -0.002932, 0.002801, 0.008475, 0.009204, 0.001329, -0.011289, -0.022965, -0.029672, -0.034177, -0.038259, -0.039896, -0.044540, -0.047626, -0.050328, -0.048935, -0.052217, -0.047404, -0.049535, -0.044237, -0.035337
#*# 	  0.024538, 0.016435, 0.008674, 0.001611, -0.000783, 0.006794, 0.014945, 0.021636, 0.025690, 0.017798, 0.004746, -0.007370, -0.013085, -0.021163, -0.027349, -0.032098, -0.036456, -0.041939, -0.046560, -0.049598, -0.051234, -0.053260, -0.051500, -0.047926, -0.040330
#*# 	  0.031101, 0.022543, 0.014363, 0.009450, 0.009412, 0.015461, 0.024266, 0.034799, 0.035421, 0.030639, 0.015325, 0.003216, -0.005423, -0.014140, -0.022580, -0.028851, -0.032915, -0.041681, -0.044920, -0.048432, -0.050320, -0.050697, -0.050939, -0.045204, -0.044614
#*# 	  0.038009, 0.027226, 0.021962, 0.011678, 0.017493, 0.023190, 0.033014, 0.043452, 0.044209, 0.037006, 0.019934, 0.007803, -0.001693, -0.011362, -0.020412, -0.025740, -0.030768, -0.037346, -0.040092, -0.044700, -0.047798, -0.042925, -0.045380, -0.042795, -0.038349
#*# 	  0.040132, 0.029393, 0.020349, 0.015488, 0.014777, 0.024825, 0.035217, 0.044252, 0.046095, 0.038109, 0.021981, 0.006990, -0.003018, -0.012317, -0.019395, -0.026853, -0.029100, -0.035021, -0.037617, -0.039986, -0.039388, -0.038685, -0.038052, -0.036479, -0.029146
#*# 	  0.047196, 0.035132, 0.025181, 0.017532, 0.017764, 0.025176, 0.036358, 0.044933, 0.047579, 0.039325, 0.022553, 0.007754, -0.002867, -0.009601, -0.017536, -0.020622, -0.025048, -0.027812, -0.030660, -0.031604, -0.027805, -0.027682, -0.026886, -0.025876, -0.017996
#*# 	  0.049885, 0.037184, 0.024979, 0.013516, 0.014788, 0.021341, 0.034338, 0.043553, 0.045545, 0.034553, 0.019102, 0.005082, -0.004537, -0.012710, -0.016050, -0.018004, -0.020779, -0.022912, -0.025293, -0.023440, -0.024886, -0.018885, -0.017399, -0.013742, -0.008939
#*# 	  0.045357, 0.034399, 0.020993, 0.011207, 0.010575, 0.018516, 0.030658, 0.040500, 0.042896, 0.030416, 0.014359, -0.000356, -0.008033, -0.014107, -0.016967, -0.017078, -0.017827, -0.019846, -0.021531, -0.019834, -0.019267, -0.016386, -0.012784, -0.008839, -0.003214
#*# 	  0.040801, 0.030828, 0.018962, 0.010760, 0.010655, 0.018547, 0.030974, 0.042039, 0.042155, 0.030979, 0.013383, -0.000906, -0.008580, -0.013349, -0.015544, -0.015389, -0.014406, -0.014568, -0.016624, -0.016552, -0.014131, -0.013150, -0.008964, -0.003517, 0.001943
#*# 	  0.033771, 0.020642, 0.013549, 0.006697, 0.010055, 0.017867, 0.030414, 0.040781, 0.041040, 0.028926, 0.012029, -0.002496, -0.010627, -0.017319, -0.016260, -0.016728, -0.015700, -0.017815, -0.016445, -0.016209, -0.018023, -0.014180, -0.010728, -0.005803, 0.003309
#*# 	  0.030045, 0.020006, 0.012044, 0.009087, 0.012534, 0.022204, 0.033990, 0.043229, 0.041515, 0.029817, 0.012729, -0.000913, -0.009412, -0.012512, -0.013870, -0.014282, -0.011967, -0.012705, -0.013612, -0.013829, -0.012960, -0.011636, -0.009479, -0.003686, 0.004840
#*# 	  0.033528, 0.023407, 0.017142, 0.016478, 0.018642, 0.026657, 0.037758, 0.045692, 0.042986, 0.033486, 0.016998, 0.004204, -0.001599, -0.004582, -0.004737, -0.004670, -0.002726, -0.004047, -0.005434, -0.006110, -0.005280, -0.004412, -0.001713, 0.002731, 0.011429
#*# 	  0.037685, 0.027455, 0.021899, 0.019732, 0.023075, 0.030958, 0.039369, 0.045076, 0.043841, 0.033517, 0.019064, 0.009312, 0.003804, 0.002600, 0.002243, 0.003553, 0.005285, 0.003424, 0.001772, 0.001094, 0.001369, 0.002742, 0.004698, 0.009966, 0.018897
#*# 	  0.038721, 0.029447, 0.024900, 0.023190, 0.025907, 0.031017, 0.038118, 0.043036, 0.041909, 0.032959, 0.019215, 0.010364, 0.007961, 0.006350, 0.007305, 0.009176, 0.010155, 0.008005, 0.004941, 0.004482, 0.005759, 0.006958, 0.009014, 0.013900, 0.022545
#*# 	  0.036681, 0.028616, 0.025404, 0.025058, 0.026643, 0.030803, 0.036331, 0.040477, 0.039848, 0.030566, 0.018054, 0.011027, 0.008627, 0.007460, 0.008455, 0.009907, 0.010766, 0.006742, 0.003662, 0.003603, 0.005719, 0.007629, 0.009199, 0.014705, 0.023478
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 210.0
#*# min_y = 30.0
#*# max_y = 208.0
