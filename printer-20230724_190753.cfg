##########################
##### BASE CONFIG #######
##########################

[include mainsail.cfg]
[include ./backup/backup.cfg]

##########################
##### HARDWARE STUFF #####
##########################

[include ./hardware/xyz-stepper.cfg]
[include ./hardware/extruder.cfg]
#[include ./klicky/klicky-probe.cfg]
#[include ./hardware/adxl345.cfg]  This config now in canbus.cfg
[include ./hardware/fans.cfg] # Some fans config in canbus.cfg
[include ./hardware/canbus.cfg]

##########################
##### LIGHTS #############
##########################

[include ./hardware/chamber-lighting.cfg]
[include ./hardware/stealthburner-led.cfg]

##########################
##### CALIBRATION ########
##########################

[include ./calibration/z-tilt.cfg]
[include ./calibration/bed-mesh.cfg]
[include ./macros/unsafe.cfg]
[include ./calibration/pressure_advance.cfg]
[include test_probe_accuracy.cfg]

##########################
##### MACROS #############
##########################

[include ./macros/chamber-led.cfg]
[include ./macros/conditional-homing.cfg]
[include ./macros/print-end.cfg]
[include ./macros/print-start-mmu.cfg]
[include ./macros/dump-variables.cfg]
[include ./macros/movement-check.cfg]
[include ./macros/cancel-change.cfg]
[include ./macros/pause-resume.cfg]         ; Overridden by ERCF / subsequantly disabled
[include ./macros/load-unload.cfg]
[include ./macros/filament-change.cfg]
[include ./macros/park.cfg]
#[include ./macros/prusaslicer-accel.cfg]

##########################
##### THIRD PARTY ########
##########################

[include ./third-party-cfg/nozzle_scrub.cfg]
#[include ./kamp/Adaptive_Mesh.cfg]
#[include ./kamp/Adaptive_Purge.cfg]
[include ./KAMP/KAMP_Settings.cfg]
[include ./KAMP/Adaptive_Meshing.cfg]
[include ./KAMP/Line_Purge.cfg]
[include ./KAMP/Voron_Purge.cfg]
[include ./KAMP/Smart_Park.cfg]

##########################
##### ERCF ###############
##########################


[include ercf_hardware.cfg]
[include ercf_parameters.cfg]
[include ercf_software.cfg]
[include ./calibration/ercf_additional.cfg]
#[include ercf_vars.cfg]
[include client_macros.cfg]

##########################
##### LCD/MENU ###########
##########################

#[include ./third-party-cfg/nozzle_scrub_menu.cfg]
#[include ercf_menu.cfg]
#[include ./menu/printer_menu.cfg]

##########################
##### NOT ENABLED YET ####
##########################

#[include ./todo/mini12864.cfg] Add this after adding mini12864 LED
#[include ./todo/lcd_tweaks.cfg] Need to figure this one out and then implement
#[include ./hardware/nevermore.cfg] Disabled as I prefer to chamber vent outside and needed the PWM

##########################
#### REPLACEMENT #########
##########################

[include ./replacement_macros/replace-m900.cfg]
[include ./replacement_macros/replace-m117.cfg]

[exclude_object]

[gcode_arcs]
resolution: 0.1

[respond]
default_type: echo
default_prefix:  

[force_move]
# Enable commands that force potentially unsafe movement
enable_force_move: True

[idle_timeout]
timeout: 14400

[mcu]
##  Obtain definition by "ls -l /dev/serial/by-id/" then unplug to verify
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_290040000750314D35323820-if00
restart_method: command

[mcu rpi]
# Add Rpi as secondary MCU to allow for ADXL use through SPI ribbon/adapter from LDO
serial: /tmp/klipper_host_mcu

[mcu sht]
canbus_uuid: 30993412e8e0

[printer]
kinematics: corexy
max_velocity: 600           # Changed from 200 on 7.11.23
max_accel:  6000            # tuned on 7.11.23 after beacon install.
max_z_velocity: 15          #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 350
square_corner_velocity: 8.0 # Changed on 7.11.23

#####################################################################
#   Input Shaper
#####################################################################

[input_shaper]
shaper_freq_x: 76.2               ; suggested max_accel <= 22600 mm/sec^2
shaper_type_x: zv
shaper_freq_y: 51.8               ; suggested max_accel <= 7900 mm/sec^2
shaper_type_y: mzv


#####################################################################
#   Bed Heater
#####################################################################

##  SSR Pin - HE1
##  Thermistor - TB
[heater_bed]
heater_pin: PA2 #PA2 is LDO default
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF3
##  Adjust Max Power so your heater doesn't warp your bed. Rule of thumb is 0.4 watts / cm^2 .
max_power: 0.6
min_temp: 0
max_temp: 125
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

#####################################################################
#   Probe
#####################################################################

##  WAS TAP - NOW BEACON in CANBUS
#[probe]
#pin: ^sht:PA2
#x_offset: 0
#y_offset: 25.0
#z_offset: 0
#x_offset: 0
#y_offset: 0
#z_offset: 6.42
#speed: 5.0
#lift_speed: 15
#samples: 3
#samples_result: median
#sample_retract_dist: 2.0
#samples_tolerance: 0.01
#samples_tolerance_retries: 3
# After TAP installation, with PLA, Flow Rate 98%, 0.25mm First Layer, 0.6mm CHT nozzle, Z_Offset is z_offset = -0.450
#activate_gcode:
#    {% set PROBE_TEMP = 150 %}
#    {% set MAX_TEMP = PROBE_TEMP + 5 %}
#    {% set ACTUAL_TEMP = printer.extruder.temperature %}
#    {% set TARGET_TEMP = printer.extruder.target %}
#
#    {% if TARGET_TEMP > PROBE_TEMP %}
#        { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (TARGET_TEMP, PROBE_TEMP)) }
#        M109 S{ PROBE_TEMP }
#    {% else %}
#        # Temperature target is already low enough, but nozzle may still be too hot.
#        {% if ACTUAL_TEMP > MAX_TEMP %}
#            { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (ACTUAL_TEMP, MAX_TEMP)) }
#            TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={ MAX_TEMP }
#        {% endif %}
#    {% endif %}

#####################################################################
#  Filament Runout
#####################################################################

#[filament_motion_sensor RunoutSensor]
#detection_length: 10
#extruder: extruder
#switch_pin: ^PG11
#pause_on_runout: True
#runout_gcode:
#  M117 Filament problem, runout has paused.
#  M118 Filament problem, runout has paused.
#insert_gcode:
#event_delay:
#pause_delay:

#####################################################################
#   Additional Sensors
#####################################################################

[thermistor CMFB103F3950FANT]
temperature1: 0.0
resistance1: 32116.0
temperature2: 40.0
resistance2: 5309.0
temperature3: 80.0
resistance3: 1228.0

#[temperature_sensor sb_ambient_temp]
## Chamber Temperature - T1
#sensor_type: CMFB103F3950FANT
#sensor_pin: PF5
#min_temp: 0
#max_temp: 100
#gcode_id: chamber_th

[temperature_sensor back_chamber_temp]
## Chamber Temperature - T
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PF6
min_temp: 0
max_temp: 100
gcode_id: chamber_th2

[temperature_sensor RPi4]
sensor_type: temperature_host
min_temp: 0
max_temp: 100

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################

#[safe_z_home]
##  XY Location of the Z Endstop Switch
##  Update -10,-10 to the XY coordinates of your endstop pin 
##  (such as 157,305) after going through Z Endstop Pin
##  Location Definition step.
#home_xy_position: 147,256
#speed:100
#z_hop:10
#z_hop_speed:10


########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<5V>

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 39.889
#*# pid_ki = 0.964
#*# pid_kd = 412.851
#*#
#*# [probe]
#*# z_offset = -1.270
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.070295, -0.060225, -0.055661, -0.047072, -0.046381, -0.044668, -0.044610, -0.037130, -0.035154, -0.036118, -0.034956, -0.039463, -0.036396, -0.043691, -0.030568, -0.042739, -0.043576, -0.050074, -0.048419, -0.050002, -0.037126, -0.043855, -0.035423, -0.036689, -0.043024
#*# 	  -0.059807, -0.051726, -0.040595, -0.037786, -0.038906, -0.038383, -0.033645, -0.033842, -0.031017, -0.029324, -0.031878, -0.025461, -0.030493, -0.030282, -0.031684, -0.027987, -0.032324, -0.031543, -0.033517, -0.031462, -0.030010, -0.030852, -0.025857, -0.031823, -0.031074
#*# 	  -0.047246, -0.046781, -0.037303, -0.041633, -0.036027, -0.034938, -0.033928, -0.024368, -0.019372, -0.033923, -0.021089, -0.021056, -0.017123, -0.020276, -0.027173, -0.024604, -0.030816, -0.026631, -0.025267, -0.022023, -0.019026, -0.028133, -0.028164, -0.021930, -0.026597
#*# 	  -0.057180, -0.050555, -0.058226, -0.039154, -0.036377, -0.040363, -0.027599, -0.014179, -0.012501, -0.022908, -0.016612, -0.025584, -0.013761, -0.012742, -0.018217, -0.019132, -0.015170, -0.028362, -0.029785, -0.015042, -0.015802, -0.017913, -0.017485, -0.028961, -0.017039
#*# 	  -0.061459, -0.055891, -0.049387, -0.048513, -0.045100, -0.036576, -0.027106, -0.026625, -0.014723, -0.020111, -0.014966, -0.018295, -0.016006, -0.016294, -0.015550, -0.021274, -0.018296, -0.015999, -0.013850, -0.017764, -0.014598, -0.011698, -0.026115, -0.014672, -0.013472
#*# 	  -0.059970, -0.051948, -0.056690, -0.051898, -0.039913, -0.035974, -0.025158, -0.012961, -0.018845, -0.013536, -0.012507, -0.010689, -0.012575, -0.012247, -0.012491, -0.012875, -0.011974, -0.012273, -0.010768, -0.014683, -0.012251, -0.011731, -0.013382, -0.014290, -0.018709
#*# 	  -0.061343, -0.053425, -0.054538, -0.049766, -0.039913, -0.036015, -0.023976, -0.024548, -0.014277, -0.012476, -0.008920, -0.011370, -0.008911, -0.010927, -0.011159, -0.010154, -0.010192, -0.011687, -0.013446, -0.011161, -0.012147, -0.012032, -0.011887, -0.011627, -0.012511
#*# 	  -0.058762, -0.054425, -0.051614, -0.041546, -0.037290, -0.034362, -0.027621, -0.019323, -0.013259, -0.008369, -0.009590, -0.010744, -0.009130, -0.010950, -0.009054, -0.012132, -0.010937, -0.008944, -0.013234, -0.010768, -0.009344, -0.013726, -0.006759, -0.010915, -0.011015
#*# 	  -0.053699, -0.039288, -0.039224, -0.046365, -0.040189, -0.034069, -0.016415, -0.012885, -0.009656, -0.012283, -0.010164, -0.009495, -0.009704, -0.008263, -0.009054, -0.007908, -0.009555, -0.008723, -0.008863, -0.009978, -0.006551, -0.009544, -0.010552, -0.009808, -0.014292
#*# 	  -0.039044, -0.032308, -0.035567, -0.035740, -0.024306, -0.018517, -0.018547, -0.015285, -0.012360, -0.012363, -0.008533, -0.011400, -0.008009, 0.000363, -0.000098, 0.006156, -0.003760, -0.008036, -0.005166, -0.008595, -0.002895, -0.009398, 0.003118, -0.008895, -0.008698
#*# 	  -0.033500, -0.026556, -0.023927, -0.032754, -0.023324, -0.016974, -0.012437, -0.007888, -0.002710, -0.010410, 0.003614, 0.005307, 0.006148, 0.005336, -0.003276, 0.006614, 0.005782, 0.000221, -0.002054, -0.003641, 0.005406, -0.004234, 0.005447, -0.000447, -0.007367
#*# 	  -0.030687, -0.018054, -0.017493, -0.017233, -0.011236, -0.006777, -0.005809, -0.005277, 0.001250, 0.005076, -0.000265, 0.005969, 0.003248, 0.006499, 0.006395, 0.005648, 0.006610, 0.001067, 0.005943, 0.006557, 0.006467, 0.001027, 0.006842, 0.006977, 0.006137
#*# 	  -0.027654, -0.016275, -0.016945, -0.016715, -0.006171, -0.006208, -0.006907, -0.011701, -0.001007, 0.006749, 0.001652, 0.006242, 0.005921, 0.007293, 0.003878, 0.005875, 0.005784, 0.007787, 0.000328, -0.002327, 0.004624, 0.007592, 0.007634, 0.012362, 0.005504
#*# 	  -0.028511, -0.025023, -0.019817, -0.016633, -0.011678, -0.011657, -0.006991, -0.009399, -0.010944, -0.000415, -0.000388, 0.005720, 0.006330, 0.003086, 0.006238, 0.005416, -0.002543, 0.005899, 0.004511, 0.000631, 0.005639, 0.007583, 0.006835, 0.011723, 0.007172
#*# 	  -0.035898, -0.024198, -0.021294, -0.018850, -0.019399, -0.016761, -0.006809, -0.013529, -0.001105, -0.004903, -0.001319, -0.001989, 0.001373, -0.004747, 0.005843, 0.004418, 0.003541, 0.006015, 0.004373, 0.010683, 0.008160, 0.012665, 0.013729, 0.017363, 0.008002
#*# 	  -0.023277, -0.023605, -0.023120, -0.022658, -0.013648, -0.019497, -0.018347, -0.007429, -0.006977, -0.000400, 0.000341, -0.003182, 0.008110, 0.008195, 0.005925, 0.006184, 0.006275, 0.004953, 0.009667, 0.014615, 0.012978, 0.014434, 0.016174, 0.017963, 0.017085
#*# 	  -0.024850, -0.018850, -0.018979, -0.015527, -0.012470, -0.007490, -0.004982, -0.005214, -0.002208, -0.002696, 0.003343, 0.005802, 0.007432, 0.006004, 0.011431, 0.010320, 0.005671, 0.008757, 0.010623, 0.004056, 0.018976, 0.018408, 0.022390, 0.017725, 0.020715
#*# 	  -0.021945, -0.017162, -0.017433, -0.010895, -0.012258, -0.018573, -0.013949, -0.003296, -0.002929, 0.001795, 0.002659, 0.007957, 0.011091, 0.006683, 0.006512, 0.008166, 0.016180, 0.021336, 0.015891, 0.023737, 0.020089, 0.019289, 0.026803, 0.032475, 0.022865
#*# 	  -0.022504, -0.016771, -0.018352, -0.019729, -0.011854, -0.015487, -0.011554, -0.011197, -0.000805, -0.002248, 0.001290, 0.003913, 0.010059, 0.010829, 0.004671, 0.011820, 0.014770, 0.015549, 0.019456, 0.018025, 0.026519, 0.022430, 0.021843, 0.030312, 0.027901
#*# 	  -0.026198, -0.024077, -0.019586, -0.022415, -0.018191, -0.009627, -0.016023, -0.016695, -0.002799, -0.006273, 0.001599, 0.001584, 0.002598, 0.006095, 0.005642, 0.011090, 0.013056, 0.010544, 0.007530, 0.025374, 0.021681, 0.016910, 0.024575, 0.025066, 0.021639
#*# 	  -0.026121, -0.021699, -0.020401, -0.021844, -0.019447, -0.014859, -0.014373, -0.018297, -0.011630, -0.006291, -0.004683, -0.002500, 0.004378, 0.004338, 0.004124, 0.006541, 0.006227, 0.005538, 0.012827, 0.007419, 0.020467, 0.020548, 0.020103, 0.021743, 0.023896
#*# 	  -0.033460, -0.024424, -0.018772, -0.022200, -0.020685, -0.016081, -0.010921, -0.005484, -0.011817, -0.019649, 0.001069, 0.000698, 0.000152, 0.002625, 0.001099, 0.003189, 0.005561, 0.007935, 0.010086, 0.012137, 0.009680, 0.013942, 0.013746, 0.022157, 0.020283
#*# 	  -0.024105, -0.021665, -0.021575, -0.021463, -0.020435, -0.018774, -0.013878, -0.012472, -0.014365, -0.009992, -0.002864, -0.009755, -0.001636, -0.001073, 0.001757, 0.001312, 0.002566, 0.000501, 0.005367, 0.009449, 0.009854, 0.010949, 0.018286, 0.023589, 0.020578
#*# 	  -0.038018, -0.041253, -0.027165, -0.023035, -0.021855, -0.022367, -0.019447, -0.015648, -0.007109, -0.014312, -0.010131, -0.000634, -0.001638, 0.000161, -0.002621, 0.001131, -0.002834, 0.004624, 0.002218, 0.013284, 0.005204, 0.007342, 0.010512, 0.020099, 0.011851
#*# 	  -0.039650, -0.033630, -0.028244, -0.040924, -0.023438, -0.033900, -0.022187, -0.021627, -0.023569, -0.020575, -0.022398, -0.018094, -0.012988, -0.012028, -0.009916, -0.012092, 0.000624, -0.021199, -0.013807, 0.000225, -0.003896, -0.001426, 0.001525, 0.000719, 0.003561
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 210.0
#*# min_y = 30.0
#*# max_y = 210.0
#*#
#*# [beacon model default]
#*# model_coef = 1.9257982386737142,
#*# 	  2.1904011986275074,
#*# 	  0.5881661108028357,
#*# 	  0.30341866940870527,
#*# 	  0.14823890288711727,
#*# 	  -0.42807822476666274,
#*# 	  -0.13716254071061182,
#*# 	  0.612855529187592,
#*# 	  0.08376843001203003,
#*# 	  -0.2664564217100284
#*# model_domain = 3.352922478536077e-07,3.360945745364866e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 72.578002
#*# model_offset = -0.33000
