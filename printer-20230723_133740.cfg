##########################
##### BASE CONFIG #######
##########################

[include mainsail.cfg]
[include ./backup/backup.cfg]

##########################
##### HARDWARE STUFF #####
##########################

[include ./hardware/xyz-stepper.cfg]
[include ./hardware/extruder.cfg]
#[include ./klicky/klicky-probe.cfg]
#[include ./hardware/adxl345.cfg]  This config now in canbus.cfg
[include ./hardware/fans.cfg] # Some fans config in canbus.cfg
[include ./hardware/canbus.cfg]

##########################
##### LIGHTS #############
##########################

[include ./hardware/chamber-lighting.cfg]
[include ./hardware/stealthburner-led.cfg]

##########################
##### CALIBRATION ########
##########################

[include ./calibration/z-tilt.cfg]
[include ./calibration/bed-mesh.cfg]
[include ./macros/unsafe.cfg]
[include ./calibration/pressure_advance.cfg]
[include test_probe_accuracy.cfg]

##########################
##### MACROS #############
##########################

[include ./macros/chamber-led.cfg]
[include ./macros/conditional-homing.cfg]
[include ./macros/print-end.cfg]
[include ./macros/print-start-mmu.cfg]
[include ./macros/dump-variables.cfg]
[include ./macros/movement-check.cfg]
[include ./macros/cancel-change.cfg]
[include ./macros/pause-resume.cfg]         ; Overridden by ERCF / subsequantly disabled
[include ./macros/load-unload.cfg]
[include ./macros/filament-change.cfg]
[include ./macros/park.cfg]
#[include ./macros/prusaslicer-accel.cfg]

##########################
##### THIRD PARTY ########
##########################

[include ./third-party-cfg/nozzle_scrub.cfg]
[include ./kamp/Adaptive_Mesh.cfg]
[include ./kamp/Adaptive_Purge.cfg]

##########################
##### ERCF ###############
##########################


[include ercf_hardware.cfg]
[include ercf_parameters.cfg]
[include ercf_software.cfg]
[include ./calibration/ercf_additional.cfg]
#[include ercf_vars.cfg]
[include client_macros.cfg]

##########################
##### LCD/MENU ###########
##########################

#[include ./third-party-cfg/nozzle_scrub_menu.cfg]
#[include ercf_menu.cfg]
#[include ./menu/printer_menu.cfg]

##########################
##### NOT ENABLED YET ####
##########################

#[include ./todo/mini12864.cfg] Add this after adding mini12864 LED
#[include ./todo/lcd_tweaks.cfg] Need to figure this one out and then implement
#[include ./hardware/nevermore.cfg] Disabled as I prefer to chamber vent outside and needed the PWM

##########################
#### REPLACEMENT #########
##########################

[include ./replacement_macros/replace-m900.cfg]
[include ./replacement_macros/replace-m117.cfg]

[exclude_object]

[gcode_arcs]
resolution: 0.1

[respond]
default_type: echo
default_prefix:  

[force_move]
# Enable commands that force potentially unsafe movement
enable_force_move: True

[idle_timeout]
timeout: 14400

[mcu]
##  Obtain definition by "ls -l /dev/serial/by-id/" then unplug to verify
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_290040000750314D35323820-if00
restart_method: command

[mcu rpi]
# Add Rpi as secondary MCU to allow for ADXL use through SPI ribbon/adapter from LDO
serial: /tmp/klipper_host_mcu

[mcu sht]
canbus_uuid: 30993412e8e0

[printer]
kinematics: corexy
max_velocity: 600           # Changed from 200 on 7.11.23
max_accel:  6000            # tuned on 7.11.23 after beacon install.
max_z_velocity: 15          #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 350
square_corner_velocity: 8.0 # Changed on 7.11.23

#####################################################################
#   Input Shaper
#####################################################################

[input_shaper]
shaper_freq_x: 76.2               ; suggested max_accel <= 22600 mm/sec^2
shaper_type_x: zv
shaper_freq_y: 51.8               ; suggested max_accel <= 7900 mm/sec^2
shaper_type_y: mzv


#####################################################################
#   Bed Heater
#####################################################################

##  SSR Pin - HE1
##  Thermistor - TB
[heater_bed]
heater_pin: PA2 #PA2 is LDO default
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF3
##  Adjust Max Power so your heater doesn't warp your bed. Rule of thumb is 0.4 watts / cm^2 .
max_power: 0.6
min_temp: 0
max_temp: 125
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

#####################################################################
#   Probe
#####################################################################

##  WAS TAP - NOW BEACON in CANBUS
#[probe]
#pin: ^sht:PA2
#x_offset: 0
#y_offset: 25.0
#z_offset: 0
#x_offset: 0
#y_offset: 0
#z_offset: 6.42
#speed: 5.0
#lift_speed: 15
#samples: 3
#samples_result: median
#sample_retract_dist: 2.0
#samples_tolerance: 0.01
#samples_tolerance_retries: 3
# After TAP installation, with PLA, Flow Rate 98%, 0.25mm First Layer, 0.6mm CHT nozzle, Z_Offset is z_offset = -0.450
#activate_gcode:
#    {% set PROBE_TEMP = 150 %}
#    {% set MAX_TEMP = PROBE_TEMP + 5 %}
#    {% set ACTUAL_TEMP = printer.extruder.temperature %}
#    {% set TARGET_TEMP = printer.extruder.target %}
#
#    {% if TARGET_TEMP > PROBE_TEMP %}
#        { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (TARGET_TEMP, PROBE_TEMP)) }
#        M109 S{ PROBE_TEMP }
#    {% else %}
#        # Temperature target is already low enough, but nozzle may still be too hot.
#        {% if ACTUAL_TEMP > MAX_TEMP %}
#            { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (ACTUAL_TEMP, MAX_TEMP)) }
#            TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={ MAX_TEMP }
#        {% endif %}
#    {% endif %}

#####################################################################
#  Filament Runout
#####################################################################

#[filament_motion_sensor RunoutSensor]
#detection_length: 10
#extruder: extruder
#switch_pin: ^PG11
#pause_on_runout: True
#runout_gcode:
#  M117 Filament problem, runout has paused.
#  M118 Filament problem, runout has paused.
#insert_gcode:
#event_delay:
#pause_delay:

#####################################################################
#   Additional Sensors
#####################################################################

[thermistor CMFB103F3950FANT]
temperature1: 0.0
resistance1: 32116.0
temperature2: 40.0
resistance2: 5309.0
temperature3: 80.0
resistance3: 1228.0

#[temperature_sensor sb_ambient_temp]
## Chamber Temperature - T1
#sensor_type: CMFB103F3950FANT
#sensor_pin: PF5
#min_temp: 0
#max_temp: 100
#gcode_id: chamber_th

[temperature_sensor back_chamber_temp]
## Chamber Temperature - T
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PF6
min_temp: 0
max_temp: 100
gcode_id: chamber_th2

[temperature_sensor RPi4]
sensor_type: temperature_host
min_temp: 0
max_temp: 100

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################

#[safe_z_home]
##  XY Location of the Z Endstop Switch
##  Update -10,-10 to the XY coordinates of your endstop pin 
##  (such as 157,305) after going through Z Endstop Pin
##  Location Definition step.
#home_xy_position: 147,256
#speed:100
#z_hop:10
#z_hop_speed:10


########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<5V>

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 39.889
#*# pid_ki = 0.964
#*# pid_kd = 412.851
#*#
#*# [probe]
#*# z_offset = -1.270
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.053137, -0.059770, -0.040364, -0.038915, -0.036434, -0.031556, -0.023009, -0.022317, -0.023695, -0.028790, -0.021998, -0.024777, -0.019627, -0.022003, -0.026005, -0.026242, -0.022642, -0.028163, -0.030644, -0.024076, -0.023328, -0.026964, -0.023851, -0.025825, -0.030182
#*# 	  -0.048086, -0.042239, -0.026230, -0.023666, -0.022715, -0.023617, -0.026640, -0.030593, -0.012350, -0.013338, -0.016596, -0.017115, -0.015438, -0.013193, -0.018231, -0.023652, -0.021995, -0.019280, -0.022996, -0.023335, -0.013778, -0.013924, -0.022968, -0.015731, -0.013837
#*# 	  -0.038355, -0.034852, -0.038563, -0.031290, -0.017048, -0.023075, -0.013272, -0.012072, -0.012214, -0.011184, -0.012065, -0.009544, -0.011739, -0.011878, -0.015779, -0.011778, -0.022580, -0.012810, -0.012290, -0.017476, -0.016991, -0.017258, -0.013518, -0.012529, -0.015934
#*# 	  -0.041038, -0.036908, -0.040796, -0.024942, -0.024124, -0.012725, -0.015795, -0.011234, -0.011694, -0.011297, -0.006001, -0.005265, -0.002178, -0.005442, -0.012250, -0.015982, -0.015880, -0.016616, -0.013910, -0.011817, -0.011538, -0.012110, -0.002806, -0.010216, -0.012253
#*# 	  -0.056151, -0.045834, -0.037042, -0.035402, -0.036049, -0.025060, -0.021058, -0.012483, -0.015000, -0.015387, -0.000171, -0.006418, -0.010942, -0.017118, -0.009804, -0.011041, -0.010792, -0.005168, -0.009557, -0.011204, -0.001295, -0.005516, -0.005462, -0.004386, -0.010764
#*# 	  -0.051165, -0.037408, -0.047338, -0.031569, -0.026851, -0.027168, -0.012580, -0.001641, -0.009518, -0.005227, -0.000963, 0.001031, 0.002105, 0.002204, -0.002268, -0.004560, -0.003510, -0.006082, -0.008303, -0.004297, -0.001452, -0.001163, -0.002225, -0.003385, -0.005663
#*# 	  -0.052880, -0.055674, -0.041770, -0.044462, -0.030007, -0.024122, -0.021975, -0.010639, -0.007385, -0.000389, -0.001842, -0.002558, 0.000742, -0.001169, 0.002670, 0.005036, -0.002810, -0.002476, -0.001978, -0.001287, -0.002784, -0.001327, -0.001326, -0.001737, -0.003544
#*# 	  -0.049851, -0.051041, -0.050030, -0.030197, -0.034685, -0.030139, -0.012181, -0.007775, -0.000268, -0.002938, 0.000572, -0.000173, -0.001108, 0.006573, 0.006834, -0.002011, -0.003511, -0.002607, -0.003103, -0.001043, -0.002016, -0.002905, -0.001653, -0.003429, -0.001785
#*# 	  -0.039283, -0.035113, -0.036186, -0.036754, -0.027729, -0.017619, -0.012087, -0.002562, -0.008856, -0.006644, -0.002573, -0.002604, -0.003071, -0.000172, 0.003470, -0.001228, 0.000667, 0.004135, 0.001913, 0.003380, -0.002531, 0.005449, 0.003284, -0.003520, -0.003614
#*# 	  -0.033572, -0.028592, -0.029626, -0.018323, -0.024476, -0.014778, -0.017004, -0.011013, -0.007408, -0.004313, -0.003351, 0.005116, -0.004814, 0.009055, 0.007640, 0.001685, -0.002927, 0.003906, 0.001165, 0.004609, 0.004304, 0.008135, 0.004020, -0.002035, -0.002089
#*# 	  -0.027721, -0.023357, -0.014351, -0.016749, -0.004605, -0.009504, -0.006784, -0.007324, -0.001236, -0.003618, 0.004505, 0.009953, 0.010917, -0.001608, -0.003985, -0.002903, 0.009360, 0.000204, -0.000256, 0.002782, -0.001199, 0.005377, 0.010896, 0.005602, -0.001555
#*# 	  -0.020599, -0.010086, -0.018362, -0.009468, -0.007826, -0.007756, -0.005544, 0.003048, 0.001172, 0.001619, 0.000592, 0.011835, 0.016827, 0.010208, 0.004318, 0.014602, 0.000353, 0.010313, 0.011896, -0.002360, -0.002501, 0.006024, -0.000430, 0.016490, 0.004227
#*# 	  -0.023045, -0.008692, -0.007555, -0.006499, -0.006046, -0.004429, 0.002527, 0.002355, 0.008626, 0.009907, 0.002817, 0.005418, 0.000000, 0.017541, 0.018423, 0.009898, 0.008704, 0.005282, -0.001090, 0.017773, -0.003468, 0.005388, 0.017648, 0.007880, 0.006967
#*# 	  -0.023656, -0.027723, -0.006577, -0.012056, -0.005560, -0.006287, -0.004242, -0.002346, 0.000268, 0.003240, 0.002630, 0.007194, 0.007031, 0.011134, 0.001887, -0.002373, 0.003581, 0.005424, 0.000284, 0.016526, 0.015476, 0.008654, 0.017665, -0.004034, 0.014668
#*# 	  -0.025996, -0.025174, -0.022182, -0.007436, -0.008305, -0.006834, -0.006284, -0.005527, -0.004359, -0.004820, -0.005001, -0.000346, 0.003953, 0.006961, 0.005425, 0.006491, 0.002233, 0.002340, -0.001153, 0.003148, 0.008669, 0.017593, 0.001860, 0.017315, -0.001594
#*# 	  -0.027262, -0.019098, -0.012702, -0.013426, -0.018600, -0.010433, -0.010817, -0.007091, -0.006408, -0.004814, 0.000615, 0.001030, 0.004786, 0.004541, 0.005667, 0.009622, 0.008943, 0.010788, 0.015969, 0.017195, 0.006723, 0.006967, 0.014635, 0.013870, 0.016999
#*# 	  -0.025476, -0.010459, -0.017400, -0.006558, -0.005159, -0.008834, -0.006308, -0.006488, -0.005864, -0.005099, -0.001982, 0.001893, 0.006801, -0.001520, 0.013773, -0.002445, -0.002654, 0.017904, 0.008645, 0.014920, 0.015467, 0.011317, 0.018635, 0.017752, 0.020093
#*# 	  -0.023537, -0.025145, -0.008426, -0.010404, -0.009451, -0.011801, -0.006753, -0.006968, -0.006038, -0.005344, 0.004565, 0.004610, 0.011909, 0.005927, 0.005420, 0.018221, 0.015248, 0.011616, 0.014049, 0.017125, 0.018141, 0.018544, 0.021531, 0.018797, 0.018942
#*# 	  -0.024689, -0.018061, -0.007434, -0.006831, -0.011120, -0.012864, -0.006360, -0.006343, -0.002692, -0.004687, 0.003498, 0.009533, 0.016298, 0.014749, 0.006778, 0.007037, 0.006985, 0.017709, 0.013698, 0.017992, 0.019222, 0.017999, 0.030943, 0.026454, 0.022607
#*# 	  -0.023494, -0.021280, -0.018545, -0.012477, -0.015985, -0.017302, -0.008473, -0.010360, -0.006678, -0.005081, -0.002744, 0.001383, 0.007375, 0.010220, 0.005810, 0.018335, 0.017425, -0.004133, 0.006179, 0.018005, 0.017028, 0.017628, 0.022679, 0.019164, 0.017829
#*# 	  -0.031445, -0.028301, -0.015201, -0.016916, -0.021676, -0.020253, -0.013587, -0.014287, -0.006695, -0.007869, -0.007077, -0.002243, 0.007281, -0.001634, 0.000679, 0.008285, 0.003707, 0.004240, 0.018114, 0.014613, 0.017813, 0.008735, 0.018403, 0.018563, 0.018712
#*# 	  -0.031058, -0.029979, -0.019863, -0.024358, -0.015179, -0.014725, -0.006312, -0.030051, -0.007320, -0.009798, -0.006902, -0.006240, -0.005015, -0.005135, -0.001473, 0.001135, 0.000226, 0.001435, 0.005247, -0.000336, -0.002179, 0.002334, 0.007682, 0.014991, 0.018926
#*# 	  -0.032179, -0.030897, -0.030566, -0.028163, -0.021125, -0.014528, -0.013389, -0.012447, -0.018365, -0.006627, -0.015788, -0.006705, -0.003194, -0.006496, -0.006300, 0.000266, 0.002595, 0.003192, -0.001576, 0.003812, 0.005198, 0.006000, 0.003657, 0.012754, -0.004245
#*# 	  -0.040795, -0.031536, -0.030686, -0.030245, -0.028574, -0.023678, -0.024569, -0.015747, -0.018993, -0.015103, -0.012642, -0.014629, -0.007894, -0.009649, -0.006266, -0.006898, -0.005821, -0.005471, -0.004835, -0.003583, -0.000204, -0.006377, -0.001923, 0.010979, 0.006972
#*# 	  -0.048904, -0.043633, -0.045209, -0.036994, -0.036059, -0.031222, -0.031156, -0.031223, -0.029994, -0.026753, -0.027242, -0.024840, -0.025999, -0.018093, -0.018141, -0.028713, -0.018291, -0.015516, -0.005780, -0.017416, -0.006404, -0.007317, -0.005559, -0.006682, -0.005301
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 210.0
#*# min_y = 32.265
#*# max_y = 210.0
#*#
#*# [beacon model default]
#*# model_coef = 1.9257982386737142,
#*# 	  2.1904011986275074,
#*# 	  0.5881661108028357,
#*# 	  0.30341866940870527,
#*# 	  0.14823890288711727,
#*# 	  -0.42807822476666274,
#*# 	  -0.13716254071061182,
#*# 	  0.612855529187592,
#*# 	  0.08376843001203003,
#*# 	  -0.2664564217100284
#*# model_domain = 3.352922478536077e-07,3.360945745364866e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 72.578002
#*# model_offset = -0.17000
