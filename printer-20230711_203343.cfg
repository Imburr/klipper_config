##########################
##### BASE CONFIG #######
##########################

[include mainsail.cfg]
[include ./backup/backup.cfg]

##########################
##### HARDWARE STUFF #####
##########################

[include ./hardware/xyz-stepper.cfg]
[include ./hardware/extruder.cfg]
#[include ./klicky/klicky-probe.cfg]
#[include ./hardware/adxl345.cfg]  This config now in canbus.cfg
[include ./hardware/fans.cfg] # Some fans config in canbus.cfg
[include ./hardware/canbus.cfg]

##########################
##### LIGHTS #############
##########################

[include ./hardware/chamber-lighting.cfg]
[include ./hardware/stealthburner-led.cfg]

##########################
##### CALIBRATION ########
##########################

[include ./calibration/z-tilt.cfg]
[include ./calibration/bed-mesh.cfg]
[include ./macros/unsafe.cfg]
[include ./calibration/pressure_advance.cfg]
[include test_probe_accuracy.cfg]

##########################
##### MACROS #############
##########################

[include ./macros/chamber-led.cfg]
[include ./macros/conditional-homing.cfg]
[include ./macros/print-end.cfg]
[include ./macros/print-start-mmu.cfg]
[include ./macros/dump-variables.cfg]
[include ./macros/movement-check.cfg]
[include ./macros/cancel-change.cfg]
[include ./macros/pause-resume.cfg]         ; Overridden by ERCF / subsequantly disabled
[include ./macros/load-unload.cfg]
[include ./macros/filament-change.cfg]
[include ./macros/park.cfg]
[include ./macros/prusaslicer-accel.cfg]

##########################
##### THIRD PARTY ########
##########################

[include ./third-party-cfg/nozzle_scrub.cfg]
[include ./kamp/Adaptive_Mesh.cfg]
[include ./kamp/Adaptive_Purge.cfg]

##########################
##### ERCF ###############
##########################


[include ercf_hardware.cfg]
[include ercf_parameters.cfg]
[include ercf_software.cfg]
[include ./calibration/ercf_additional.cfg]
#[include ercf_vars.cfg]
[include client_macros.cfg]

##########################
##### LCD/MENU ###########
##########################

#[include ./third-party-cfg/nozzle_scrub_menu.cfg]
#[include ercf_menu.cfg]
#[include ./menu/printer_menu.cfg]

##########################
##### NOT ENABLED YET ####
##########################

#[include ./todo/mini12864.cfg] Add this after adding mini12864 LED
#[include ./todo/lcd_tweaks.cfg] Need to figure this one out and then implement
#[include ./hardware/nevermore.cfg] Disabled as I prefer to chamber vent outside and needed the PWM

##########################
#### REPLACEMENT #########
##########################

[include ./replacement_macros/replace-m900.cfg]
[include ./replacement_macros/replace-m117.cfg]

[exclude_object]

[respond]
default_type: echo
default_prefix:  

[force_move]
# Enable commands that force potentially unsafe movement
enable_force_move: True

[idle_timeout]
timeout: 14400

[mcu]
##  Obtain definition by "ls -l /dev/serial/by-id/" then unplug to verify
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_290040000750314D35323820-if00
restart_method: command

[mcu rpi]
# Add Rpi as secondary MCU to allow for ADXL use through SPI ribbon/adapter from LDO
serial: /tmp/klipper_host_mcu

[mcu sht]
canbus_uuid: 30993412e8e0

[printer]
kinematics: corexy
max_velocity: 200  
max_accel:  6000            # Was 9000, dialed it back on 3/3/23 after tuning IS.
max_z_velocity: 15          #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 350
square_corner_velocity: 5.0

#####################################################################
#   Input Shaper
#####################################################################

[input_shaper]
#shaper_freq_x: 60.4               ; suggested max_accel <= 10700 mm/sec^2
#shaper_type_x: mzv
#shaper_freq_y: 70.8               ; suggested max_accel <= 14800 mm/sec^2
#shaper_type_y: mzv


#####################################################################
#   Bed Heater
#####################################################################

##  SSR Pin - HE1
##  Thermistor - TB
[heater_bed]
heater_pin: PA2 #PA2 is LDO default
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF3
##  Adjust Max Power so your heater doesn't warp your bed. Rule of thumb is 0.4 watts / cm^2 .
max_power: 0.6
min_temp: 0
max_temp: 125
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

#####################################################################
#   Probe
#####################################################################

##  WAS TAP - NOW BEACON in CANBUS
#[probe]
#pin: ^sht:PA2
#x_offset: 0
#y_offset: 25.0
#z_offset: 0
#x_offset: 0
#y_offset: 0
#z_offset: 6.42
#speed: 5.0
#lift_speed: 15
#samples: 3
#samples_result: median
#sample_retract_dist: 2.0
#samples_tolerance: 0.01
#samples_tolerance_retries: 3
# After TAP installation, with PLA, Flow Rate 98%, 0.25mm First Layer, 0.6mm CHT nozzle, Z_Offset is z_offset = -0.450
#activate_gcode:
#    {% set PROBE_TEMP = 150 %}
#    {% set MAX_TEMP = PROBE_TEMP + 5 %}
#    {% set ACTUAL_TEMP = printer.extruder.temperature %}
#    {% set TARGET_TEMP = printer.extruder.target %}
#
#    {% if TARGET_TEMP > PROBE_TEMP %}
#        { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (TARGET_TEMP, PROBE_TEMP)) }
#        M109 S{ PROBE_TEMP }
#    {% else %}
#        # Temperature target is already low enough, but nozzle may still be too hot.
#        {% if ACTUAL_TEMP > MAX_TEMP %}
#            { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (ACTUAL_TEMP, MAX_TEMP)) }
#            TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={ MAX_TEMP }
#        {% endif %}
#    {% endif %}

#####################################################################
#  Filament Runout
#####################################################################

#[filament_motion_sensor RunoutSensor]
#detection_length: 10
#extruder: extruder
#switch_pin: ^PG11
#pause_on_runout: True
#runout_gcode:
#  M117 Filament problem, runout has paused.
#  M118 Filament problem, runout has paused.
#insert_gcode:
#event_delay:
#pause_delay:

#####################################################################
#   Additional Sensors
#####################################################################

[thermistor CMFB103F3950FANT]
temperature1: 0.0
resistance1: 32116.0
temperature2: 40.0
resistance2: 5309.0
temperature3: 80.0
resistance3: 1228.0

#[temperature_sensor sb_ambient_temp]
## Chamber Temperature - T1
#sensor_type: CMFB103F3950FANT
#sensor_pin: PF5
#min_temp: 0
#max_temp: 100
#gcode_id: chamber_th

[temperature_sensor back_chamber_temp]
## Chamber Temperature - T
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PF6
min_temp: 0
max_temp: 100
gcode_id: chamber_th2

[temperature_sensor RPi4]
sensor_type: temperature_host
min_temp: 0
max_temp: 100

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################

#[safe_z_home]
##  XY Location of the Z Endstop Switch
##  Update -10,-10 to the XY coordinates of your endstop pin 
##  (such as 157,305) after going through Z Endstop Pin
##  Location Definition step.
#home_xy_position: 147,256
#speed:100
#z_hop:10
#z_hop_speed:10


########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<5V>

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 39.889
#*# pid_ki = 0.964
#*# pid_kd = 412.851
#*#
#*# [probe]
#*# z_offset = -1.290
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 68.4
#*# shaper_type_y = mzv
#*# shaper_freq_y = 45.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.055453, -0.050390, -0.039733, -0.040208, -0.032461, -0.025684, -0.036040, -0.030148, -0.028576, -0.022859, -0.023344, -0.021462, -0.023104, -0.018375, -0.018503, -0.022669, -0.020566, -0.019090, -0.023095, -0.023977, -0.023089, -0.015789, -0.017432, -0.014408, -0.021161
#*# 	  -0.051644, -0.039408, -0.037051, -0.033902, -0.027687, -0.026447, -0.026970, -0.018903, -0.020596, -0.021454, -0.014289, -0.013453, -0.017006, -0.017209, -0.016635, -0.015648, -0.026463, -0.021440, -0.016803, -0.016262, -0.016160, -0.021375, -0.017047, -0.014152, -0.014046
#*# 	  -0.045994, -0.041112, -0.034753, -0.025473, -0.034988, -0.023497, -0.017103, -0.018835, -0.018542, -0.019299, -0.012577, -0.008551, -0.007813, -0.009559, -0.004423, -0.003175, -0.013555, -0.012279, -0.014760, -0.007526, -0.004684, -0.012326, -0.008814, -0.010061, -0.018724
#*# 	  -0.048393, -0.052592, -0.042410, -0.018814, -0.022806, -0.023249, -0.021167, -0.007461, -0.014609, -0.004206, -0.011090, -0.008228, -0.011098, -0.007160, 0.003854, -0.014105, -0.009820, -0.016016, 0.006691, -0.004472, -0.014997, -0.011112, -0.014191, -0.012077, -0.017658
#*# 	  -0.053295, -0.051103, -0.044446, -0.039748, -0.030272, -0.027858, -0.016211, -0.016752, -0.002825, -0.012792, -0.009899, 0.000357, -0.005995, -0.009914, -0.009587, -0.002217, -0.015860, -0.006655, -0.012837, -0.016051, -0.003900, 0.004898, -0.012583, -0.013952, -0.019364
#*# 	  -0.064006, -0.052858, -0.042559, -0.040539, -0.038700, -0.035196, -0.017211, -0.013725, -0.011001, -0.012403, -0.016060, -0.010724, -0.006223, -0.007255, -0.002521, -0.006558, -0.002400, -0.010121, -0.012835, -0.014295, -0.010151, -0.013205, -0.011787, -0.012427, -0.016289
#*# 	  -0.053435, -0.047664, -0.042481, -0.043325, -0.038057, -0.035620, -0.020320, -0.012091, -0.017562, -0.006369, -0.005620, -0.006258, -0.004038, -0.007321, -0.011976, -0.000280, -0.013217, -0.012561, -0.008579, -0.010482, -0.013644, -0.013301, -0.011823, -0.014512, -0.015018
#*# 	  -0.046809, -0.042337, -0.040916, -0.036340, -0.032845, -0.028250, -0.014937, -0.011881, -0.009637, -0.008926, -0.009894, -0.004288, -0.008520, -0.006091, -0.008234, -0.007305, -0.005932, -0.008725, -0.006243, -0.010591, -0.008853, -0.010006, -0.011769, -0.014240, -0.015307
#*# 	  -0.035845, -0.034823, -0.036497, -0.034642, -0.030987, -0.020261, -0.015588, -0.009710, -0.006723, -0.005313, -0.006514, -0.008415, -0.008744, -0.008827, 0.011369, -0.005010, -0.009705, -0.007221, -0.006139, -0.007255, -0.012436, -0.011142, -0.014344, -0.013644, -0.014861
#*# 	  -0.032042, -0.025790, -0.024974, -0.025805, -0.024895, -0.015853, -0.012837, -0.010543, -0.008998, -0.011725, -0.010935, -0.010037, -0.011194, -0.014052, -0.012840, -0.007879, -0.008429, -0.008271, -0.012155, -0.009156, -0.011928, -0.010834, -0.017148, -0.015252, -0.018137
#*# 	  -0.017122, -0.017385, -0.020425, -0.016403, -0.014039, -0.012050, -0.010902, -0.009524, -0.012935, -0.002064, -0.009944, 0.000912, -0.009046, -0.008992, -0.011694, -0.010033, -0.013129, -0.017108, -0.011906, -0.010103, -0.012116, -0.013815, -0.011025, -0.012722, -0.020979
#*# 	  -0.012160, -0.010885, -0.008264, -0.009605, -0.007595, -0.009132, -0.003309, -0.008134, 0.008532, -0.000621, -0.000631, 0.002688, 0.001988, -0.005232, 0.001628, 0.005594, -0.007764, -0.006226, -0.009457, -0.009540, -0.010128, -0.009835, -0.009702, -0.014044, -0.015830
#*# 	  -0.008506, -0.010178, -0.007695, -0.008400, -0.008883, 0.005757, -0.000807, -0.008003, 0.001445, 0.009149, 0.010419, 0.006212, 0.000000, 0.001816, 0.004575, 0.006527, -0.002958, -0.009883, -0.009927, -0.009585, -0.009168, -0.019080, -0.010427, -0.011696, -0.016954
#*# 	  -0.013240, -0.009629, -0.003140, -0.005991, -0.005207, -0.004856, -0.000413, -0.004166, 0.008105, -0.003389, -0.008821, 0.006404, 0.005117, -0.002404, -0.009272, -0.007911, -0.005580, -0.009934, -0.012062, -0.007406, -0.008920, -0.009089, -0.011544, -0.011369, -0.017522
#*# 	  -0.006276, -0.003696, -0.007663, -0.006373, -0.003676, -0.001939, -0.007241, -0.007860, 0.000132, 0.001506, -0.002720, 0.006114, -0.003345, -0.004380, -0.004895, -0.003215, -0.003981, -0.010820, -0.011490, -0.010321, -0.011766, -0.015888, -0.014034, -0.012133, -0.019651
#*# 	  -0.004715, -0.002113, 0.000250, -0.002241, -0.000901, -0.001508, 0.000964, 0.000771, -0.003191, -0.000886, 0.000348, -0.001279, 0.002350, 0.000517, 0.000482, -0.003989, -0.005718, -0.006282, -0.002423, -0.010813, -0.004161, -0.005154, -0.007043, -0.010746, -0.008666
#*# 	  0.002429, 0.003903, -0.001515, 0.001766, 0.002128, 0.003476, 0.000492, 0.003919, -0.001528, 0.001086, -0.000460, -0.005295, 0.001026, 0.006739, 0.001908, 0.001638, -0.000081, -0.004448, -0.007732, -0.002446, -0.005507, -0.003997, -0.004922, -0.001491, -0.011583
#*# 	  -0.000108, 0.007234, 0.008363, 0.008371, 0.003194, 0.004461, 0.011081, 0.011699, 0.000042, 0.002392, 0.007700, 0.005926, 0.004834, 0.003922, 0.003392, 0.003610, 0.002944, 0.001283, 0.003223, -0.001966, -0.002023, -0.001677, 0.000771, 0.000547, -0.005850
#*# 	  0.005479, 0.013157, 0.014348, 0.016805, 0.006286, 0.007204, 0.003460, 0.005980, 0.007138, 0.005955, 0.009043, 0.002467, 0.004218, 0.004965, -0.001377, 0.012450, 0.001758, -0.010829, -0.000263, 0.003068, -0.001199, 0.003548, 0.001713, 0.000239, -0.008336
#*# 	  0.001053, 0.000358, 0.017372, 0.008965, 0.009015, 0.007112, 0.006429, 0.005724, 0.006196, 0.004734, 0.001341, 0.006549, 0.004950, 0.005831, 0.002715, 0.004656, 0.002962, 0.001714, 0.003041, -0.000230, -0.000249, -0.002801, -0.002137, -0.006492, -0.012204
#*# 	  0.002171, 0.015462, 0.013592, 0.006016, 0.012687, 0.004125, 0.009504, 0.006074, 0.002160, 0.002405, 0.002170, 0.005381, 0.001543, 0.004657, 0.001552, 0.001781, -0.001619, -0.004774, 0.001485, -0.008086, -0.004159, -0.006274, -0.005834, -0.009494, -0.016988
#*# 	  0.013405, 0.018879, 0.012432, 0.020105, 0.009124, 0.006185, 0.005827, 0.002990, -0.000081, 0.000441, 0.004553, 0.001771, -0.000349, -0.000008, -0.001393, 0.000523, -0.005175, -0.001094, -0.005176, -0.009170, -0.004579, -0.010611, -0.011334, -0.021781, -0.017586
#*# 	  0.008203, 0.017041, 0.012680, 0.020231, 0.011579, 0.019932, 0.007540, 0.008530, -0.000483, 0.001349, -0.001925, 0.002665, -0.001297, -0.000795, -0.002276, -0.003448, -0.006899, -0.004610, -0.004649, -0.006004, -0.010712, -0.013723, -0.013042, -0.018127, -0.024078
#*# 	  0.006406, 0.020645, 0.021902, 0.015084, 0.012346, 0.017473, 0.011156, 0.006888, 0.003571, -0.001207, 0.004068, -0.003610, -0.001099, -0.000734, -0.002625, -0.001855, -0.001865, -0.003257, -0.008783, -0.016623, -0.019129, -0.018985, -0.023840, -0.023120, -0.026478
#*# 	  0.011874, 0.010606, 0.011000, 0.007978, 0.010187, 0.007359, 0.008872, 0.001741, -0.001975, -0.003306, -0.001966, -0.004541, -0.000523, -0.002091, -0.009179, -0.013297, -0.017680, -0.021759, -0.021626, -0.025978, -0.025726, -0.025882, -0.029598, -0.033791, -0.036151
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 210.0
#*# min_y = 30.0
#*# max_y = 210.0
#*#
#*# [beacon model default]
#*# model_coef = 1.9257982386737142,
#*# 	2.1904011986275074,
#*# 	0.5881661108028357,
#*# 	0.30341866940870527,
#*# 	0.14823890288711727,
#*# 	-0.42807822476666274,
#*# 	-0.13716254071061182,
#*# 	0.612855529187592,
#*# 	0.08376843001203003,
#*# 	-0.2664564217100284
#*# model_domain = 3.352922478536077e-07,3.360945745364866e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 72.578002
#*# model_offset = -0.31000
