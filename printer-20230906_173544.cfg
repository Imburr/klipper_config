##########################
##### BASE CONFIG #######
##########################

[include mainsail.cfg]
[include ./backup/backup.cfg]

##########################
##### HARDWARE STUFF #####
##########################

[include ./hardware/xyz-stepper.cfg]
[include ./hardware/extruder.cfg]
#[include ./klicky/klicky-probe.cfg]
#[include ./hardware/adxl345.cfg]  This config now in canbus.cfg
[include ./hardware/fans.cfg] # Some fans config in canbus.cfg
[include ./hardware/canbus.cfg]

##########################
##### LIGHTS #############
##########################

[include ./hardware/chamber-lighting.cfg]
[include ./hardware/stealthburner-led.cfg]

##########################
##### CALIBRATION ########
##########################

[include ./calibration/z-tilt.cfg]
[include ./calibration/bed-mesh.cfg]
[include ./macros/unsafe.cfg]
[include ./calibration/pressure_advance.cfg]
[include ./calibration/test_speed.cfg]
[include test_probe_accuracy.cfg]

##########################
##### MACROS #############
##########################

[include ./macros/chamber-led.cfg]
[include ./macros/conditional-homing.cfg]
[include ./macros/print-end.cfg]
[include ./macros/print-start-mmu.cfg]
[include ./macros/dump-variables.cfg]
[include ./macros/movement-check.cfg]
[include ./macros/cancel-change.cfg]
[include ./macros/pause-resume.cfg]         ; Overridden by ERCF / subsequantly disabled
[include ./macros/load-unload.cfg]
[include ./macros/filament-change.cfg]
[include ./macros/park.cfg]
#[include ./macros/prusaslicer-accel.cfg]

##########################
##### THIRD PARTY ########
##########################

#[include ./third-party-cfg/nozzle_scrub.cfg]
[include KAMP_Settings.cfg]

##########################
##### ERCF ###############
##########################


[include ercf_hardware.cfg]
[include ercf_parameters.cfg]
[include ercf_software.cfg]
[include ./calibration/ercf_additional.cfg]
#[include ercf_vars.cfg]
#[include client_macros.cfg]

##########################
##### LCD/MENU ###########
##########################

#[include ./third-party-cfg/nozzle_scrub_menu.cfg]
#[include ercf_menu.cfg]
#[include ./menu/printer_menu.cfg]

##########################
##### NOT ENABLED YET ####
##########################

#[include ./todo/mini12864.cfg] Add this after adding mini12864 LED
#[include ./todo/lcd_tweaks.cfg] Need to figure this one out and then implement
#[include ./hardware/nevermore.cfg] Disabled as I prefer to chamber vent outside and needed the PWM

##########################
#### REPLACEMENT #########
##########################

[include ./replacement_macros/replace-m900.cfg]
[include ./replacement_macros/replace-m117.cfg]

[exclude_object]

[gcode_arcs]
resolution: 0.1

[respond]
default_type: echo
default_prefix:  

[force_move]
# Enable commands that force potentially unsafe movement
enable_force_move: True

[idle_timeout]
timeout: 14400

[mcu]
##  Obtain definition by "ls -l /dev/serial/by-id/" then unplug to verify
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_290040000750314D35323820-if00
restart_method: command

[mcu rpi]
# Add Rpi as secondary MCU to allow for ADXL use through SPI ribbon/adapter from LDO
serial: /tmp/klipper_host_mcu

[mcu sht]
canbus_uuid: 30993412e8e0

[printer]
kinematics: corexy
max_velocity: 200           # Changed from 200 on 7.11.23
max_accel:  6000            # tuned on 7.11.23 after beacon install.
max_z_velocity: 15          #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 350
square_corner_velocity: 5.0 # Changed on 7.11.23

#####################################################################
#   Input Shaper
#####################################################################

[input_shaper]
#shaper_freq_x: 76.2               ; suggested max_accel <= 22600 mm/sec^2
#shaper_type_x: zv
#shaper_freq_y: 51.8               ; suggested max_accel <= 7900 mm/sec^2
#shaper_type_y: mzv


#####################################################################
#   Bed Heater
#####################################################################

##  SSR Pin - HE1
##  Thermistor - TB
[heater_bed]
heater_pin: PA2 #PA2 is LDO default
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF3
##  Adjust Max Power so your heater doesn't warp your bed. Rule of thumb is 0.4 watts / cm^2 .
max_power: 0.6
min_temp: 0
max_temp: 125
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

#####################################################################
#   Probe
#####################################################################

##  WAS TAP - NOW BEACON in CANBUS
#[probe]
#pin: ^sht:PA2
#x_offset: 0
#y_offset: 25.0
#z_offset: 0
#x_offset: 0
#y_offset: 0
#z_offset: 6.42
#speed: 5.0
#lift_speed: 15
#samples: 3
#samples_result: median
#sample_retract_dist: 2.0
#samples_tolerance: 0.01
#samples_tolerance_retries: 3
# After TAP installation, with PLA, Flow Rate 98%, 0.25mm First Layer, 0.6mm CHT nozzle, Z_Offset is z_offset = -0.450
#activate_gcode:
#    {% set PROBE_TEMP = 150 %}
#    {% set MAX_TEMP = PROBE_TEMP + 5 %}
#    {% set ACTUAL_TEMP = printer.extruder.temperature %}
#    {% set TARGET_TEMP = printer.extruder.target %}
#
#    {% if TARGET_TEMP > PROBE_TEMP %}
#        { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (TARGET_TEMP, PROBE_TEMP)) }
#        M109 S{ PROBE_TEMP }
#    {% else %}
#        # Temperature target is already low enough, but nozzle may still be too hot.
#        {% if ACTUAL_TEMP > MAX_TEMP %}
#            { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (ACTUAL_TEMP, MAX_TEMP)) }
#            TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={ MAX_TEMP }
#        {% endif %}
#    {% endif %}

#####################################################################
#  Filament Runout
#####################################################################

#[filament_motion_sensor RunoutSensor]
#detection_length: 10
#extruder: extruder
#switch_pin: ^PG11
#pause_on_runout: True
#runout_gcode:
#  M117 Filament problem, runout has paused.
#  M118 Filament problem, runout has paused.
#insert_gcode:
#event_delay:
#pause_delay:

#####################################################################
#   Additional Sensors
#####################################################################

[thermistor CMFB103F3950FANT]
temperature1: 0.0
resistance1: 32116.0
temperature2: 40.0
resistance2: 5309.0
temperature3: 80.0
resistance3: 1228.0

#[temperature_sensor sb_ambient_temp]
## Chamber Temperature - T1
#sensor_type: CMFB103F3950FANT
#sensor_pin: PF5
#min_temp: 0
#max_temp: 100
#gcode_id: chamber_th

[temperature_sensor back_chamber_temp]
## Chamber Temperature - T
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PF6
min_temp: 0
max_temp: 100
gcode_id: chamber_th2

[temperature_sensor RPi4]
sensor_type: temperature_host
min_temp: 0
max_temp: 100

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################

#[safe_z_home]
##  XY Location of the Z Endstop Switch
##  Update -10,-10 to the XY coordinates of your endstop pin 
##  (such as 157,305) after going through Z Endstop Pin
##  Location Definition step.
#home_xy_position: 147,256
#speed:100
#z_hop:10
#z_hop_speed:10


########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<5V>

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 39.889
#*# pid_ki = 0.964
#*# pid_kd = 412.851
#*#
#*# [probe]
#*# z_offset = -1.270
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.028976, -0.011641, -0.011192, -0.007565, 0.000457, 0.004071, 0.004981, 0.009279, -0.004604, 0.002922, 0.009282, 0.010141, 0.005049, 0.009922, 0.002633, 0.008268, 0.002758, 0.003390, 0.003911, 0.008404, 0.001484, 0.001595, -0.000826, -0.003303, 0.000597
#*# 	  -0.011266, -0.001049, 0.001276, 0.002603, 0.004629, 0.002230, 0.007322, 0.014805, 0.015123, 0.003135, 0.015367, 0.010843, 0.007580, 0.009236, 0.005196, 0.004266, 0.003532, 0.012965, 0.001482, 0.002597, 0.001821, 0.009963, 0.004042, 0.002023, 0.002186
#*# 	  -0.007969, -0.005147, 0.001202, -0.004696, 0.008850, 0.009805, 0.021449, 0.011158, 0.013939, 0.022819, 0.018520, 0.023105, 0.010832, 0.010694, 0.011509, 0.011375, 0.007105, 0.008049, 0.003483, 0.005307, 0.005325, 0.007873, 0.007926, 0.007313, 0.007068
#*# 	  -0.016918, -0.018347, -0.008849, -0.000695, 0.004324, 0.002863, 0.006964, 0.010845, 0.014867, 0.017813, 0.016723, 0.015870, 0.014153, 0.017062, 0.008391, 0.010954, 0.003953, 0.010081, 0.003027, 0.010253, 0.010783, 0.008835, 0.007450, 0.009387, 0.005950
#*# 	  -0.019973, -0.018867, -0.013140, -0.019214, -0.001080, -0.000138, 0.005232, 0.009150, 0.017639, 0.013650, 0.017074, 0.016696, 0.014116, 0.013393, 0.013964, 0.014675, 0.009071, 0.007066, 0.005467, 0.005928, 0.005801, 0.006088, 0.009561, 0.008105, 0.003587
#*# 	  -0.022558, -0.021645, -0.018157, -0.005353, -0.011070, 0.000724, 0.001546, 0.015318, 0.015809, 0.015656, 0.019969, 0.015824, 0.019681, 0.013279, 0.009213, 0.006110, 0.005243, 0.007173, 0.005510, 0.005973, 0.000793, 0.002683, 0.004695, 0.004638, 0.006172
#*# 	  -0.038898, -0.020838, -0.021861, -0.019547, -0.014640, -0.005651, 0.000870, 0.010613, 0.013255, 0.010102, 0.012446, 0.015680, 0.012348, 0.015265, 0.008622, 0.010266, 0.007629, 0.003534, 0.001843, 0.004914, 0.003045, 0.002868, 0.000220, 0.001799, 0.000931
#*# 	  -0.023507, -0.024722, -0.024409, -0.024042, -0.006963, -0.002900, -0.000687, 0.000670, 0.011769, 0.013729, 0.016249, 0.018271, 0.015225, 0.013943, 0.008016, 0.014581, 0.013165, 0.003512, 0.001329, 0.004435, 0.002887, 0.002493, 0.002066, 0.001564, 0.000592
#*# 	  -0.022336, -0.020694, -0.017708, -0.007901, -0.007082, -0.003111, 0.000973, 0.007205, 0.018277, 0.011690, 0.010013, 0.010904, 0.008818, 0.011831, 0.001783, 0.007315, 0.001924, 0.004188, 0.003069, 0.003752, 0.003014, 0.002692, 0.002754, 0.003271, 0.004592
#*# 	  -0.017792, -0.007398, -0.006641, -0.002984, -0.001562, -0.003930, 0.001933, 0.001367, 0.002610, 0.015275, 0.009968, 0.015096, 0.012033, 0.012461, 0.015313, 0.017353, 0.010413, 0.002373, 0.005845, 0.003495, 0.007590, 0.003354, 0.002095, 0.002150, 0.000591
#*# 	  -0.007870, -0.002940, -0.006646, -0.002785, -0.000650, 0.001743, 0.004525, 0.018501, 0.013985, 0.016881, 0.014747, 0.019633, 0.019281, 0.018808, 0.013129, 0.017829, 0.003490, 0.001610, 0.002379, 0.009057, 0.004050, 0.003354, 0.002342, 0.002687, 0.002489
#*# 	  -0.009190, -0.001336, 0.002858, 0.001580, 0.001993, 0.002969, 0.003162, 0.010584, 0.012545, 0.021089, 0.015091, 0.020658, 0.021814, 0.020928, 0.015887, 0.015765, 0.015877, 0.018006, 0.021480, 0.007118, 0.014457, 0.003379, 0.007907, 0.002770, 0.001491
#*# 	  -0.002295, -0.002079, 0.001404, 0.002866, 0.001691, 0.008356, 0.003484, 0.012114, 0.018042, 0.018425, 0.019053, 0.017069, 0.021001, 0.016230, 0.020516, 0.010021, 0.006621, 0.010923, 0.012468, 0.009123, 0.003113, 0.008088, 0.015996, 0.011461, 0.004038
#*# 	  -0.004411, -0.000352, -0.000015, -0.000545, 0.000270, 0.006287, 0.007490, 0.006145, 0.011233, 0.018295, 0.006898, 0.012791, 0.019654, 0.013659, 0.016490, 0.004549, 0.008879, 0.007939, 0.003895, 0.008430, 0.003623, 0.006254, 0.006621, 0.003691, 0.001985
#*# 	  -0.014961, -0.001630, 0.000147, 0.000559, 0.000789, -0.000570, 0.001541, 0.007705, 0.007670, 0.008348, 0.014849, 0.010284, 0.014765, 0.009328, 0.009520, 0.013949, 0.009021, 0.005464, 0.008568, 0.007920, 0.009214, 0.004176, 0.008722, 0.012126, 0.009422
#*# 	  -0.004046, -0.010866, 0.000363, 0.000558, 0.001741, 0.002158, 0.001157, 0.006430, 0.003484, 0.005434, 0.009650, 0.006559, 0.011476, 0.012698, 0.022951, 0.014374, 0.001959, 0.014700, 0.007401, 0.003758, 0.020770, 0.012791, 0.022896, 0.006638, 0.008807
#*# 	  0.000704, 0.001959, 0.002053, 0.001996, 0.000424, 0.002469, 0.007319, 0.002999, 0.010238, 0.009049, 0.012748, 0.018028, 0.024223, 0.019965, 0.019688, 0.020965, 0.024993, 0.024643, 0.024840, 0.015256, 0.020131, 0.025204, 0.023861, 0.025496, 0.024255
#*# 	  0.002063, 0.003314, 0.002627, 0.005118, 0.007666, 0.005465, 0.007755, 0.007665, 0.022939, 0.024506, 0.017412, 0.018878, 0.025643, 0.025501, 0.025110, 0.018249, 0.021225, 0.024718, 0.026015, 0.025918, 0.026542, 0.025098, 0.025154, 0.026291, 0.025032
#*# 	  0.000027, 0.004065, 0.001954, 0.009167, 0.009110, 0.007367, 0.008642, 0.011236, 0.014901, 0.022390, 0.007583, 0.020533, 0.024898, 0.026331, 0.026127, 0.025124, 0.017159, 0.019653, 0.024236, 0.025848, 0.025710, 0.027000, 0.026678, 0.026957, 0.026592
#*# 	  0.001465, 0.001505, 0.002123, 0.004703, 0.004787, 0.004736, 0.006952, 0.010060, 0.012269, 0.013222, 0.018407, 0.022002, 0.024211, 0.013001, 0.013739, 0.022715, 0.024418, 0.023913, 0.015175, 0.021553, 0.025969, 0.025709, 0.026702, 0.027152, 0.014891
#*# 	  0.000622, 0.002275, 0.002439, 0.002412, 0.006726, 0.003313, 0.009562, 0.006625, 0.008806, 0.009117, 0.013017, 0.020864, 0.021479, 0.004978, 0.026334, 0.022519, 0.025495, 0.026401, 0.026194, 0.011232, 0.020711, 0.024275, 0.026035, 0.027141, 0.024928
#*# 	  -0.000989, 0.003427, 0.001715, 0.001924, 0.004446, 0.005427, 0.010836, 0.007066, 0.009371, 0.009608, 0.009841, 0.015097, 0.011899, 0.010701, 0.014164, 0.007676, 0.013432, 0.024361, 0.026139, 0.012902, 0.005152, 0.014214, 0.026536, 0.025166, 0.027576
#*# 	  -0.003321, 0.002307, 0.002814, 0.004236, 0.008560, 0.007849, 0.010323, 0.011118, 0.009462, 0.008168, 0.011872, 0.014169, 0.010212, 0.013789, 0.026345, 0.026022, 0.015428, 0.026680, 0.020130, 0.026725, 0.021613, 0.023691, 0.024421, 0.025891, 0.025575
#*# 	  0.001401, 0.003178, 0.001740, 0.002997, 0.007622, 0.008492, 0.009635, 0.009817, 0.010154, 0.011684, 0.009423, 0.007709, 0.008373, 0.016110, 0.009554, 0.014707, 0.013592, 0.019387, 0.015637, 0.026986, 0.015316, 0.023566, 0.017799, 0.022629, 0.027108
#*# 	  -0.004700, -0.003536, -0.000603, 0.001575, 0.002762, 0.002737, 0.004429, 0.004444, 0.007347, 0.010555, 0.007801, 0.007879, 0.008822, 0.008790, 0.007229, 0.008452, 0.011518, 0.006226, 0.008814, 0.008534, 0.011870, 0.012292, 0.012089, 0.017516, 0.014049
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 210.0
#*# min_y = 30.0
#*# max_y = 210.0
#*#
#*# [beacon model default]
#*# model_coef = 1.9257982386737142,
#*# 	  2.1904011986275074,
#*# 	  0.5881661108028357,
#*# 	  0.30341866940870527,
#*# 	  0.14823890288711727,
#*# 	  -0.42807822476666274,
#*# 	  -0.13716254071061182,
#*# 	  0.612855529187592,
#*# 	  0.08376843001203003,
#*# 	  -0.2664564217100284
#*# model_domain = 3.352922478536077e-07,3.360945745364866e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 72.578002
#*# model_offset = -0.29500
#*#
#*# [input_shaper]
#*# shaper_type_x = zv
#*# shaper_freq_x = 77.4
#*# shaper_type_y = mzv
#*# shaper_freq_y = 51.6
