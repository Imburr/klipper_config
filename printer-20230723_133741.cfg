##########################
##### BASE CONFIG #######
##########################

[include mainsail.cfg]
[include ./backup/backup.cfg]

##########################
##### HARDWARE STUFF #####
##########################

[include ./hardware/xyz-stepper.cfg]
[include ./hardware/extruder.cfg]
#[include ./klicky/klicky-probe.cfg]
#[include ./hardware/adxl345.cfg]  This config now in canbus.cfg
[include ./hardware/fans.cfg] # Some fans config in canbus.cfg
[include ./hardware/canbus.cfg]

##########################
##### LIGHTS #############
##########################

[include ./hardware/chamber-lighting.cfg]
[include ./hardware/stealthburner-led.cfg]

##########################
##### CALIBRATION ########
##########################

[include ./calibration/z-tilt.cfg]
[include ./calibration/bed-mesh.cfg]
[include ./macros/unsafe.cfg]
[include ./calibration/pressure_advance.cfg]
[include test_probe_accuracy.cfg]

##########################
##### MACROS #############
##########################

[include ./macros/chamber-led.cfg]
[include ./macros/conditional-homing.cfg]
[include ./macros/print-end.cfg]
[include ./macros/print-start-mmu.cfg]
[include ./macros/dump-variables.cfg]
[include ./macros/movement-check.cfg]
[include ./macros/cancel-change.cfg]
[include ./macros/pause-resume.cfg]         ; Overridden by ERCF / subsequantly disabled
[include ./macros/load-unload.cfg]
[include ./macros/filament-change.cfg]
[include ./macros/park.cfg]
#[include ./macros/prusaslicer-accel.cfg]

##########################
##### THIRD PARTY ########
##########################

[include ./third-party-cfg/nozzle_scrub.cfg]
[include ./kamp/Adaptive_Mesh.cfg]
[include ./kamp/Adaptive_Purge.cfg]

##########################
##### ERCF ###############
##########################


[include ercf_hardware.cfg]
[include ercf_parameters.cfg]
[include ercf_software.cfg]
[include ./calibration/ercf_additional.cfg]
#[include ercf_vars.cfg]
[include client_macros.cfg]

##########################
##### LCD/MENU ###########
##########################

#[include ./third-party-cfg/nozzle_scrub_menu.cfg]
#[include ercf_menu.cfg]
#[include ./menu/printer_menu.cfg]

##########################
##### NOT ENABLED YET ####
##########################

#[include ./todo/mini12864.cfg] Add this after adding mini12864 LED
#[include ./todo/lcd_tweaks.cfg] Need to figure this one out and then implement
#[include ./hardware/nevermore.cfg] Disabled as I prefer to chamber vent outside and needed the PWM

##########################
#### REPLACEMENT #########
##########################

[include ./replacement_macros/replace-m900.cfg]
[include ./replacement_macros/replace-m117.cfg]

[exclude_object]

[gcode_arcs]
resolution: 0.1

[respond]
default_type: echo
default_prefix:  

[force_move]
# Enable commands that force potentially unsafe movement
enable_force_move: True

[idle_timeout]
timeout: 14400

[mcu]
##  Obtain definition by "ls -l /dev/serial/by-id/" then unplug to verify
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_290040000750314D35323820-if00
restart_method: command

[mcu rpi]
# Add Rpi as secondary MCU to allow for ADXL use through SPI ribbon/adapter from LDO
serial: /tmp/klipper_host_mcu

[mcu sht]
canbus_uuid: 30993412e8e0

[printer]
kinematics: corexy
max_velocity: 600           # Changed from 200 on 7.11.23
max_accel:  6000            # tuned on 7.11.23 after beacon install.
max_z_velocity: 15          #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 350
square_corner_velocity: 8.0 # Changed on 7.11.23

#####################################################################
#   Input Shaper
#####################################################################

[input_shaper]
shaper_freq_x: 76.2               ; suggested max_accel <= 22600 mm/sec^2
shaper_type_x: zv
shaper_freq_y: 51.8               ; suggested max_accel <= 7900 mm/sec^2
shaper_type_y: mzv


#####################################################################
#   Bed Heater
#####################################################################

##  SSR Pin - HE1
##  Thermistor - TB
[heater_bed]
heater_pin: PA2 #PA2 is LDO default
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF3
##  Adjust Max Power so your heater doesn't warp your bed. Rule of thumb is 0.4 watts / cm^2 .
max_power: 0.6
min_temp: 0
max_temp: 125
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

#####################################################################
#   Probe
#####################################################################

##  WAS TAP - NOW BEACON in CANBUS
#[probe]
#pin: ^sht:PA2
#x_offset: 0
#y_offset: 25.0
#z_offset: 0
#x_offset: 0
#y_offset: 0
#z_offset: 6.42
#speed: 5.0
#lift_speed: 15
#samples: 3
#samples_result: median
#sample_retract_dist: 2.0
#samples_tolerance: 0.01
#samples_tolerance_retries: 3
# After TAP installation, with PLA, Flow Rate 98%, 0.25mm First Layer, 0.6mm CHT nozzle, Z_Offset is z_offset = -0.450
#activate_gcode:
#    {% set PROBE_TEMP = 150 %}
#    {% set MAX_TEMP = PROBE_TEMP + 5 %}
#    {% set ACTUAL_TEMP = printer.extruder.temperature %}
#    {% set TARGET_TEMP = printer.extruder.target %}
#
#    {% if TARGET_TEMP > PROBE_TEMP %}
#        { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (TARGET_TEMP, PROBE_TEMP)) }
#        M109 S{ PROBE_TEMP }
#    {% else %}
#        # Temperature target is already low enough, but nozzle may still be too hot.
#        {% if ACTUAL_TEMP > MAX_TEMP %}
#            { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (ACTUAL_TEMP, MAX_TEMP)) }
#            TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={ MAX_TEMP }
#        {% endif %}
#    {% endif %}

#####################################################################
#  Filament Runout
#####################################################################

#[filament_motion_sensor RunoutSensor]
#detection_length: 10
#extruder: extruder
#switch_pin: ^PG11
#pause_on_runout: True
#runout_gcode:
#  M117 Filament problem, runout has paused.
#  M118 Filament problem, runout has paused.
#insert_gcode:
#event_delay:
#pause_delay:

#####################################################################
#   Additional Sensors
#####################################################################

[thermistor CMFB103F3950FANT]
temperature1: 0.0
resistance1: 32116.0
temperature2: 40.0
resistance2: 5309.0
temperature3: 80.0
resistance3: 1228.0

#[temperature_sensor sb_ambient_temp]
## Chamber Temperature - T1
#sensor_type: CMFB103F3950FANT
#sensor_pin: PF5
#min_temp: 0
#max_temp: 100
#gcode_id: chamber_th

[temperature_sensor back_chamber_temp]
## Chamber Temperature - T
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PF6
min_temp: 0
max_temp: 100
gcode_id: chamber_th2

[temperature_sensor RPi4]
sensor_type: temperature_host
min_temp: 0
max_temp: 100

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################

#[safe_z_home]
##  XY Location of the Z Endstop Switch
##  Update -10,-10 to the XY coordinates of your endstop pin 
##  (such as 157,305) after going through Z Endstop Pin
##  Location Definition step.
#home_xy_position: 147,256
#speed:100
#z_hop:10
#z_hop_speed:10


########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<5V>

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 39.889
#*# pid_ki = 0.964
#*# pid_kd = 412.851
#*#
#*# [probe]
#*# z_offset = -1.270
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.062154, -0.049672, -0.048842, -0.037604, -0.036039, -0.036009, -0.039409, -0.032521, -0.035879, -0.035641, -0.027890, -0.035480, -0.025525, -0.023666, -0.034623, -0.038586, -0.042693, -0.048516, -0.037418, -0.038480, -0.035536, -0.035554, -0.044334, -0.036887, -0.038506
#*# 	  -0.052184, -0.043079, -0.039449, -0.030790, -0.030169, -0.034491, -0.030382, -0.022995, -0.024057, -0.024789, -0.024428, -0.026040, -0.024577, -0.025320, -0.029617, -0.033328, -0.028736, -0.033329, -0.033574, -0.033294, -0.031149, -0.041474, -0.024426, -0.032504, -0.034285
#*# 	  -0.052943, -0.044111, -0.041262, -0.037439, -0.036943, -0.027739, -0.024475, -0.024988, -0.018275, -0.018718, -0.024740, -0.015565, -0.011994, -0.012571, -0.019639, -0.024677, -0.025293, -0.029702, -0.030679, -0.026866, -0.034027, -0.025849, -0.031073, -0.025343, -0.025153
#*# 	  -0.058787, -0.051354, -0.040193, -0.033734, -0.042809, -0.033414, -0.030324, -0.025575, -0.023207, -0.021515, -0.017707, -0.021405, -0.012002, -0.017553, -0.020427, -0.020279, -0.027080, -0.024671, -0.025656, -0.025072, -0.025997, -0.026217, -0.028901, -0.026444, -0.025691
#*# 	  -0.055855, -0.052696, -0.051807, -0.044150, -0.044205, -0.030755, -0.031101, -0.022007, -0.016584, -0.018744, -0.023239, -0.016735, -0.014884, -0.011304, -0.024679, -0.019393, -0.021354, -0.027193, -0.022579, -0.027218, -0.018933, -0.024712, -0.026023, -0.020943, -0.022945
#*# 	  -0.056245, -0.051104, -0.045557, -0.046068, -0.041928, -0.030308, -0.026394, -0.022244, -0.007515, -0.024750, -0.017313, -0.011218, -0.006926, -0.007580, -0.018959, -0.020901, -0.022157, -0.017377, -0.024258, -0.027600, -0.015316, -0.016780, -0.020222, -0.025002, -0.021915
#*# 	  -0.056616, -0.053987, -0.049249, -0.044875, -0.046573, -0.032063, -0.028131, -0.019871, -0.008392, -0.019943, -0.008852, -0.006159, -0.016251, -0.017286, -0.021187, -0.020431, -0.007193, -0.013777, -0.009702, -0.011364, -0.009717, -0.010887, -0.015961, -0.022474, -0.022471
#*# 	  -0.054514, -0.052659, -0.047891, -0.044524, -0.046295, -0.030406, -0.030564, -0.023592, -0.009839, -0.006984, -0.006875, -0.004820, -0.007511, -0.011672, -0.007684, -0.011555, -0.005320, -0.011310, -0.012262, -0.006575, -0.021643, -0.016715, -0.009393, -0.018513, -0.024537
#*# 	  -0.054271, -0.047770, -0.032201, -0.052009, -0.040051, -0.031791, -0.029896, -0.021973, -0.009698, -0.012477, -0.008214, -0.010324, -0.006888, -0.007035, -0.006096, -0.010969, -0.017998, -0.004925, -0.018217, -0.006918, -0.020144, -0.016112, -0.009362, -0.018197, -0.019572
#*# 	  -0.039445, -0.032706, -0.031133, -0.031810, -0.028908, -0.029322, -0.024028, -0.012956, -0.030426, -0.007343, -0.005496, -0.011891, -0.006687, -0.005557, -0.005728, -0.007552, -0.011278, -0.007449, -0.006423, -0.006354, -0.012518, -0.007066, -0.022450, -0.012719, -0.017833
#*# 	  -0.031281, -0.032005, -0.028882, -0.025953, -0.019614, -0.023594, -0.026123, -0.008767, -0.012191, -0.003436, -0.004720, -0.004853, 0.000282, -0.005357, -0.005772, -0.004933, -0.006323, -0.006193, -0.012593, -0.007148, -0.007114, -0.018245, -0.005896, -0.007366, -0.008260
#*# 	  -0.031241, -0.014976, -0.028162, -0.017970, -0.016930, -0.018020, -0.008125, -0.008366, -0.006113, 0.002880, -0.004531, -0.005075, -0.002331, -0.005138, -0.002871, -0.005299, -0.005912, -0.007337, -0.006100, -0.003863, -0.005150, -0.006707, -0.004848, -0.006720, -0.007061
#*# 	  -0.034664, -0.027934, -0.019397, -0.011021, -0.015231, -0.028929, -0.011052, -0.007242, -0.007590, -0.002413, -0.003876, 0.001372, 0.000000, -0.005478, -0.002734, -0.004289, -0.005618, -0.005028, -0.007086, -0.005912, -0.007108, -0.005896, -0.006917, -0.006470, -0.009338
#*# 	  -0.031090, -0.028700, -0.014875, -0.021433, -0.021285, -0.018140, -0.006389, -0.008107, -0.009692, -0.005669, -0.005604, -0.005353, -0.002611, -0.004452, -0.002242, -0.005251, -0.005300, -0.005199, -0.006593, -0.005626, -0.007436, -0.005220, -0.004424, -0.005084, -0.006597
#*# 	  -0.030978, -0.029367, -0.023367, -0.025019, -0.016414, -0.008666, -0.006335, -0.006034, -0.007439, -0.006014, -0.006673, -0.008528, -0.006711, -0.006815, -0.003962, -0.005560, -0.004117, -0.009640, -0.005910, -0.005459, -0.006103, -0.005370, -0.004785, -0.005464, -0.004837
#*# 	  -0.031168, -0.022622, -0.022266, -0.018620, -0.017848, -0.016522, -0.013713, -0.015061, -0.005295, -0.005707, -0.005566, -0.008736, -0.006086, -0.005153, -0.004826, -0.005276, -0.006388, -0.005071, -0.005454, -0.005518, -0.004511, -0.002015, 0.003043, -0.003771, -0.005149
#*# 	  -0.030021, -0.025456, -0.017919, -0.023040, -0.022533, -0.006992, -0.026575, -0.005805, -0.005548, -0.005130, -0.004256, -0.004099, -0.002982, -0.001045, 0.002700, -0.000704, 0.005945, -0.001148, -0.000186, -0.001780, -0.003173, 0.000751, 0.003274, 0.014607, 0.006459
#*# 	  -0.023981, -0.016493, -0.022643, -0.009621, -0.021281, -0.022427, -0.004537, -0.006398, -0.003947, -0.004753, -0.002889, 0.002253, -0.003113, -0.000793, -0.001050, -0.001742, -0.004202, 0.005203, 0.002242, 0.008164, 0.008262, 0.004959, 0.016980, 0.014137, 0.000153
#*# 	  -0.028273, -0.013757, -0.017345, -0.022063, -0.005904, -0.009474, -0.007799, -0.017153, -0.007273, -0.006668, -0.004952, -0.004906, -0.003754, 0.000482, -0.001748, -0.004933, 0.007171, 0.001243, 0.000503, 0.007885, -0.004491, 0.017702, 0.018062, 0.003293, 0.018188
#*# 	  -0.029036, -0.028132, -0.022817, -0.021463, -0.019923, -0.020595, -0.020295, -0.008098, -0.010441, -0.006027, -0.006565, -0.004600, -0.003973, 0.000052, -0.000343, -0.001210, -0.002993, -0.004237, 0.008117, 0.001140, 0.009269, -0.003853, -0.002171, 0.008481, 0.009094
#*# 	  -0.035385, -0.030890, -0.022558, -0.022511, -0.019434, -0.024444, -0.020593, -0.005877, -0.004209, -0.004106, -0.023342, -0.005901, -0.004809, -0.002895, -0.004535, -0.004753, -0.002775, -0.001082, -0.000258, -0.001614, -0.000640, -0.002216, -0.000788, 0.008093, 0.008873
#*# 	  -0.030710, -0.028726, -0.026615, -0.026225, -0.028739, -0.025323, -0.014129, -0.007334, -0.013521, -0.007475, -0.016990, -0.014519, -0.005708, -0.004698, -0.003806, -0.004662, -0.003627, -0.004667, -0.002573, -0.005234, -0.004735, 0.002372, 0.003394, 0.004487, 0.000303
#*# 	  -0.032949, -0.031238, -0.028691, -0.025646, -0.020468, -0.023618, -0.024960, -0.027360, -0.022624, -0.005672, -0.026423, -0.007981, -0.007715, -0.004147, -0.004318, -0.004547, -0.006359, -0.003971, -0.000243, 0.003202, -0.004221, 0.003019, -0.004512, 0.003275, 0.003461
#*# 	  -0.041981, -0.031284, -0.028986, -0.028936, -0.025823, -0.022843, -0.026422, -0.024178, -0.014224, -0.014603, -0.018626, -0.009520, -0.005481, -0.008210, -0.006431, -0.005868, -0.004739, -0.004006, -0.004960, -0.003958, -0.003971, -0.001513, -0.002350, -0.004433, -0.003935
#*# 	  -0.039957, -0.033504, -0.030519, -0.032610, -0.029542, -0.029603, -0.023860, -0.019401, -0.023115, -0.023002, -0.022766, -0.022957, -0.022245, -0.021339, -0.011688, -0.020046, -0.028831, -0.025120, -0.020252, -0.013627, -0.017788, -0.021940, -0.005890, -0.004841, -0.005491
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 210.0
#*# min_y = 32.265
#*# max_y = 210.0
#*#
#*# [beacon model default]
#*# model_coef = 1.9257982386737142,
#*# 	  2.1904011986275074,
#*# 	  0.5881661108028357,
#*# 	  0.30341866940870527,
#*# 	  0.14823890288711727,
#*# 	  -0.42807822476666274,
#*# 	  -0.13716254071061182,
#*# 	  0.612855529187592,
#*# 	  0.08376843001203003,
#*# 	  -0.2664564217100284
#*# model_domain = 3.352922478536077e-07,3.360945745364866e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 72.578002
#*# model_offset = -0.18000
