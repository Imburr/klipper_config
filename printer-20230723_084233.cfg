##########################
##### BASE CONFIG #######
##########################

[include mainsail.cfg]
[include ./backup/backup.cfg]

##########################
##### HARDWARE STUFF #####
##########################

[include ./hardware/xyz-stepper.cfg]
[include ./hardware/extruder.cfg]
#[include ./klicky/klicky-probe.cfg]
#[include ./hardware/adxl345.cfg]  This config now in canbus.cfg
[include ./hardware/fans.cfg] # Some fans config in canbus.cfg
[include ./hardware/canbus.cfg]

##########################
##### LIGHTS #############
##########################

[include ./hardware/chamber-lighting.cfg]
[include ./hardware/stealthburner-led.cfg]

##########################
##### CALIBRATION ########
##########################

[include ./calibration/z-tilt.cfg]
[include ./calibration/bed-mesh.cfg]
[include ./macros/unsafe.cfg]
[include ./calibration/pressure_advance.cfg]
[include test_probe_accuracy.cfg]

##########################
##### MACROS #############
##########################

[include ./macros/chamber-led.cfg]
[include ./macros/conditional-homing.cfg]
[include ./macros/print-end.cfg]
[include ./macros/print-start-mmu.cfg]
[include ./macros/dump-variables.cfg]
[include ./macros/movement-check.cfg]
[include ./macros/cancel-change.cfg]
[include ./macros/pause-resume.cfg]         ; Overridden by ERCF / subsequantly disabled
[include ./macros/load-unload.cfg]
[include ./macros/filament-change.cfg]
[include ./macros/park.cfg]
#[include ./macros/prusaslicer-accel.cfg]

##########################
##### THIRD PARTY ########
##########################

[include ./third-party-cfg/nozzle_scrub.cfg]
[include ./kamp/Adaptive_Mesh.cfg]
[include ./kamp/Adaptive_Purge.cfg]

##########################
##### ERCF ###############
##########################


[include ercf_hardware.cfg]
[include ercf_parameters.cfg]
[include ercf_software.cfg]
[include ./calibration/ercf_additional.cfg]
#[include ercf_vars.cfg]
[include client_macros.cfg]

##########################
##### LCD/MENU ###########
##########################

#[include ./third-party-cfg/nozzle_scrub_menu.cfg]
#[include ercf_menu.cfg]
#[include ./menu/printer_menu.cfg]

##########################
##### NOT ENABLED YET ####
##########################

#[include ./todo/mini12864.cfg] Add this after adding mini12864 LED
#[include ./todo/lcd_tweaks.cfg] Need to figure this one out and then implement
#[include ./hardware/nevermore.cfg] Disabled as I prefer to chamber vent outside and needed the PWM

##########################
#### REPLACEMENT #########
##########################

[include ./replacement_macros/replace-m900.cfg]
[include ./replacement_macros/replace-m117.cfg]

[exclude_object]

[gcode_arcs]
resolution: 0.1

[respond]
default_type: echo
default_prefix:  

[force_move]
# Enable commands that force potentially unsafe movement
enable_force_move: True

[idle_timeout]
timeout: 14400

[mcu]
##  Obtain definition by "ls -l /dev/serial/by-id/" then unplug to verify
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_290040000750314D35323820-if00
restart_method: command

[mcu rpi]
# Add Rpi as secondary MCU to allow for ADXL use through SPI ribbon/adapter from LDO
serial: /tmp/klipper_host_mcu

[mcu sht]
canbus_uuid: 30993412e8e0

[printer]
kinematics: corexy
max_velocity: 600           # Changed from 200 on 7.11.23
max_accel:  6000            # tuned on 7.11.23 after beacon install.
max_z_velocity: 15          #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 350
square_corner_velocity: 8.0 # Changed on 7.11.23

#####################################################################
#   Input Shaper
#####################################################################

[input_shaper]
shaper_freq_x: 76.2               ; suggested max_accel <= 22600 mm/sec^2
shaper_type_x: zv
shaper_freq_y: 51.8               ; suggested max_accel <= 7900 mm/sec^2
shaper_type_y: mzv


#####################################################################
#   Bed Heater
#####################################################################

##  SSR Pin - HE1
##  Thermistor - TB
[heater_bed]
heater_pin: PA2 #PA2 is LDO default
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF3
##  Adjust Max Power so your heater doesn't warp your bed. Rule of thumb is 0.4 watts / cm^2 .
max_power: 0.6
min_temp: 0
max_temp: 125
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

#####################################################################
#   Probe
#####################################################################

##  WAS TAP - NOW BEACON in CANBUS
#[probe]
#pin: ^sht:PA2
#x_offset: 0
#y_offset: 25.0
#z_offset: 0
#x_offset: 0
#y_offset: 0
#z_offset: 6.42
#speed: 5.0
#lift_speed: 15
#samples: 3
#samples_result: median
#sample_retract_dist: 2.0
#samples_tolerance: 0.01
#samples_tolerance_retries: 3
# After TAP installation, with PLA, Flow Rate 98%, 0.25mm First Layer, 0.6mm CHT nozzle, Z_Offset is z_offset = -0.450
#activate_gcode:
#    {% set PROBE_TEMP = 150 %}
#    {% set MAX_TEMP = PROBE_TEMP + 5 %}
#    {% set ACTUAL_TEMP = printer.extruder.temperature %}
#    {% set TARGET_TEMP = printer.extruder.target %}
#
#    {% if TARGET_TEMP > PROBE_TEMP %}
#        { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (TARGET_TEMP, PROBE_TEMP)) }
#        M109 S{ PROBE_TEMP }
#    {% else %}
#        # Temperature target is already low enough, but nozzle may still be too hot.
#        {% if ACTUAL_TEMP > MAX_TEMP %}
#            { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (ACTUAL_TEMP, MAX_TEMP)) }
#            TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={ MAX_TEMP }
#        {% endif %}
#    {% endif %}

#####################################################################
#  Filament Runout
#####################################################################

#[filament_motion_sensor RunoutSensor]
#detection_length: 10
#extruder: extruder
#switch_pin: ^PG11
#pause_on_runout: True
#runout_gcode:
#  M117 Filament problem, runout has paused.
#  M118 Filament problem, runout has paused.
#insert_gcode:
#event_delay:
#pause_delay:

#####################################################################
#   Additional Sensors
#####################################################################

[thermistor CMFB103F3950FANT]
temperature1: 0.0
resistance1: 32116.0
temperature2: 40.0
resistance2: 5309.0
temperature3: 80.0
resistance3: 1228.0

#[temperature_sensor sb_ambient_temp]
## Chamber Temperature - T1
#sensor_type: CMFB103F3950FANT
#sensor_pin: PF5
#min_temp: 0
#max_temp: 100
#gcode_id: chamber_th

[temperature_sensor back_chamber_temp]
## Chamber Temperature - T
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PF6
min_temp: 0
max_temp: 100
gcode_id: chamber_th2

[temperature_sensor RPi4]
sensor_type: temperature_host
min_temp: 0
max_temp: 100

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################

#[safe_z_home]
##  XY Location of the Z Endstop Switch
##  Update -10,-10 to the XY coordinates of your endstop pin 
##  (such as 157,305) after going through Z Endstop Pin
##  Location Definition step.
#home_xy_position: 147,256
#speed:100
#z_hop:10
#z_hop_speed:10


########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<5V>

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 39.889
#*# pid_ki = 0.964
#*# pid_kd = 412.851
#*#
#*# [probe]
#*# z_offset = -1.270
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.029291, -0.025691, -0.024844, -0.018655, -0.010117, -0.012193, -0.004045, 0.001307, 0.000739, 0.000497, -0.005548, 0.001432, -0.001726, -0.019914, -0.000108, 0.000116, -0.012507, 0.000274, -0.018288, 0.000045, -0.015359, -0.005354, -0.009246
#*# 	  -0.032242, -0.023621, -0.026155, -0.021346, -0.010646, -0.010475, -0.008496, 0.001683, 0.001708, 0.002801, 0.002831, -0.001423, -0.004594, 0.000938, 0.001668, -0.008444, -0.007522, -0.008978, -0.001174, -0.014981, -0.012299, -0.020458, -0.009556
#*# 	  -0.041109, -0.024508, -0.027987, -0.021297, -0.007019, 0.001944, 0.001811, 0.002150, 0.000904, 0.001114, 0.001185, 0.001420, 0.000575, -0.010060, 0.002345, 0.001589, -0.005478, 0.001880, -0.012068, -0.018068, -0.008782, -0.013685, -0.008991
#*# 	  -0.037896, -0.024975, -0.022518, -0.018815, -0.006685, -0.015840, -0.002443, 0.002857, 0.002548, 0.002197, 0.001371, 0.000176, -0.003882, -0.007261, 0.000825, 0.000611, -0.011141, -0.006334, -0.004204, -0.015042, -0.018116, -0.019039, -0.016908
#*# 	  -0.030831, -0.025109, -0.026075, -0.011779, -0.006726, 0.001241, -0.007053, -0.003236, 0.001377, 0.000207, 0.002820, 0.001184, -0.008804, -0.003749, -0.001150, -0.015366, -0.012312, -0.016728, -0.004710, -0.016352, -0.012249, -0.013360, -0.024212
#*# 	  -0.017494, -0.019476, -0.019740, -0.006454, -0.010549, 0.001434, -0.002759, 0.002935, 0.000273, 0.002165, 0.000485, 0.001503, 0.001740, -0.001808, -0.019911, -0.000352, -0.006678, -0.005984, -0.019766, -0.014120, -0.016721, -0.015715, -0.020697
#*# 	  -0.015725, -0.012643, -0.005162, -0.012533, -0.005557, 0.000597, 0.001082, 0.002271, 0.002697, 0.002246, 0.002089, -0.000962, -0.003051, -0.010685, -0.006013, -0.019446, -0.015863, -0.009796, -0.015892, -0.015071, -0.016649, -0.018363, -0.024198
#*# 	  -0.005536, -0.002310, -0.000360, -0.000891, 0.002753, 0.006028, 0.004898, 0.004252, 0.005870, 0.004749, 0.005513, 0.000495, 0.001910, 0.002599, 0.000293, -0.004710, -0.012744, -0.001465, -0.010152, -0.011631, -0.018901, -0.014268, -0.022606
#*# 	  0.000524, 0.000334, 0.000577, 0.001897, 0.002436, 0.003184, 0.006220, 0.005239, 0.006013, 0.007443, 0.006355, 0.003839, 0.002698, -0.001516, 0.001850, 0.002090, 0.001520, -0.003145, -0.010922, -0.014827, -0.014483, -0.020750, -0.015167
#*# 	  0.000000, -0.000355, -0.002507, 0.002077, 0.005258, 0.004320, 0.004406, 0.004294, 0.003317, 0.002253, 0.002409, 0.002321, -0.003600, 0.002330, 0.001606, -0.002090, -0.006310, -0.012120, -0.013219, -0.013295, -0.014834, -0.020282, -0.020902
#*# 	  0.000609, 0.001363, 0.001135, 0.002285, -0.002270, -0.003445, -0.000458, 0.000758, 0.001196, 0.000905, 0.002319, 0.001690, -0.006984, 0.002017, -0.002358, -0.008085, -0.012524, -0.014315, -0.015782, -0.017748, -0.014980, -0.014947, -0.019897
#*# 	  -0.002532, -0.002714, 0.001717, 0.000191, 0.002907, 0.001901, 0.002163, 0.004949, 0.002638, 0.000112, 0.001831, 0.001228, 0.001603, 0.004720, -0.000184, -0.008991, -0.018845, -0.008237, -0.010352, -0.013200, -0.015548, -0.009385, -0.016314
#*# 	  0.005483, 0.004863, 0.004599, 0.002281, 0.004305, 0.004711, 0.003461, 0.006048, 0.005036, 0.006239, 0.004813, 0.001494, 0.003214, 0.001031, 0.000066, -0.009717, -0.016523, -0.009874, -0.015342, -0.018333, -0.016106, -0.009248, -0.015018
#*# 	  0.007321, 0.010032, 0.004389, 0.006658, 0.009810, 0.006119, 0.003518, 0.008869, 0.005708, 0.004399, 0.003724, 0.005557, 0.007153, 0.001560, 0.000030, 0.001742, -0.009892, -0.003082, -0.003162, -0.002851, -0.000715, -0.002514, 0.000753
#*# 	  0.008753, 0.011442, 0.013291, 0.014982, 0.010925, 0.005243, 0.007192, 0.005664, 0.008633, 0.009632, 0.008589, 0.006497, 0.003013, 0.002703, 0.001683, -0.000635, -0.000952, -0.002363, -0.001989, -0.000173, 0.001563, 0.001996, 0.001346
#*# 	  0.008475, 0.012150, 0.004619, 0.005056, 0.006507, 0.010248, 0.004147, 0.003515, 0.007813, 0.006116, 0.003258, 0.008208, 0.002894, 0.001589, -0.004223, -0.004781, -0.003736, -0.001968, -0.008344, -0.021893, 0.000613, -0.001842, -0.009893
#*# 	  0.008630, 0.006270, 0.014642, 0.004298, 0.010852, 0.002521, 0.011887, 0.009301, 0.010526, 0.009401, 0.005139, 0.008623, 0.005315, -0.006207, 0.002756, -0.001733, -0.002613, -0.008398, -0.014397, -0.007155, -0.010038, -0.010761, -0.016147
#*# 	  0.008993, 0.009610, 0.006502, 0.005253, 0.005919, 0.006785, 0.010603, 0.003874, 0.004669, 0.002317, 0.006370, 0.001739, 0.001770, -0.005046, -0.009041, 0.000232, -0.019199, -0.008283, -0.009303, -0.008288, -0.015719, -0.016756, -0.019651
#*# x_count = 23
#*# y_count = 18
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 44.264
#*# max_x = 207.734
#*# min_y = 62.215
#*# max_y = 183.785
#*#
#*# [beacon model default]
#*# model_coef = 1.9257982386737142,
#*# 	  2.1904011986275074,
#*# 	  0.5881661108028357,
#*# 	  0.30341866940870527,
#*# 	  0.14823890288711727,
#*# 	  -0.42807822476666274,
#*# 	  -0.13716254071061182,
#*# 	  0.612855529187592,
#*# 	  0.08376843001203003,
#*# 	  -0.2664564217100284
#*# model_domain = 3.352922478536077e-07,3.360945745364866e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 72.578002
#*# model_offset = -0.24000
