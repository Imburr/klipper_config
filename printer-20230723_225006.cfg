##########################
##### BASE CONFIG #######
##########################

[include mainsail.cfg]
[include ./backup/backup.cfg]

##########################
##### HARDWARE STUFF #####
##########################

[include ./hardware/xyz-stepper.cfg]
[include ./hardware/extruder.cfg]
#[include ./klicky/klicky-probe.cfg]
#[include ./hardware/adxl345.cfg]  This config now in canbus.cfg
[include ./hardware/fans.cfg] # Some fans config in canbus.cfg
[include ./hardware/canbus.cfg]

##########################
##### LIGHTS #############
##########################

[include ./hardware/chamber-lighting.cfg]
[include ./hardware/stealthburner-led.cfg]

##########################
##### CALIBRATION ########
##########################

[include ./calibration/z-tilt.cfg]
[include ./calibration/bed-mesh.cfg]
[include ./macros/unsafe.cfg]
[include ./calibration/pressure_advance.cfg]
[include test_probe_accuracy.cfg]

##########################
##### MACROS #############
##########################

[include ./macros/chamber-led.cfg]
[include ./macros/conditional-homing.cfg]
[include ./macros/print-end.cfg]
[include ./macros/print-start-mmu.cfg]
[include ./macros/dump-variables.cfg]
[include ./macros/movement-check.cfg]
[include ./macros/cancel-change.cfg]
[include ./macros/pause-resume.cfg]         ; Overridden by ERCF / subsequantly disabled
[include ./macros/load-unload.cfg]
[include ./macros/filament-change.cfg]
[include ./macros/park.cfg]
#[include ./macros/prusaslicer-accel.cfg]

##########################
##### THIRD PARTY ########
##########################

[include ./third-party-cfg/nozzle_scrub.cfg]
[include ./kamp/Adaptive_Mesh.cfg]
[include ./kamp/Adaptive_Purge.cfg]

##########################
##### ERCF ###############
##########################


[include ercf_hardware.cfg]
[include ercf_parameters.cfg]
[include ercf_software.cfg]
[include ./calibration/ercf_additional.cfg]
#[include ercf_vars.cfg]
[include client_macros.cfg]

##########################
##### LCD/MENU ###########
##########################

#[include ./third-party-cfg/nozzle_scrub_menu.cfg]
#[include ercf_menu.cfg]
#[include ./menu/printer_menu.cfg]

##########################
##### NOT ENABLED YET ####
##########################

#[include ./todo/mini12864.cfg] Add this after adding mini12864 LED
#[include ./todo/lcd_tweaks.cfg] Need to figure this one out and then implement
#[include ./hardware/nevermore.cfg] Disabled as I prefer to chamber vent outside and needed the PWM

##########################
#### REPLACEMENT #########
##########################

[include ./replacement_macros/replace-m900.cfg]
[include ./replacement_macros/replace-m117.cfg]

[exclude_object]

[gcode_arcs]
resolution: 0.1

[respond]
default_type: echo
default_prefix:  

[force_move]
# Enable commands that force potentially unsafe movement
enable_force_move: True

[idle_timeout]
timeout: 14400

[mcu]
##  Obtain definition by "ls -l /dev/serial/by-id/" then unplug to verify
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_290040000750314D35323820-if00
restart_method: command

[mcu rpi]
# Add Rpi as secondary MCU to allow for ADXL use through SPI ribbon/adapter from LDO
serial: /tmp/klipper_host_mcu

[mcu sht]
canbus_uuid: 30993412e8e0

[printer]
kinematics: corexy
max_velocity: 600           # Changed from 200 on 7.11.23
max_accel:  6000            # tuned on 7.11.23 after beacon install.
max_z_velocity: 15          #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 350
square_corner_velocity: 8.0 # Changed on 7.11.23

#####################################################################
#   Input Shaper
#####################################################################

[input_shaper]
shaper_freq_x: 76.2               ; suggested max_accel <= 22600 mm/sec^2
shaper_type_x: zv
shaper_freq_y: 51.8               ; suggested max_accel <= 7900 mm/sec^2
shaper_type_y: mzv


#####################################################################
#   Bed Heater
#####################################################################

##  SSR Pin - HE1
##  Thermistor - TB
[heater_bed]
heater_pin: PA2 #PA2 is LDO default
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF3
##  Adjust Max Power so your heater doesn't warp your bed. Rule of thumb is 0.4 watts / cm^2 .
max_power: 0.6
min_temp: 0
max_temp: 125
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

#####################################################################
#   Probe
#####################################################################

##  WAS TAP - NOW BEACON in CANBUS
#[probe]
#pin: ^sht:PA2
#x_offset: 0
#y_offset: 25.0
#z_offset: 0
#x_offset: 0
#y_offset: 0
#z_offset: 6.42
#speed: 5.0
#lift_speed: 15
#samples: 3
#samples_result: median
#sample_retract_dist: 2.0
#samples_tolerance: 0.01
#samples_tolerance_retries: 3
# After TAP installation, with PLA, Flow Rate 98%, 0.25mm First Layer, 0.6mm CHT nozzle, Z_Offset is z_offset = -0.450
#activate_gcode:
#    {% set PROBE_TEMP = 150 %}
#    {% set MAX_TEMP = PROBE_TEMP + 5 %}
#    {% set ACTUAL_TEMP = printer.extruder.temperature %}
#    {% set TARGET_TEMP = printer.extruder.target %}
#
#    {% if TARGET_TEMP > PROBE_TEMP %}
#        { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (TARGET_TEMP, PROBE_TEMP)) }
#        M109 S{ PROBE_TEMP }
#    {% else %}
#        # Temperature target is already low enough, but nozzle may still be too hot.
#        {% if ACTUAL_TEMP > MAX_TEMP %}
#            { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (ACTUAL_TEMP, MAX_TEMP)) }
#            TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={ MAX_TEMP }
#        {% endif %}
#    {% endif %}

#####################################################################
#  Filament Runout
#####################################################################

#[filament_motion_sensor RunoutSensor]
#detection_length: 10
#extruder: extruder
#switch_pin: ^PG11
#pause_on_runout: True
#runout_gcode:
#  M117 Filament problem, runout has paused.
#  M118 Filament problem, runout has paused.
#insert_gcode:
#event_delay:
#pause_delay:

#####################################################################
#   Additional Sensors
#####################################################################

[thermistor CMFB103F3950FANT]
temperature1: 0.0
resistance1: 32116.0
temperature2: 40.0
resistance2: 5309.0
temperature3: 80.0
resistance3: 1228.0

#[temperature_sensor sb_ambient_temp]
## Chamber Temperature - T1
#sensor_type: CMFB103F3950FANT
#sensor_pin: PF5
#min_temp: 0
#max_temp: 100
#gcode_id: chamber_th

[temperature_sensor back_chamber_temp]
## Chamber Temperature - T
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PF6
min_temp: 0
max_temp: 100
gcode_id: chamber_th2

[temperature_sensor RPi4]
sensor_type: temperature_host
min_temp: 0
max_temp: 100

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################

#[safe_z_home]
##  XY Location of the Z Endstop Switch
##  Update -10,-10 to the XY coordinates of your endstop pin 
##  (such as 157,305) after going through Z Endstop Pin
##  Location Definition step.
#home_xy_position: 147,256
#speed:100
#z_hop:10
#z_hop_speed:10


########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<5V>

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 39.889
#*# pid_ki = 0.964
#*# pid_kd = 412.851
#*#
#*# [probe]
#*# z_offset = -1.270
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.042592, -0.037411, -0.033416, -0.030487, -0.029740, -0.030044, -0.029490, -0.027404, -0.019213, -0.025005, -0.028904, -0.019438, -0.020207, -0.019468, -0.017819, -0.019701, -0.028838, -0.031099, -0.024868, -0.029327, -0.030073, -0.020187, -0.029026, -0.020796, -0.027702
#*# 	  -0.039901, -0.026686, -0.023697, -0.019833, -0.021319, -0.018537, -0.018502, -0.011611, -0.012275, -0.008362, -0.021427, -0.013918, -0.008359, -0.017525, -0.019697, -0.022020, -0.023330, -0.020471, -0.020256, -0.020185, -0.020221, -0.017327, -0.019025, -0.015145, -0.020358
#*# 	  -0.033954, -0.028251, -0.029858, -0.019650, -0.023174, -0.012548, -0.017633, -0.015780, -0.015102, -0.008064, -0.013233, -0.006274, -0.006832, -0.007106, -0.017611, -0.006751, -0.020272, -0.024064, -0.020070, -0.024695, -0.013342, -0.016054, -0.006446, -0.006875, -0.018119
#*# 	  -0.032084, -0.031940, -0.033518, -0.030519, -0.025271, -0.018588, -0.011908, -0.013836, -0.008329, -0.007325, -0.015619, -0.006458, -0.005812, -0.015886, -0.017423, -0.007876, -0.017212, -0.016678, -0.015779, -0.007975, -0.010055, -0.010046, -0.008968, -0.014611, -0.007475
#*# 	  -0.048529, -0.041510, -0.038086, -0.026258, -0.028250, -0.024760, -0.022263, -0.008335, -0.006499, -0.010917, -0.010662, -0.005856, -0.006809, -0.008209, -0.005887, -0.008179, -0.012561, -0.018280, -0.016320, -0.007879, -0.019210, -0.005182, -0.007171, -0.011061, -0.019164
#*# 	  -0.045081, -0.044105, -0.039136, -0.036293, -0.030568, -0.024999, -0.017849, -0.012610, -0.007209, -0.017776, -0.006748, -0.001459, -0.014685, -0.013684, -0.009706, -0.006029, -0.015874, -0.010851, -0.010645, -0.005093, -0.008697, -0.004965, -0.010942, -0.007362, -0.021070
#*# 	  -0.051753, -0.046244, -0.039988, -0.041291, -0.031148, -0.028460, -0.017173, -0.009131, -0.002536, -0.002945, -0.005853, -0.002787, -0.002337, -0.002380, -0.005875, -0.012049, -0.015824, -0.015555, -0.008324, -0.011295, -0.013199, -0.006512, -0.012240, -0.009444, -0.018951
#*# 	  -0.049549, -0.046099, -0.048420, -0.045039, -0.038664, -0.026563, -0.015464, -0.020644, -0.021462, -0.005174, -0.002672, -0.004336, -0.002901, -0.005343, -0.008021, -0.003909, -0.017581, -0.020776, -0.011647, -0.008173, -0.014085, -0.006248, -0.013269, -0.009181, -0.011830
#*# 	  -0.048286, -0.048517, -0.043462, -0.046561, -0.029532, -0.026921, -0.018223, -0.018136, -0.004567, -0.004266, -0.012846, -0.002248, -0.006410, -0.005178, -0.012123, -0.013418, -0.009280, -0.009118, -0.005122, -0.024259, -0.018209, -0.003319, -0.017852, -0.003357, -0.012986
#*# 	  -0.032854, -0.031800, -0.029167, -0.027747, -0.026877, -0.017159, -0.016220, -0.024990, -0.005646, -0.003147, -0.005751, -0.001090, -0.002779, -0.004775, -0.006204, -0.004625, -0.003247, -0.004840, -0.010471, -0.003883, -0.005461, -0.015723, -0.002670, -0.003661, -0.021855
#*# 	  -0.027872, -0.025737, -0.023025, -0.025995, -0.019646, -0.014985, -0.008465, -0.003569, -0.004819, -0.001950, -0.002328, -0.001435, -0.002625, -0.003968, -0.002018, -0.002126, -0.001890, -0.003393, -0.004716, -0.005289, -0.004354, -0.005164, -0.005365, -0.003332, -0.006697
#*# 	  -0.026128, -0.020475, -0.023024, -0.015370, -0.011298, -0.016723, -0.006332, -0.006416, -0.007706, -0.000319, -0.001171, 0.001691, 0.003141, 0.003303, 0.000855, -0.001041, -0.003289, -0.002969, -0.000389, -0.001247, -0.001873, -0.005563, -0.001935, -0.003045, -0.002313
#*# 	  -0.027505, -0.022732, -0.016309, -0.015782, -0.002019, -0.011226, -0.003368, -0.006424, -0.003022, -0.002267, -0.002932, 0.000206, 0.000000, 0.000498, -0.003931, -0.001943, -0.001307, -0.002900, -0.000479, -0.000742, -0.001315, -0.001984, -0.000702, 0.002233, -0.001942
#*# 	  -0.028584, -0.024853, -0.021378, -0.015080, -0.015806, -0.004420, -0.003067, -0.007492, -0.007769, -0.004134, -0.002080, -0.003872, -0.002752, 0.001443, -0.004630, -0.004250, -0.003892, -0.003250, -0.006281, -0.005340, -0.001022, -0.000075, 0.000213, -0.001298, -0.003864
#*# 	  -0.029572, -0.027527, -0.024086, -0.021707, -0.016256, -0.014253, -0.014714, -0.005479, -0.005265, -0.007008, -0.005325, -0.002849, -0.001052, -0.003540, -0.003813, -0.002369, -0.003344, -0.004389, -0.005111, -0.005279, -0.003573, -0.001056, -0.003182, 0.001065, -0.001168
#*# 	  -0.028533, -0.024032, -0.020373, -0.018082, -0.021842, -0.015405, -0.019254, -0.007719, -0.007971, -0.006719, -0.005764, -0.002859, 0.001140, -0.001103, 0.001168, -0.001605, -0.005857, -0.004753, 0.000475, 0.005957, 0.000711, 0.005625, 0.005811, 0.004621, 0.001768
#*# 	  -0.025068, -0.018675, -0.019339, -0.018718, -0.013822, -0.006167, -0.003358, -0.005638, -0.006537, -0.004637, -0.005605, 0.003833, 0.002380, -0.001014, 0.002124, 0.000770, 0.000770, -0.000081, -0.000452, 0.001575, 0.004469, 0.013324, 0.018898, 0.020488, 0.008038
#*# 	  -0.020664, -0.019929, -0.016224, -0.020051, -0.014249, -0.018234, -0.004671, -0.004828, -0.004291, -0.003183, -0.001961, 0.002999, 0.010477, 0.006189, 0.004334, 0.004943, 0.002163, 0.003234, 0.010161, 0.005771, 0.010793, 0.003930, 0.018534, 0.016978, 0.013810
#*# 	  -0.022632, -0.022747, -0.024162, -0.014967, -0.020016, -0.026173, -0.005385, -0.002810, -0.003590, 0.000045, -0.000425, 0.009219, 0.003258, 0.006705, 0.000577, 0.002072, 0.004269, 0.006825, 0.008314, 0.012173, 0.021657, 0.022253, 0.019845, 0.020082, 0.019581
#*# 	  -0.022138, -0.021137, -0.019207, -0.018690, -0.016578, -0.018686, -0.022891, -0.003561, -0.005357, -0.002970, 0.003181, -0.000532, 0.004026, 0.001294, 0.002801, 0.002547, 0.005213, 0.004358, 0.003262, 0.007302, 0.010728, 0.019921, 0.016200, 0.011532, 0.020539
#*# 	  -0.025682, -0.021674, -0.018193, -0.014389, -0.017452, -0.013218, -0.002264, -0.017135, -0.008004, -0.003330, -0.002480, -0.004098, 0.003219, -0.001809, 0.000418, -0.001613, 0.003155, 0.004869, 0.005190, 0.004093, 0.010230, 0.009832, 0.005627, 0.020937, 0.017757
#*# 	  -0.027170, -0.024811, -0.020468, -0.015381, -0.016068, -0.019649, -0.004797, -0.017039, -0.004610, -0.004840, -0.005794, 0.002421, 0.000960, 0.000145, 0.000543, 0.002986, 0.003701, 0.001876, 0.004150, 0.003212, 0.009972, 0.009460, 0.014192, 0.019350, 0.008363
#*# 	  -0.028000, -0.025282, -0.021007, -0.022324, -0.015054, -0.003647, -0.014489, -0.008821, -0.010975, -0.007794, -0.005977, -0.005959, -0.000342, -0.005726, -0.006152, -0.003732, 0.000495, 0.005048, 0.005450, 0.005082, 0.003675, 0.001003, 0.010600, 0.008709, 0.010326
#*# 	  -0.029268, -0.028324, -0.027075, -0.020827, -0.015055, -0.014410, -0.016364, -0.010553, -0.019307, -0.002638, -0.017528, -0.003246, -0.005880, -0.004336, -0.004358, -0.004602, -0.001154, 0.001380, -0.002507, 0.000374, 0.002911, 0.001125, 0.003233, 0.003933, 0.005229
#*# 	  -0.029042, -0.031537, -0.029506, -0.027675, -0.027883, -0.019787, -0.021304, -0.015502, -0.023432, -0.016961, -0.012809, -0.003388, -0.005139, -0.014947, -0.010327, -0.004499, -0.002855, -0.014992, -0.004927, -0.005726, -0.005736, -0.003425, -0.001905, -0.000788, -0.000443
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 34.9
#*# max_x = 210.0
#*# min_y = 30.0
#*# max_y = 210.0
#*#
#*# [beacon model default]
#*# model_coef = 1.9257982386737142,
#*# 	  2.1904011986275074,
#*# 	  0.5881661108028357,
#*# 	  0.30341866940870527,
#*# 	  0.14823890288711727,
#*# 	  -0.42807822476666274,
#*# 	  -0.13716254071061182,
#*# 	  0.612855529187592,
#*# 	  0.08376843001203003,
#*# 	  -0.2664564217100284
#*# model_domain = 3.352922478536077e-07,3.360945745364866e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 72.578002
#*# model_offset = -0.37000
