##########################
##### BASE CONFIG #######
##########################

[include mainsail.cfg]
[include ./backup/backup.cfg]

##########################
##### HARDWARE STUFF #####
##########################

[include ./hardware/xyz-stepper.cfg]
[include ./hardware/extruder.cfg]
#[include ./klicky/klicky-probe.cfg]
#[include ./hardware/adxl345.cfg]  This config now in canbus.cfg
[include ./hardware/fans.cfg] # Some fans config in canbus.cfg
[include ./hardware/canbus.cfg]

##########################
##### LIGHTS #############
##########################

[include ./hardware/chamber-lighting.cfg]
[include ./hardware/stealthburner-led.cfg]

##########################
##### CALIBRATION ########
##########################

[include ./calibration/z-tilt.cfg]
[include ./calibration/bed-mesh.cfg]
[include ./macros/unsafe.cfg]
[include ./calibration/pressure_advance.cfg]
[include test_probe_accuracy.cfg]

##########################
##### MACROS #############
##########################

[include ./macros/chamber-led.cfg]
[include ./macros/conditional-homing.cfg]
[include ./macros/print-end.cfg]
[include ./macros/print-start-mmu.cfg]
[include ./macros/dump-variables.cfg]
[include ./macros/movement-check.cfg]
[include ./macros/cancel-change.cfg]
[include ./macros/pause-resume.cfg]         ; Overridden by ERCF / subsequantly disabled
[include ./macros/load-unload.cfg]
[include ./macros/filament-change.cfg]
[include ./macros/park.cfg]
#[include ./macros/prusaslicer-accel.cfg]

##########################
##### THIRD PARTY ########
##########################

[include ./third-party-cfg/nozzle_scrub.cfg]
#[include ./kamp/Adaptive_Mesh.cfg]
#[include ./kamp/Adaptive_Purge.cfg]
[include ./KAMP/KAMP_Settings.cfg]
[include ./KAMP/Adaptive_Meshing.cfg]
[include ./KAMP/Line_Purge.cfg]
[include ./KAMP/Voron_Purge.cfg]
[include ./KAMP/Smart_Park.cfg]

##########################
##### ERCF ###############
##########################


[include ercf_hardware.cfg]
[include ercf_parameters.cfg]
[include ercf_software.cfg]
[include ./calibration/ercf_additional.cfg]
#[include ercf_vars.cfg]
[include client_macros.cfg]

##########################
##### LCD/MENU ###########
##########################

#[include ./third-party-cfg/nozzle_scrub_menu.cfg]
#[include ercf_menu.cfg]
#[include ./menu/printer_menu.cfg]

##########################
##### NOT ENABLED YET ####
##########################

#[include ./todo/mini12864.cfg] Add this after adding mini12864 LED
#[include ./todo/lcd_tweaks.cfg] Need to figure this one out and then implement
#[include ./hardware/nevermore.cfg] Disabled as I prefer to chamber vent outside and needed the PWM

##########################
#### REPLACEMENT #########
##########################

[include ./replacement_macros/replace-m900.cfg]
[include ./replacement_macros/replace-m117.cfg]

[exclude_object]

[gcode_arcs]
resolution: 0.1

[respond]
default_type: echo
default_prefix:  

[force_move]
# Enable commands that force potentially unsafe movement
enable_force_move: True

[idle_timeout]
timeout: 14400

[mcu]
##  Obtain definition by "ls -l /dev/serial/by-id/" then unplug to verify
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_290040000750314D35323820-if00
restart_method: command

[mcu rpi]
# Add Rpi as secondary MCU to allow for ADXL use through SPI ribbon/adapter from LDO
serial: /tmp/klipper_host_mcu

[mcu sht]
canbus_uuid: 30993412e8e0

[printer]
kinematics: corexy
max_velocity: 600           # Changed from 200 on 7.11.23
max_accel:  6000            # tuned on 7.11.23 after beacon install.
max_z_velocity: 15          #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 350
square_corner_velocity: 8.0 # Changed on 7.11.23

#####################################################################
#   Input Shaper
#####################################################################

[input_shaper]
shaper_freq_x: 76.2               ; suggested max_accel <= 22600 mm/sec^2
shaper_type_x: zv
shaper_freq_y: 51.8               ; suggested max_accel <= 7900 mm/sec^2
shaper_type_y: mzv


#####################################################################
#   Bed Heater
#####################################################################

##  SSR Pin - HE1
##  Thermistor - TB
[heater_bed]
heater_pin: PA2 #PA2 is LDO default
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF3
##  Adjust Max Power so your heater doesn't warp your bed. Rule of thumb is 0.4 watts / cm^2 .
max_power: 0.6
min_temp: 0
max_temp: 125
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

#####################################################################
#   Probe
#####################################################################

##  WAS TAP - NOW BEACON in CANBUS
#[probe]
#pin: ^sht:PA2
#x_offset: 0
#y_offset: 25.0
#z_offset: 0
#x_offset: 0
#y_offset: 0
#z_offset: 6.42
#speed: 5.0
#lift_speed: 15
#samples: 3
#samples_result: median
#sample_retract_dist: 2.0
#samples_tolerance: 0.01
#samples_tolerance_retries: 3
# After TAP installation, with PLA, Flow Rate 98%, 0.25mm First Layer, 0.6mm CHT nozzle, Z_Offset is z_offset = -0.450
#activate_gcode:
#    {% set PROBE_TEMP = 150 %}
#    {% set MAX_TEMP = PROBE_TEMP + 5 %}
#    {% set ACTUAL_TEMP = printer.extruder.temperature %}
#    {% set TARGET_TEMP = printer.extruder.target %}
#
#    {% if TARGET_TEMP > PROBE_TEMP %}
#        { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (TARGET_TEMP, PROBE_TEMP)) }
#        M109 S{ PROBE_TEMP }
#    {% else %}
#        # Temperature target is already low enough, but nozzle may still be too hot.
#        {% if ACTUAL_TEMP > MAX_TEMP %}
#            { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (ACTUAL_TEMP, MAX_TEMP)) }
#            TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={ MAX_TEMP }
#        {% endif %}
#    {% endif %}

#####################################################################
#  Filament Runout
#####################################################################

#[filament_motion_sensor RunoutSensor]
#detection_length: 10
#extruder: extruder
#switch_pin: ^PG11
#pause_on_runout: True
#runout_gcode:
#  M117 Filament problem, runout has paused.
#  M118 Filament problem, runout has paused.
#insert_gcode:
#event_delay:
#pause_delay:

#####################################################################
#   Additional Sensors
#####################################################################

[thermistor CMFB103F3950FANT]
temperature1: 0.0
resistance1: 32116.0
temperature2: 40.0
resistance2: 5309.0
temperature3: 80.0
resistance3: 1228.0

#[temperature_sensor sb_ambient_temp]
## Chamber Temperature - T1
#sensor_type: CMFB103F3950FANT
#sensor_pin: PF5
#min_temp: 0
#max_temp: 100
#gcode_id: chamber_th

[temperature_sensor back_chamber_temp]
## Chamber Temperature - T
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PF6
min_temp: 0
max_temp: 100
gcode_id: chamber_th2

[temperature_sensor RPi4]
sensor_type: temperature_host
min_temp: 0
max_temp: 100

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################

#[safe_z_home]
##  XY Location of the Z Endstop Switch
##  Update -10,-10 to the XY coordinates of your endstop pin 
##  (such as 157,305) after going through Z Endstop Pin
##  Location Definition step.
#home_xy_position: 147,256
#speed:100
#z_hop:10
#z_hop_speed:10


########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<5V>

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 39.889
#*# pid_ki = 0.964
#*# pid_kd = 412.851
#*#
#*# [probe]
#*# z_offset = -1.270
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.056912, -0.046547, -0.038725, -0.036062, -0.036879, -0.030055, -0.037254, -0.033026, -0.028682, -0.028961, -0.030068, -0.028408, -0.026722, -0.033403, -0.035606, -0.039470, -0.038660, -0.040893, -0.042302, -0.046635, -0.047959, -0.040521, -0.040502, -0.043144, -0.041553
#*# 	  -0.050174, -0.039049, -0.037256, -0.032526, -0.029073, -0.026171, -0.029590, -0.031955, -0.021526, -0.017098, -0.026474, -0.026214, -0.027788, -0.034961, -0.028054, -0.035036, -0.038884, -0.039879, -0.035732, -0.039261, -0.039059, -0.039496, -0.033812, -0.039332, -0.039149
#*# 	  -0.047263, -0.036770, -0.038716, -0.037328, -0.035606, -0.026665, -0.017201, -0.024542, -0.017683, -0.016486, -0.017533, -0.023298, -0.017226, -0.023695, -0.017920, -0.021071, -0.022480, -0.032740, -0.031274, -0.032367, -0.034461, -0.034452, -0.030521, -0.030779, -0.039192
#*# 	  -0.051532, -0.045212, -0.041086, -0.040124, -0.035193, -0.032354, -0.019543, -0.027444, -0.018223, -0.019508, -0.017472, -0.015500, -0.020579, -0.019137, -0.017136, -0.023487, -0.022826, -0.029377, -0.022001, -0.029704, -0.033941, -0.030011, -0.030053, -0.019929, -0.033527
#*# 	  -0.054691, -0.050149, -0.043234, -0.039270, -0.040147, -0.036908, -0.035545, -0.017374, -0.017354, -0.022460, -0.024158, -0.015334, -0.023440, -0.019747, -0.014914, -0.020114, -0.028764, -0.027636, -0.025693, -0.018875, -0.026469, -0.021710, -0.022217, -0.021810, -0.034523
#*# 	  -0.054495, -0.060012, -0.044830, -0.053061, -0.041609, -0.039837, -0.020397, -0.023566, -0.019443, -0.013292, -0.014800, -0.015407, -0.016402, -0.017154, -0.020764, -0.026037, -0.025725, -0.024241, -0.020822, -0.028397, -0.019512, -0.021717, -0.020682, -0.026773, -0.029246
#*# 	  -0.057406, -0.053769, -0.060035, -0.055442, -0.042724, -0.034675, -0.025262, -0.026570, -0.018091, -0.019121, -0.020115, -0.013334, -0.013945, -0.017973, -0.021316, -0.017884, -0.019127, -0.020381, -0.029645, -0.017865, -0.029952, -0.018024, -0.018616, -0.026496, -0.021160
#*# 	  -0.053440, -0.049373, -0.046245, -0.040292, -0.039523, -0.037330, -0.023650, -0.030408, -0.017608, -0.010247, -0.015663, -0.015886, -0.014558, -0.016157, -0.017557, -0.019569, -0.018670, -0.016238, -0.023650, -0.017371, -0.015363, -0.025685, -0.025173, -0.027093, -0.029895
#*# 	  -0.060674, -0.040330, -0.037982, -0.036512, -0.034140, -0.030128, -0.027015, -0.019450, -0.013983, -0.017263, -0.014199, -0.018030, -0.016166, -0.009270, -0.017130, -0.018190, -0.021569, -0.019729, -0.020735, -0.018403, -0.015760, -0.017474, -0.026249, -0.021204, -0.024290
#*# 	  -0.036101, -0.036530, -0.035855, -0.037033, -0.038642, -0.022055, -0.021563, -0.015062, -0.018657, -0.020351, -0.014492, -0.012773, -0.010537, -0.018172, -0.012432, -0.012418, -0.015699, -0.018495, -0.017265, -0.017946, -0.016950, -0.017896, -0.018818, -0.024048, -0.020353
#*# 	  -0.034843, -0.024210, -0.027818, -0.033926, -0.028816, -0.022574, -0.017968, -0.017907, -0.012137, -0.012908, -0.011364, -0.010822, -0.011792, -0.011554, -0.011257, -0.012319, -0.011983, -0.015280, -0.014297, -0.020311, -0.015909, -0.022328, -0.018100, -0.021115, -0.027484
#*# 	  -0.033310, -0.024200, -0.023356, -0.024589, -0.022894, -0.020512, -0.014574, -0.010251, -0.011183, -0.001152, -0.015605, -0.005370, -0.009447, -0.007402, -0.016342, -0.008843, -0.006912, -0.008182, -0.009135, -0.010618, -0.013414, -0.011545, -0.008056, -0.011537, -0.022183
#*# 	  -0.029171, -0.025326, -0.022724, -0.012367, -0.020898, -0.015959, -0.012552, -0.012179, -0.010359, 0.000017, 0.000443, -0.002935, -0.004212, -0.000595, -0.002419, -0.017907, -0.016107, -0.007430, -0.011032, -0.012198, -0.013777, -0.012783, -0.015181, -0.005043, -0.018200
#*# 	  -0.026304, -0.020618, -0.023045, -0.017699, -0.018958, -0.021072, -0.016999, -0.017184, -0.009269, -0.006083, -0.005398, -0.007703, -0.005727, -0.001631, -0.011964, -0.003842, -0.011005, -0.012070, -0.012354, -0.007130, -0.016934, -0.008951, -0.013688, -0.018469, -0.018070
#*# 	  -0.033549, -0.025461, -0.022454, -0.022377, -0.025398, -0.020066, -0.027494, -0.015338, -0.012216, -0.010382, -0.007732, -0.004453, -0.005320, -0.010240, -0.010860, -0.011754, -0.017380, -0.007439, -0.019671, -0.008786, -0.018253, -0.004697, -0.008234, -0.004537, -0.013934
#*# 	  -0.032587, -0.026957, -0.026135, -0.018753, -0.020318, -0.028021, -0.022008, -0.011155, -0.006700, -0.011055, -0.012580, -0.010390, -0.008057, -0.005834, -0.007248, -0.004228, -0.006089, -0.005216, -0.008384, -0.006242, -0.002382, -0.009732, 0.001281, -0.006158, -0.001548
#*# 	  -0.024509, -0.019409, -0.016902, -0.009874, -0.011015, -0.011080, -0.021669, -0.006068, -0.001619, -0.005527, -0.003395, -0.004770, -0.002242, -0.001392, -0.001072, -0.005296, -0.004918, -0.004836, -0.004624, 0.003116, -0.001836, -0.001162, -0.000038, 0.003048, 0.000704
#*# 	  -0.019234, -0.017970, -0.012639, -0.016089, -0.016209, -0.018600, -0.010179, -0.004985, -0.004452, -0.001930, -0.005909, -0.000628, -0.001594, 0.001040, 0.006246, 0.003647, 0.005237, 0.001064, -0.003725, 0.002631, 0.006973, -0.000775, 0.007956, -0.001150, 0.001618
#*# 	  -0.022999, -0.017447, -0.009364, -0.021036, -0.008832, -0.016061, -0.010988, -0.007904, -0.008870, 0.001792, -0.002246, -0.004047, 0.010776, 0.000768, -0.001301, 0.000156, 0.009529, -0.001395, 0.003839, -0.002708, 0.014882, 0.000717, 0.014119, 0.017469, 0.010885
#*# 	  -0.026532, -0.015717, -0.017584, -0.014367, -0.018208, -0.011277, -0.019097, -0.013254, -0.009461, -0.009749, -0.005095, -0.002425, 0.002533, 0.000939, -0.002478, 0.003867, -0.003081, -0.000732, -0.001703, 0.008453, 0.010587, 0.000907, 0.014459, 0.008726, 0.008734
#*# 	  -0.022722, -0.016003, -0.022721, -0.018500, -0.017069, -0.011433, -0.007817, -0.007579, -0.008527, -0.007602, -0.006744, -0.009249, 0.003155, -0.003183, -0.003665, -0.003016, -0.003085, -0.001926, 0.005616, 0.002194, 0.002032, -0.000050, 0.002299, 0.004792, 0.007242
#*# 	  -0.028814, -0.022572, -0.018763, -0.024286, -0.021303, -0.007173, -0.016907, -0.006300, -0.008657, -0.009082, -0.005069, -0.005916, -0.002205, 0.002210, -0.004917, -0.003594, 0.002564, -0.002704, -0.003177, -0.001918, 0.006506, 0.003301, 0.008778, -0.001659, 0.006084
#*# 	  -0.025753, -0.023177, -0.020265, -0.021865, -0.011507, -0.010088, -0.019032, -0.016552, -0.011335, -0.006962, -0.006890, -0.002164, -0.007971, -0.004830, -0.002737, -0.002894, -0.001357, -0.000530, -0.003356, -0.004523, -0.002460, 0.008626, 0.004290, 0.001143, 0.007267
#*# 	  -0.028878, -0.025552, -0.022756, -0.021163, -0.023440, -0.009949, -0.008839, -0.023523, -0.006532, -0.020902, -0.007327, -0.005109, -0.008227, -0.005816, -0.006943, -0.005135, -0.005471, -0.005891, -0.004263, -0.003848, -0.002153, -0.003513, 0.003509, 0.001253, 0.001578
#*# 	  -0.034163, -0.030575, -0.026341, -0.024734, -0.022579, -0.018163, -0.026038, -0.018786, -0.026289, -0.018723, -0.014275, -0.023392, -0.021933, -0.008960, -0.011202, -0.008360, -0.016951, -0.009274, -0.009128, -0.009700, -0.007425, -0.013062, -0.005525, -0.004308, -0.002934
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 210.0
#*# min_y = 30.0
#*# max_y = 210.0
#*#
#*# [beacon model default]
#*# model_coef = 1.9257982386737142,
#*# 	2.1904011986275074,
#*# 	0.5881661108028357,
#*# 	0.30341866940870527,
#*# 	0.14823890288711727,
#*# 	-0.42807822476666274,
#*# 	-0.13716254071061182,
#*# 	0.612855529187592,
#*# 	0.08376843001203003,
#*# 	-0.2664564217100284
#*# model_domain = 3.352922478536077e-07,3.360945745364866e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 72.578002
#*# model_offset = -0.38000
