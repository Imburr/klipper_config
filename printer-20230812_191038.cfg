##########################
##### BASE CONFIG #######
##########################

[include mainsail.cfg]
[include ./backup/backup.cfg]

##########################
##### HARDWARE STUFF #####
##########################

[include ./hardware/xyz-stepper.cfg]
[include ./hardware/extruder.cfg]
#[include ./klicky/klicky-probe.cfg]
#[include ./hardware/adxl345.cfg]  This config now in canbus.cfg
[include ./hardware/fans.cfg] # Some fans config in canbus.cfg
[include ./hardware/canbus.cfg]

##########################
##### LIGHTS #############
##########################

[include ./hardware/chamber-lighting.cfg]
[include ./hardware/stealthburner-led.cfg]

##########################
##### CALIBRATION ########
##########################

[include ./calibration/z-tilt.cfg]
[include ./calibration/bed-mesh.cfg]
[include ./macros/unsafe.cfg]
[include ./calibration/pressure_advance.cfg]
[include test_probe_accuracy.cfg]

##########################
##### MACROS #############
##########################

[include ./macros/chamber-led.cfg]
[include ./macros/conditional-homing.cfg]
[include ./macros/print-end.cfg]
[include ./macros/print-start-mmu.cfg]
[include ./macros/dump-variables.cfg]
[include ./macros/movement-check.cfg]
[include ./macros/cancel-change.cfg]
[include ./macros/pause-resume.cfg]         ; Overridden by ERCF / subsequantly disabled
[include ./macros/load-unload.cfg]
[include ./macros/filament-change.cfg]
[include ./macros/park.cfg]
#[include ./macros/prusaslicer-accel.cfg]

##########################
##### THIRD PARTY ########
##########################

#[include ./third-party-cfg/nozzle_scrub.cfg]
#[include ./kamp/Adaptive_Mesh.cfg]
#[include ./kamp/Adaptive_Purge.cfg]
[include ./KAMP/KAMP_Settings.cfg]
[include ./KAMP/Adaptive_Meshing.cfg]
#[include ./KAMP/Line_Purge.cfg]
[include ./KAMP/Voron_Purge.cfg]
[include ./KAMP/Smart_Park.cfg]

##########################
##### ERCF ###############
##########################


[include ercf_hardware.cfg]
[include ercf_parameters.cfg]
[include ercf_software.cfg]
[include ./calibration/ercf_additional.cfg]
#[include ercf_vars.cfg]
#[include client_macros.cfg]

##########################
##### LCD/MENU ###########
##########################

#[include ./third-party-cfg/nozzle_scrub_menu.cfg]
#[include ercf_menu.cfg]
#[include ./menu/printer_menu.cfg]

##########################
##### NOT ENABLED YET ####
##########################

#[include ./todo/mini12864.cfg] Add this after adding mini12864 LED
#[include ./todo/lcd_tweaks.cfg] Need to figure this one out and then implement
#[include ./hardware/nevermore.cfg] Disabled as I prefer to chamber vent outside and needed the PWM

##########################
#### REPLACEMENT #########
##########################

[include ./replacement_macros/replace-m900.cfg]
[include ./replacement_macros/replace-m117.cfg]

[exclude_object]

[gcode_arcs]
resolution: 0.1

[respond]
default_type: echo
default_prefix:  

[force_move]
# Enable commands that force potentially unsafe movement
enable_force_move: True

[idle_timeout]
timeout: 14400

[mcu]
##  Obtain definition by "ls -l /dev/serial/by-id/" then unplug to verify
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_290040000750314D35323820-if00
restart_method: command

[mcu rpi]
# Add Rpi as secondary MCU to allow for ADXL use through SPI ribbon/adapter from LDO
serial: /tmp/klipper_host_mcu

[mcu sht]
canbus_uuid: 30993412e8e0

[printer]
kinematics: corexy
max_velocity: 300           # Changed from 200 on 7.11.23
max_accel:  6000            # tuned on 7.11.23 after beacon install.
max_z_velocity: 15          #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 350
square_corner_velocity: 5.0 # Changed on 7.11.23

#####################################################################
#   Input Shaper
#####################################################################

[input_shaper]
#shaper_freq_x: 76.2               ; suggested max_accel <= 22600 mm/sec^2
#shaper_type_x: zv
#shaper_freq_y: 51.8               ; suggested max_accel <= 7900 mm/sec^2
#shaper_type_y: mzv


#####################################################################
#   Bed Heater
#####################################################################

##  SSR Pin - HE1
##  Thermistor - TB
[heater_bed]
heater_pin: PA2 #PA2 is LDO default
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF3
##  Adjust Max Power so your heater doesn't warp your bed. Rule of thumb is 0.4 watts / cm^2 .
max_power: 0.6
min_temp: 0
max_temp: 125
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

#####################################################################
#   Probe
#####################################################################

##  WAS TAP - NOW BEACON in CANBUS
#[probe]
#pin: ^sht:PA2
#x_offset: 0
#y_offset: 25.0
#z_offset: 0
#x_offset: 0
#y_offset: 0
#z_offset: 6.42
#speed: 5.0
#lift_speed: 15
#samples: 3
#samples_result: median
#sample_retract_dist: 2.0
#samples_tolerance: 0.01
#samples_tolerance_retries: 3
# After TAP installation, with PLA, Flow Rate 98%, 0.25mm First Layer, 0.6mm CHT nozzle, Z_Offset is z_offset = -0.450
#activate_gcode:
#    {% set PROBE_TEMP = 150 %}
#    {% set MAX_TEMP = PROBE_TEMP + 5 %}
#    {% set ACTUAL_TEMP = printer.extruder.temperature %}
#    {% set TARGET_TEMP = printer.extruder.target %}
#
#    {% if TARGET_TEMP > PROBE_TEMP %}
#        { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (TARGET_TEMP, PROBE_TEMP)) }
#        M109 S{ PROBE_TEMP }
#    {% else %}
#        # Temperature target is already low enough, but nozzle may still be too hot.
#        {% if ACTUAL_TEMP > MAX_TEMP %}
#            { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (ACTUAL_TEMP, MAX_TEMP)) }
#            TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={ MAX_TEMP }
#        {% endif %}
#    {% endif %}

#####################################################################
#  Filament Runout
#####################################################################

#[filament_motion_sensor RunoutSensor]
#detection_length: 10
#extruder: extruder
#switch_pin: ^PG11
#pause_on_runout: True
#runout_gcode:
#  M117 Filament problem, runout has paused.
#  M118 Filament problem, runout has paused.
#insert_gcode:
#event_delay:
#pause_delay:

#####################################################################
#   Additional Sensors
#####################################################################

[thermistor CMFB103F3950FANT]
temperature1: 0.0
resistance1: 32116.0
temperature2: 40.0
resistance2: 5309.0
temperature3: 80.0
resistance3: 1228.0

#[temperature_sensor sb_ambient_temp]
## Chamber Temperature - T1
#sensor_type: CMFB103F3950FANT
#sensor_pin: PF5
#min_temp: 0
#max_temp: 100
#gcode_id: chamber_th

[temperature_sensor back_chamber_temp]
## Chamber Temperature - T
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PF6
min_temp: 0
max_temp: 100
gcode_id: chamber_th2

[temperature_sensor RPi4]
sensor_type: temperature_host
min_temp: 0
max_temp: 100

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################

#[safe_z_home]
##  XY Location of the Z Endstop Switch
##  Update -10,-10 to the XY coordinates of your endstop pin 
##  (such as 157,305) after going through Z Endstop Pin
##  Location Definition step.
#home_xy_position: 147,256
#speed:100
#z_hop:10
#z_hop_speed:10


########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<5V>

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 39.889
#*# pid_ki = 0.964
#*# pid_kd = 412.851
#*#
#*# [probe]
#*# z_offset = -1.270
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	-0.056476, -0.063449, -0.048913, -0.046359, -0.048905, -0.036242, -0.033276, -0.031831, -0.032743, -0.028552, -0.029257, -0.030864, -0.027070, -0.029939, -0.027383, -0.029117, -0.038210, -0.035076, -0.042754, -0.033088, -0.039507, -0.027698, -0.029665, -0.028264, -0.028365
#*# 	-0.052424, -0.047546, -0.047942, -0.027837, -0.027313, -0.027565, -0.027641, -0.027035, -0.027480, -0.022334, -0.025859, -0.024181, -0.026521, -0.026574, -0.020155, -0.025831, -0.028438, -0.028001, -0.028207, -0.026335, -0.023517, -0.023623, -0.023810, -0.025648, -0.020780
#*# 	-0.046392, -0.035596, -0.033073, -0.030645, -0.028446, -0.026835, -0.026556, -0.022981, -0.015647, -0.013779, -0.013908, -0.008536, -0.014123, -0.009571, -0.018188, -0.023926, -0.018691, -0.022322, -0.016567, -0.020861, -0.015772, -0.025345, -0.011007, -0.005743, -0.017179
#*# 	-0.048938, -0.044982, -0.041567, -0.028887, -0.029733, -0.027740, -0.020154, -0.014943, -0.024349, -0.016324, -0.009675, -0.024672, -0.015972, -0.015575, -0.012492, -0.012042, -0.017017, -0.012493, -0.010955, -0.017744, -0.014305, -0.013386, -0.010609, -0.007745, -0.014408
#*# 	-0.053863, -0.049210, -0.050463, -0.047263, -0.031606, -0.028512, -0.025250, -0.014453, -0.011607, -0.005341, -0.006072, -0.012050, -0.015978, -0.014935, -0.009845, -0.027355, -0.007650, -0.011975, -0.004633, -0.020951, -0.011621, -0.004188, -0.006197, -0.004314, -0.018670
#*# 	-0.053910, -0.053775, -0.051835, -0.046325, -0.029652, -0.031607, -0.024219, -0.013531, -0.006099, -0.005261, -0.010983, -0.004783, -0.005254, -0.006142, -0.004641, -0.025605, -0.006471, -0.023877, -0.010030, -0.022388, -0.004846, -0.005186, -0.021523, -0.016818, -0.006088
#*# 	-0.053625, -0.055029, -0.050286, -0.053133, -0.042046, -0.028841, -0.028163, -0.009758, -0.007279, -0.022729, -0.005322, -0.004833, -0.007399, -0.004898, -0.012471, -0.014355, -0.018908, -0.017292, -0.010987, -0.010667, -0.008824, -0.005953, -0.006460, -0.004319, -0.011988
#*# 	-0.054296, -0.051164, -0.052885, -0.049865, -0.033960, -0.028758, -0.028014, -0.019990, -0.014632, -0.007403, -0.005591, -0.005699, -0.003943, -0.003304, -0.004677, -0.004370, -0.008908, -0.004548, -0.004983, -0.007344, -0.005765, -0.005648, -0.004253, -0.005005, -0.010099
#*# 	-0.053358, -0.051595, -0.046617, -0.046030, -0.033323, -0.030315, -0.022524, -0.020591, -0.017894, -0.004461, -0.005501, -0.005269, -0.003675, -0.004482, -0.004685, -0.005524, -0.007072, -0.004385, -0.004953, -0.005089, -0.005588, -0.005254, -0.005780, -0.007186, -0.005685
#*# 	-0.044960, -0.041088, -0.040871, -0.029956, -0.029103, -0.027226, -0.021047, -0.016548, -0.027336, -0.009910, -0.006300, -0.005232, -0.007410, -0.005143, -0.004714, -0.005908, -0.004739, -0.004354, -0.004440, -0.004111, -0.005645, -0.004614, -0.003634, -0.004359, -0.006468
#*# 	-0.038859, -0.038552, -0.032626, -0.030126, -0.026518, -0.019355, -0.018811, -0.006046, -0.008056, -0.006208, -0.003520, -0.003949, -0.004358, -0.004653, -0.004119, -0.004346, -0.004386, -0.004169, -0.004431, -0.003769, -0.004681, 0.002142, -0.004395, -0.003987, -0.004185
#*# 	-0.028967, -0.028767, -0.028334, -0.026974, -0.022530, -0.023515, -0.015317, -0.006176, -0.005362, -0.003683, -0.002211, -0.003082, -0.000044, -0.003171, 0.000779, 0.002453, -0.002910, -0.002633, -0.002282, -0.001756, -0.000567, 0.007574, -0.003036, 0.002414, -0.004105
#*# 	-0.031504, -0.028522, -0.021550, -0.016058, -0.014171, -0.010064, -0.018980, -0.003322, -0.003924, -0.004286, -0.002671, 0.005652, -0.000356, 0.003938, 0.002450, 0.001654, 0.003076, 0.003784, 0.002049, 0.003371, 0.007334, -0.000549, 0.002298, 0.007477, 0.010096
#*# 	-0.029016, -0.028301, -0.022621, -0.027384, -0.023185, -0.021352, -0.015076, -0.005066, -0.004101, -0.007308, -0.003337, -0.003276, -0.002742, -0.004741, -0.003798, 0.000431, -0.000174, -0.003234, 0.003139, 0.006278, 0.005715, 0.004315, 0.005668, 0.001245, 0.000516
#*# 	-0.030246, -0.030295, -0.032746, -0.028780, -0.026326, -0.026395, -0.015480, -0.011111, -0.020631, -0.004409, -0.017164, -0.004724, -0.002312, -0.001943, -0.002949, -0.003780, -0.000379, 0.002816, -0.003757, -0.000404, -0.002150, 0.001237, 0.000253, 0.006410, 0.004873
#*# 	-0.048175, -0.028464, -0.029331, -0.025228, -0.028189, -0.021045, -0.017586, -0.022094, -0.015640, -0.015362, -0.005190, -0.004039, -0.003990, -0.000800, -0.002791, -0.000706, -0.004704, -0.002405, -0.000774, -0.000617, 0.006552, 0.009781, 0.006004, 0.001812, 0.010313
#*# 	-0.048332, -0.029855, -0.030318, -0.027151, -0.023674, -0.015783, -0.021065, -0.019954, -0.011523, -0.006464, -0.005175, -0.003792, -0.003667, -0.003895, 0.002952, -0.003324, -0.001030, 0.004371, 0.003869, 0.009324, 0.010770, 0.017449, 0.019704, 0.020101, 0.018484
#*# 	-0.031950, -0.029299, -0.029130, -0.026752, -0.024040, -0.026172, -0.018773, -0.011016, -0.014042, -0.008007, -0.004537, -0.002467, -0.001777, 0.001945, 0.001463, -0.003731, 0.001087, 0.002108, 0.002307, 0.016202, 0.018554, 0.018219, 0.019204, 0.020587, 0.020192
#*# 	-0.029095, -0.028675, -0.027649, -0.027933, -0.027827, -0.020660, -0.021019, -0.008461, -0.009916, -0.005663, -0.006819, -0.004149, -0.003432, 0.002262, 0.002031, 0.003115, 0.011887, 0.012186, 0.015050, 0.017073, 0.005487, 0.019352, 0.020136, 0.018152, 0.020149
#*# 	-0.046932, -0.028974, -0.029539, -0.029496, -0.030390, -0.028020, -0.027499, -0.022796, -0.013539, -0.017800, -0.003759, -0.007716, -0.003513, -0.004382, -0.002346, 0.003473, 0.004181, -0.002977, 0.006653, 0.013391, 0.006331, 0.007895, 0.018237, 0.019508, 0.019023
#*# 	-0.043587, -0.032761, -0.043469, -0.028578, -0.039442, -0.029288, -0.028157, -0.028059, -0.025347, -0.022909, -0.004288, -0.016307, -0.015985, -0.004208, -0.003559, -0.003548, -0.001333, -0.002986, 0.001966, 0.003847, 0.005257, 0.006040, 0.019578, 0.015052, 0.002385
#*# 	-0.047403, -0.037158, -0.030556, -0.031879, -0.027983, -0.027759, -0.028828, -0.027585, -0.026502, -0.017268, -0.020683, -0.023592, -0.004210, -0.005267, -0.005301, -0.004086, -0.003215, -0.003782, -0.002803, 0.000082, -0.000373, 0.007892, 0.012018, 0.005831, 0.003320
#*# 	-0.049748, -0.038992, -0.043192, -0.027813, -0.028450, -0.033847, -0.028056, -0.027101, -0.028665, -0.020699, -0.023066, -0.015066, -0.008640, -0.004175, -0.004202, -0.012994, -0.003345, -0.003394, -0.003919, 0.002245, 0.005525, 0.002130, -0.000292, 0.008238, 0.002521
#*# 	-0.052318, -0.043486, -0.031794, -0.042897, -0.050356, -0.041442, -0.035891, -0.027912, -0.025214, -0.024538, -0.015524, -0.021415, -0.012465, -0.014110, -0.011547, -0.004128, -0.014978, -0.004654, -0.004616, -0.003986, -0.005373, -0.003994, -0.002328, -0.001592, -0.001289
#*# 	-0.054856, -0.050790, -0.052105, -0.048726, -0.045856, -0.049584, -0.049866, -0.036074, -0.035210, -0.029637, -0.027770, -0.027871, -0.020613, -0.025641, -0.022267, -0.025847, -0.017642, -0.020907, -0.023370, -0.012526, -0.013658, -0.026151, -0.009640, -0.003831, -0.004209
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 210.0
#*# min_y = 30.0
#*# max_y = 210.0
#*#
#*# [beacon model default]
#*# model_coef = 1.9257982386737142,
#*# 	2.1904011986275074,
#*# 	0.5881661108028357,
#*# 	0.30341866940870527,
#*# 	0.14823890288711727,
#*# 	-0.42807822476666274,
#*# 	-0.13716254071061182,
#*# 	0.612855529187592,
#*# 	0.08376843001203003,
#*# 	-0.2664564217100284
#*# model_domain = 3.352922478536077e-07,3.360945745364866e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 72.578002
#*# model_offset = -0.33000
#*#
#*# [input_shaper]
#*# shaper_type_x = zv
#*# shaper_freq_x = 77.4
#*# shaper_type_y = mzv
#*# shaper_freq_y = 51.6
