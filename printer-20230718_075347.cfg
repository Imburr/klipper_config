##########################
##### BASE CONFIG #######
##########################

[include mainsail.cfg]
[include ./backup/backup.cfg]

##########################
##### HARDWARE STUFF #####
##########################

[include ./hardware/xyz-stepper.cfg]
[include ./hardware/extruder.cfg]
#[include ./klicky/klicky-probe.cfg]
#[include ./hardware/adxl345.cfg]  This config now in canbus.cfg
[include ./hardware/fans.cfg] # Some fans config in canbus.cfg
[include ./hardware/canbus.cfg]

##########################
##### LIGHTS #############
##########################

[include ./hardware/chamber-lighting.cfg]
[include ./hardware/stealthburner-led.cfg]

##########################
##### CALIBRATION ########
##########################

[include ./calibration/z-tilt.cfg]
[include ./calibration/bed-mesh.cfg]
[include ./macros/unsafe.cfg]
[include ./calibration/pressure_advance.cfg]
[include test_probe_accuracy.cfg]

##########################
##### MACROS #############
##########################

[include ./macros/chamber-led.cfg]
[include ./macros/conditional-homing.cfg]
[include ./macros/print-end.cfg]
[include ./macros/print-start-mmu.cfg]
[include ./macros/dump-variables.cfg]
[include ./macros/movement-check.cfg]
[include ./macros/cancel-change.cfg]
[include ./macros/pause-resume.cfg]         ; Overridden by ERCF / subsequantly disabled
[include ./macros/load-unload.cfg]
[include ./macros/filament-change.cfg]
[include ./macros/park.cfg]
#[include ./macros/prusaslicer-accel.cfg]

##########################
##### THIRD PARTY ########
##########################

[include ./third-party-cfg/nozzle_scrub.cfg]
[include ./kamp/Adaptive_Mesh.cfg]
[include ./kamp/Adaptive_Purge.cfg]

##########################
##### ERCF ###############
##########################


[include ercf_hardware.cfg]
[include ercf_parameters.cfg]
[include ercf_software.cfg]
[include ./calibration/ercf_additional.cfg]
#[include ercf_vars.cfg]
[include client_macros.cfg]

##########################
##### LCD/MENU ###########
##########################

#[include ./third-party-cfg/nozzle_scrub_menu.cfg]
#[include ercf_menu.cfg]
#[include ./menu/printer_menu.cfg]

##########################
##### NOT ENABLED YET ####
##########################

#[include ./todo/mini12864.cfg] Add this after adding mini12864 LED
#[include ./todo/lcd_tweaks.cfg] Need to figure this one out and then implement
#[include ./hardware/nevermore.cfg] Disabled as I prefer to chamber vent outside and needed the PWM

##########################
#### REPLACEMENT #########
##########################

[include ./replacement_macros/replace-m900.cfg]
[include ./replacement_macros/replace-m117.cfg]

[exclude_object]

[gcode_arcs]
resolution: 0.1

[respond]
default_type: echo
default_prefix:  

[force_move]
# Enable commands that force potentially unsafe movement
enable_force_move: True

[idle_timeout]
timeout: 14400

[mcu]
##  Obtain definition by "ls -l /dev/serial/by-id/" then unplug to verify
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_290040000750314D35323820-if00
restart_method: command

[mcu rpi]
# Add Rpi as secondary MCU to allow for ADXL use through SPI ribbon/adapter from LDO
serial: /tmp/klipper_host_mcu

[mcu sht]
canbus_uuid: 30993412e8e0

[printer]
kinematics: corexy
max_velocity: 600           # Changed from 200 on 7.11.23
max_accel:  6000            # tuned on 7.11.23 after beacon install.
max_z_velocity: 15          #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 350
square_corner_velocity: 8.0 # Changed on 7.11.23

#####################################################################
#   Input Shaper
#####################################################################

[input_shaper]
shaper_freq_x: 76.2               ; suggested max_accel <= 22600 mm/sec^2
shaper_type_x: zv
shaper_freq_y: 51.8               ; suggested max_accel <= 7900 mm/sec^2
shaper_type_y: mzv


#####################################################################
#   Bed Heater
#####################################################################

##  SSR Pin - HE1
##  Thermistor - TB
[heater_bed]
heater_pin: PA2 #PA2 is LDO default
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF3
##  Adjust Max Power so your heater doesn't warp your bed. Rule of thumb is 0.4 watts / cm^2 .
max_power: 0.6
min_temp: 0
max_temp: 125
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

#####################################################################
#   Probe
#####################################################################

##  WAS TAP - NOW BEACON in CANBUS
#[probe]
#pin: ^sht:PA2
#x_offset: 0
#y_offset: 25.0
#z_offset: 0
#x_offset: 0
#y_offset: 0
#z_offset: 6.42
#speed: 5.0
#lift_speed: 15
#samples: 3
#samples_result: median
#sample_retract_dist: 2.0
#samples_tolerance: 0.01
#samples_tolerance_retries: 3
# After TAP installation, with PLA, Flow Rate 98%, 0.25mm First Layer, 0.6mm CHT nozzle, Z_Offset is z_offset = -0.450
#activate_gcode:
#    {% set PROBE_TEMP = 150 %}
#    {% set MAX_TEMP = PROBE_TEMP + 5 %}
#    {% set ACTUAL_TEMP = printer.extruder.temperature %}
#    {% set TARGET_TEMP = printer.extruder.target %}
#
#    {% if TARGET_TEMP > PROBE_TEMP %}
#        { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (TARGET_TEMP, PROBE_TEMP)) }
#        M109 S{ PROBE_TEMP }
#    {% else %}
#        # Temperature target is already low enough, but nozzle may still be too hot.
#        {% if ACTUAL_TEMP > MAX_TEMP %}
#            { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (ACTUAL_TEMP, MAX_TEMP)) }
#            TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={ MAX_TEMP }
#        {% endif %}
#    {% endif %}

#####################################################################
#  Filament Runout
#####################################################################

#[filament_motion_sensor RunoutSensor]
#detection_length: 10
#extruder: extruder
#switch_pin: ^PG11
#pause_on_runout: True
#runout_gcode:
#  M117 Filament problem, runout has paused.
#  M118 Filament problem, runout has paused.
#insert_gcode:
#event_delay:
#pause_delay:

#####################################################################
#   Additional Sensors
#####################################################################

[thermistor CMFB103F3950FANT]
temperature1: 0.0
resistance1: 32116.0
temperature2: 40.0
resistance2: 5309.0
temperature3: 80.0
resistance3: 1228.0

#[temperature_sensor sb_ambient_temp]
## Chamber Temperature - T1
#sensor_type: CMFB103F3950FANT
#sensor_pin: PF5
#min_temp: 0
#max_temp: 100
#gcode_id: chamber_th

[temperature_sensor back_chamber_temp]
## Chamber Temperature - T
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PF6
min_temp: 0
max_temp: 100
gcode_id: chamber_th2

[temperature_sensor RPi4]
sensor_type: temperature_host
min_temp: 0
max_temp: 100

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################

#[safe_z_home]
##  XY Location of the Z Endstop Switch
##  Update -10,-10 to the XY coordinates of your endstop pin 
##  (such as 157,305) after going through Z Endstop Pin
##  Location Definition step.
#home_xy_position: 147,256
#speed:100
#z_hop:10
#z_hop_speed:10


########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<5V>

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 39.889
#*# pid_ki = 0.964
#*# pid_kd = 412.851
#*#
#*# [probe]
#*# z_offset = -1.270
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.065318, -0.060934, -0.052240, -0.041727, -0.040621, -0.042635, -0.029445, -0.034279, -0.045262, -0.025934, -0.029445, -0.028617, -0.028681, -0.027998, -0.030014, -0.039737, -0.026974, -0.037125, -0.027406, -0.033846, -0.026583, -0.022737, -0.027969, -0.026034, -0.028951
#*# 	  -0.065717, -0.051685, -0.029537, -0.047938, -0.028060, -0.029307, -0.025587, -0.026073, -0.026615, -0.028838, -0.024064, -0.017703, -0.013621, -0.020355, -0.024546, -0.023385, -0.026629, -0.025800, -0.026475, -0.025461, -0.029792, -0.023633, -0.026346, -0.026659, -0.025124
#*# 	  -0.045383, -0.049572, -0.030589, -0.025718, -0.027868, -0.028667, -0.026302, -0.016093, -0.026215, -0.018793, -0.009554, -0.012807, -0.011306, -0.012188, -0.015597, -0.019574, -0.021839, -0.021067, -0.024830, -0.021537, -0.011479, -0.023085, -0.009508, -0.008719, -0.022227
#*# 	  -0.052475, -0.040295, -0.042462, -0.030757, -0.032636, -0.026911, -0.023292, -0.014030, -0.009922, -0.007752, -0.017595, -0.007079, -0.011003, -0.014004, -0.020331, -0.013493, -0.023334, -0.015188, -0.017840, -0.011322, -0.013083, -0.021146, -0.019961, -0.006979, -0.018257
#*# 	  -0.052427, -0.045679, -0.037846, -0.048825, -0.033226, -0.029108, -0.021025, -0.024712, -0.013516, -0.019355, -0.012819, -0.003916, -0.012879, -0.015682, -0.006698, -0.010266, -0.007555, -0.015810, -0.009567, -0.011124, -0.006785, -0.005088, -0.021376, -0.024151, -0.015241
#*# 	  -0.054073, -0.052929, -0.049019, -0.048422, -0.032154, -0.027319, -0.027665, -0.021044, -0.005435, -0.004813, -0.022338, -0.006929, -0.004491, -0.006351, -0.007400, -0.011863, -0.019053, -0.010251, -0.007448, -0.017789, -0.008134, -0.009765, -0.008919, -0.006768, -0.013896
#*# 	  -0.052876, -0.049649, -0.051852, -0.048337, -0.043313, -0.025920, -0.022656, -0.011761, -0.017517, -0.003888, -0.005836, -0.012540, -0.006631, -0.006040, -0.003655, -0.005160, -0.004772, -0.009588, -0.013709, -0.019079, -0.027431, -0.024649, -0.018907, -0.021224, -0.023574
#*# 	  -0.044751, -0.046889, -0.043536, -0.030393, -0.030947, -0.027143, -0.020907, -0.011041, -0.004623, -0.004782, -0.004030, -0.005681, -0.004813, -0.004846, -0.006026, -0.014087, -0.009534, -0.005221, -0.017371, -0.004946, -0.025768, -0.007777, -0.024303, -0.022139, -0.018269
#*# 	  -0.037980, -0.029521, -0.030260, -0.034059, -0.029534, -0.024502, -0.013066, -0.018765, -0.005763, -0.004515, -0.004276, 0.000879, -0.004482, -0.005795, -0.018752, -0.005678, -0.004673, -0.018171, -0.012231, -0.013729, -0.023243, -0.015908, -0.020961, -0.012301, -0.023248
#*# 	  -0.032663, -0.024351, -0.028448, -0.023692, -0.020322, -0.014818, -0.010893, -0.005563, -0.001578, -0.002501, -0.003997, -0.004787, -0.004464, -0.003900, -0.003898, -0.005247, -0.010808, -0.008838, -0.018897, -0.015597, -0.011505, -0.015343, -0.015654, -0.020611, -0.026364
#*# 	  -0.026257, -0.017957, -0.023752, -0.015203, -0.008108, -0.012118, -0.010552, -0.003345, -0.000782, 0.000692, -0.003362, 0.000367, -0.002707, -0.001183, -0.006811, -0.009527, -0.008204, -0.003342, -0.008653, -0.015442, -0.016450, -0.011099, -0.013642, -0.015783, -0.022579
#*# 	  -0.023583, -0.007038, -0.008810, -0.010396, -0.013750, -0.006015, -0.002689, -0.004703, -0.005857, 0.001587, -0.003728, 0.001870, -0.000948, -0.002497, -0.003486, -0.006566, -0.007685, -0.011023, -0.010520, -0.010293, -0.025469, -0.005734, -0.015958, -0.019996, -0.017545
#*# 	  -0.003464, -0.016184, -0.008381, -0.004155, -0.005866, -0.001052, -0.004059, 0.000513, -0.004216, -0.002165, -0.001193, -0.001900, 0.000000, -0.001967, 0.000384, -0.002466, -0.013895, -0.005895, -0.009895, -0.015210, -0.010974, -0.008676, -0.008262, -0.023388, -0.017983
#*# 	  -0.013880, -0.014275, -0.003978, -0.006481, -0.004181, -0.004840, -0.008001, -0.008172, -0.004199, -0.000339, -0.000942, -0.004597, 0.001634, -0.002768, -0.000493, -0.009038, -0.015893, -0.007874, -0.014769, -0.017885, -0.007763, -0.014834, -0.017951, -0.010730, -0.024947
#*# 	  -0.008777, -0.009691, -0.007527, -0.015513, 0.000724, -0.004155, -0.004286, -0.007640, -0.001364, 0.000243, -0.003681, -0.002510, -0.008087, -0.004854, -0.005944, -0.007902, -0.013362, -0.011850, -0.020913, -0.019701, -0.019027, -0.016143, -0.026482, -0.014916, -0.022512
#*# 	  -0.009921, -0.010551, -0.007300, -0.009741, 0.003776, 0.001588, -0.007769, 0.000719, -0.001803, -0.002433, -0.000146, 0.001942, -0.001470, -0.003518, -0.001621, -0.008269, -0.009694, -0.016281, -0.006896, -0.016067, -0.015403, -0.014260, -0.010131, -0.010054, -0.011562
#*# 	  -0.003475, 0.004071, -0.006702, -0.006258, 0.003179, -0.005774, -0.010281, 0.000008, -0.001099, 0.002340, -0.000261, 0.001822, 0.002043, 0.003350, -0.001551, -0.002750, -0.004874, -0.008833, -0.006089, -0.009143, -0.010473, -0.008853, -0.003907, -0.008309, -0.018269
#*# 	  -0.005112, 0.003338, 0.000557, -0.004923, 0.000412, 0.001180, 0.000614, 0.001103, 0.002892, 0.007351, 0.002115, 0.005121, -0.000803, 0.002343, 0.000289, 0.000342, -0.009754, -0.003148, -0.004998, -0.010328, -0.010604, 0.001094, -0.009801, -0.010383, -0.008187
#*# 	  0.006930, 0.008382, 0.002621, -0.003511, 0.002123, 0.009065, 0.001433, -0.009754, 0.001593, 0.002699, 0.006639, 0.005760, 0.006973, 0.006930, 0.003072, 0.002471, 0.002207, -0.001010, -0.011331, 0.001860, -0.002556, 0.003964, -0.006392, -0.002666, -0.007739
#*# 	  -0.002180, -0.004340, 0.008750, 0.008090, 0.005678, -0.003024, 0.001266, 0.002727, -0.001196, 0.007689, 0.005624, 0.008003, 0.007859, 0.003579, -0.001380, -0.007635, -0.001925, -0.013485, -0.003758, -0.004867, -0.005735, -0.011053, -0.009827, -0.010080, -0.013583
#*# 	  0.006323, 0.006246, 0.004694, -0.003407, 0.002267, -0.006958, 0.004175, 0.003270, 0.000653, 0.004794, 0.004413, 0.004582, -0.000006, 0.001586, 0.000157, -0.002196, -0.012154, -0.012191, -0.010698, -0.010953, -0.012289, -0.011700, -0.017507, -0.008526, -0.018313
#*# 	  -0.005725, 0.000570, -0.000294, -0.003126, 0.001391, -0.002435, 0.006991, 0.004025, 0.002664, 0.004350, 0.004585, 0.000982, -0.005338, 0.001567, -0.010276, -0.007912, -0.008687, -0.014092, -0.009095, -0.013063, -0.019327, -0.014379, -0.021704, -0.020124, -0.023060
#*# 	  0.006376, 0.001408, 0.003654, -0.006520, 0.000624, -0.000021, -0.011451, 0.007955, -0.012835, -0.013131, 0.003537, 0.001789, -0.004681, -0.006039, -0.006022, -0.013706, -0.015871, -0.017911, -0.014228, -0.015526, -0.015341, -0.021459, -0.019010, -0.020872, -0.028423
#*# 	  0.008844, 0.006625, 0.004714, 0.008716, 0.009070, -0.010246, 0.000393, 0.005863, -0.002173, -0.004910, -0.009181, -0.006237, -0.013976, -0.012598, -0.016966, -0.016718, -0.015074, -0.016358, -0.016953, -0.016929, -0.016110, -0.020657, -0.021235, -0.023815, -0.029647
#*# 	  0.007352, -0.004847, 0.003940, -0.002119, -0.001981, -0.010895, -0.011889, -0.002056, -0.009669, -0.012737, -0.013882, -0.015071, -0.014395, -0.015618, -0.018149, -0.016953, -0.027088, -0.026070, -0.031057, -0.029410, -0.029018, -0.036601, -0.036457, -0.038887, -0.039377
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 210.0
#*# min_y = 30.0
#*# max_y = 210.0
#*#
#*# [beacon model default]
#*# model_coef = 1.9257982386737142,
#*# 	  2.1904011986275074,
#*# 	  0.5881661108028357,
#*# 	  0.30341866940870527,
#*# 	  0.14823890288711727,
#*# 	  -0.42807822476666274,
#*# 	  -0.13716254071061182,
#*# 	  0.612855529187592,
#*# 	  0.08376843001203003,
#*# 	  -0.2664564217100284
#*# model_domain = 3.352922478536077e-07,3.360945745364866e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 72.578002
#*# model_offset = -0.19000
