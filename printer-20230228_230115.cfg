##########################
##### BASE CONFIG #######
##########################

[include mainsail.cfg]

##########################
##### HARDWARE STUFF #####
##########################

[include ./hardware/xyz-stepper.cfg]
[include ./hardware/extruder.cfg]
[include ./klicky/klicky-probe.cfg]
[include ./hardware/adxl345.cfg]
[include ./hardware/nevermore.cfg]
[include ./hardware/fans.cfg]

##########################
##### LIGHTS #############
##########################

[include ./hardware/chamber-lighting.cfg]
[include ./hardware/stealthburner-led.cfg]

##########################
##### CALIBRATION ########
##########################

[include ./calibration/z-tilt.cfg]
[include ./calibration/bed-mesh.cfg]
[include ./macros/unsafe.cfg]
#[include ./calibration/z-calibrate.cfg]

##########################
##### MACROS #############
##########################

[include ./macros/chamber-led.cfg]
[include ./macros/conditional-homing.cfg]
[include ./macros/print-start-end.cfg]
[include ./macros/dump-variables.cfg]
[include ./macros/movement-check.cfg]
[include ./macros/cancel-change.cfg]
[include ./macros/pause-resume.cfg]
[include ./macros/load-unload.cfg]
[include ./macros/filament-change.cfg]
[include ./macros/park.cfg]
[include ./macros/prusaslicer-accel.cfg]

##########################
##### THIRD PARTY ########
##########################

#[include ./third-party-cfg/print_area_bed_mesh.cfg]
[include ./third-party-cfg/nozzle_scrub.cfg]
[include ./kamp/Adaptive_Mesh.cfg]
[include ./kamp/Adaptive_Purge.cfg]

##########################
##### LCD/MENU ###########
##########################

#[include ./third-party-cfg/nozzle_scrub_menu.cfg]

##########################
##### NOT ENABLED YET ####
##########################

#[include ./todo/mini12864.cfg] Add this after adding mini12864 LED
#[include ./todo/lcd_tweaks.cfg] Need to figure this one out and then implement

##########################
##########################
##########################

[exclude_object]

[force_move]
# Enable commands that force potentially unsafe movement
enable_force_move: True

[idle_timeout]
timeout: 14400

[mcu]
##  Obtain definition by "ls -l /dev/serial/by-id/" then unplug to verify
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_290040000750314D35323820-if00
restart_method: command

[mcu rpi]
# Add Rpi as secondary MCU to allow for ADXL use through SPI ribbon/adapter from LDO
serial: /tmp/klipper_host_mcu

[printer]
kinematics: corexy
max_velocity: 300  
max_accel: 9000
max_z_velocity: 15          #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 350
square_corner_velocity: 5.0

#####################################################################
#   Input Shaper
#####################################################################

[input_shaper]
shaper_freq_x: 60.4               ; suggested max_accel <= 10700 mm/sec^2
shaper_type_x: mzv
shaper_freq_y: 70.8               ; suggested max_accel <= 14800 mm/sec^2
shaper_type_y: mzv


#####################################################################
#   Bed Heater
#####################################################################

##  SSR Pin - HE1
##  Thermistor - TB
[heater_bed]
heater_pin: PA2 #PA2 is LDO default
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF3
##  Adjust Max Power so your heater doesn't warp your bed. Rule of thumb is 0.4 watts / cm^2 .
max_power: 0.6
min_temp: 0
max_temp: 120
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

#####################################################################
#   Probe
#####################################################################

##  Inductive Probe
##  This probe is not used for Z height, only Quad Gantry Leveling
[probe]
pin: ^PG15
#x_offset: 0
#y_offset: 25.0
#z_offset: 0
x_offset: 0
y_offset: 19.75
#z_offset: 6.42
speed: 5.0
samples: 3
samples_result: median
sample_retract_dist: 2.0
samples_tolerance: 0.01
samples_tolerance_retries: 3

#####################################################################
#  Filament Runout
#####################################################################

[filament_motion_sensor RunoutSensor]
detection_length: 7
extruder: extruder
switch_pin: ^PG11
pause_on_runout: True
runout_gcode:
  M117 Filament problem, runout has paused.
  M118 Filament problem, runout has paused.
#insert_gcode:
#event_delay:
#pause_delay:

#####################################################################
#   Additional Sensors
#####################################################################

[thermistor CMFB103F3950FANT]
temperature1: 0.0
resistance1: 32116.0
temperature2: 40.0
resistance2: 5309.0
temperature3: 80.0
resistance3: 1228.0

[temperature_sensor printhead_ambient_temp]
## Chamber Temperature - T1
sensor_type: CMFB103F3950FANT
sensor_pin: PF5
min_temp: 0
max_temp: 100
gcode_id: chamber_th

[temperature_sensor back_chamber_temp]
## Chamber Temperature - T
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PF6
min_temp: 0
max_temp: 100
gcode_id: chamber_th2

[temperature_sensor RPi4]
sensor_type: temperature_host
min_temp: 0
max_temp: 100

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################

#[safe_z_home]
##  XY Location of the Z Endstop Switch
##  Update -10,-10 to the XY coordinates of your endstop pin 
##  (such as 157,305) after going through Z Endstop Pin
##  Location Definition step.
#home_xy_position: 147,256
#speed:100
#z_hop:10
#z_hop_speed:10


########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<5V>

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 39.889
#*# pid_ki = 0.964
#*# pid_kd = 412.851
#*#
#*# [probe]
#*# z_offset = 6.130
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.025625, 0.020000, 0.022500, 0.025000
#*# 	  0.010625, 0.018750, 0.023750, 0.033125
#*# 	  0.000000, 0.027500, 0.051250, 0.036250
#*# 	  0.020625, 0.026875, 0.050625, 0.047500
#*# x_count = 4
#*# y_count = 4
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = lagrange
#*# tension = 0.2
#*# min_x = 74.5
#*# max_x = 175.48
#*# min_y = 74.5
#*# max_y = 175.48
