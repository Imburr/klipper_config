##########################
##### BASE CONFIG #######
##########################

[include mainsail.cfg]
[include ./backup/backup.cfg]

##########################
##### HARDWARE STUFF #####
##########################

[include ./hardware/xyz-stepper.cfg]
[include ./hardware/extruder.cfg]
#[include ./klicky/klicky-probe.cfg]
#[include ./hardware/adxl345.cfg]  This config now in canbus.cfg
[include ./hardware/fans.cfg] # Some fans config in canbus.cfg
[include ./hardware/canbus.cfg]

##########################
##### LIGHTS #############
##########################

[include ./hardware/chamber-lighting.cfg]
[include ./hardware/stealthburner-led.cfg]

##########################
##### CALIBRATION ########
##########################

[include ./calibration/z-tilt.cfg]
[include ./calibration/bed-mesh.cfg]
[include ./macros/unsafe.cfg]
[include ./calibration/pressure_advance.cfg]
[include ./calibration/test_speed.cfg]
[include test_probe_accuracy.cfg]

##########################
##### MACROS #############
##########################

[include ./macros/chamber-led.cfg]
[include ./macros/conditional-homing.cfg]
[include ./macros/print-end.cfg]
[include ./macros/print-start-mmu.cfg]
[include ./macros/dump-variables.cfg]
[include ./macros/movement-check.cfg]
[include ./macros/cancel-change.cfg]
[include ./macros/pause-resume.cfg]         ; Overridden by ERCF / subsequantly disabled
[include ./macros/load-unload.cfg]
[include ./macros/filament-change.cfg]
[include ./macros/park.cfg]
#[include ./macros/prusaslicer-accel.cfg]

##########################
##### THIRD PARTY ########
##########################

#[include ./third-party-cfg/nozzle_scrub.cfg]
[include KAMP_Settings.cfg]

##########################
##### ERCF ###############
##########################


[include ercf_hardware.cfg]
[include ercf_parameters.cfg]
[include ercf_software.cfg]
[include ./calibration/ercf_additional.cfg]
#[include ercf_vars.cfg]
#[include client_macros.cfg]

##########################
##### LCD/MENU ###########
##########################

#[include ./third-party-cfg/nozzle_scrub_menu.cfg]
#[include ercf_menu.cfg]
#[include ./menu/printer_menu.cfg]

##########################
##### NOT ENABLED YET ####
##########################

#[include ./todo/mini12864.cfg] Add this after adding mini12864 LED
#[include ./todo/lcd_tweaks.cfg] Need to figure this one out and then implement
#[include ./hardware/nevermore.cfg] Disabled as I prefer to chamber vent outside and needed the PWM

##########################
#### REPLACEMENT #########
##########################

[include ./replacement_macros/replace-m900.cfg]
[include ./replacement_macros/replace-m117.cfg]

[exclude_object]

[gcode_arcs]
resolution: 0.1

[respond]
default_type: echo
default_prefix:  

[force_move]
# Enable commands that force potentially unsafe movement
enable_force_move: True

[idle_timeout]
timeout: 14400

[mcu]
##  Obtain definition by "ls -l /dev/serial/by-id/" then unplug to verify
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_290040000750314D35323820-if00
restart_method: command

[mcu rpi]
# Add Rpi as secondary MCU to allow for ADXL use through SPI ribbon/adapter from LDO
serial: /tmp/klipper_host_mcu

[mcu sht]
canbus_uuid: 30993412e8e0

[printer]
kinematics: corexy
max_velocity: 200           # Changed from 200 on 7.11.23
max_accel:  6000            # tuned on 7.11.23 after beacon install.
max_z_velocity: 15          #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 350
square_corner_velocity: 5.0 # Changed on 7.11.23

#####################################################################
#   Input Shaper
#####################################################################

[input_shaper]
#shaper_freq_x: 76.2               ; suggested max_accel <= 22600 mm/sec^2
#shaper_type_x: zv
#shaper_freq_y: 51.8               ; suggested max_accel <= 7900 mm/sec^2
#shaper_type_y: mzv


#####################################################################
#   Bed Heater
#####################################################################

##  SSR Pin - HE1
##  Thermistor - TB
[heater_bed]
heater_pin: PA2 #PA2 is LDO default
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF3
##  Adjust Max Power so your heater doesn't warp your bed. Rule of thumb is 0.4 watts / cm^2 .
max_power: 0.6
min_temp: 0
max_temp: 125
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

#####################################################################
#   Probe
#####################################################################

##  WAS TAP - NOW BEACON in CANBUS
#[probe]
#pin: ^sht:PA2
#x_offset: 0
#y_offset: 25.0
#z_offset: 0
#x_offset: 0
#y_offset: 0
#z_offset: 6.42
#speed: 5.0
#lift_speed: 15
#samples: 3
#samples_result: median
#sample_retract_dist: 2.0
#samples_tolerance: 0.01
#samples_tolerance_retries: 3
# After TAP installation, with PLA, Flow Rate 98%, 0.25mm First Layer, 0.6mm CHT nozzle, Z_Offset is z_offset = -0.450
#activate_gcode:
#    {% set PROBE_TEMP = 150 %}
#    {% set MAX_TEMP = PROBE_TEMP + 5 %}
#    {% set ACTUAL_TEMP = printer.extruder.temperature %}
#    {% set TARGET_TEMP = printer.extruder.target %}
#
#    {% if TARGET_TEMP > PROBE_TEMP %}
#        { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (TARGET_TEMP, PROBE_TEMP)) }
#        M109 S{ PROBE_TEMP }
#    {% else %}
#        # Temperature target is already low enough, but nozzle may still be too hot.
#        {% if ACTUAL_TEMP > MAX_TEMP %}
#            { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (ACTUAL_TEMP, MAX_TEMP)) }
#            TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={ MAX_TEMP }
#        {% endif %}
#    {% endif %}

#####################################################################
#  Filament Runout
#####################################################################

#[filament_motion_sensor RunoutSensor]
#detection_length: 10
#extruder: extruder
#switch_pin: ^PG11
#pause_on_runout: True
#runout_gcode:
#  M117 Filament problem, runout has paused.
#  M118 Filament problem, runout has paused.
#insert_gcode:
#event_delay:
#pause_delay:

#####################################################################
#   Additional Sensors
#####################################################################

[thermistor CMFB103F3950FANT]
temperature1: 0.0
resistance1: 32116.0
temperature2: 40.0
resistance2: 5309.0
temperature3: 80.0
resistance3: 1228.0

#[temperature_sensor sb_ambient_temp]
## Chamber Temperature - T1
#sensor_type: CMFB103F3950FANT
#sensor_pin: PF5
#min_temp: 0
#max_temp: 100
#gcode_id: chamber_th

[temperature_sensor back_chamber_temp]
## Chamber Temperature - T
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PF6
min_temp: 0
max_temp: 100
gcode_id: chamber_th2

[temperature_sensor RPi4]
sensor_type: temperature_host
min_temp: 0
max_temp: 100

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################

#[safe_z_home]
##  XY Location of the Z Endstop Switch
##  Update -10,-10 to the XY coordinates of your endstop pin 
##  (such as 157,305) after going through Z Endstop Pin
##  Location Definition step.
#home_xy_position: 147,256
#speed:100
#z_hop:10
#z_hop_speed:10


########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<5V>

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 39.889
#*# pid_ki = 0.964
#*# pid_kd = 412.851
#*#
#*# [probe]
#*# z_offset = -1.270
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.092692, -0.075638, -0.086425, -0.073009, -0.069834, -0.072577, -0.067999, -0.067797, -0.064316, -0.052486, -0.049399, -0.048646, -0.049831, -0.050305, -0.049285, -0.053270, -0.062634, -0.066092, -0.059635, -0.057445, -0.059372, -0.057883, -0.050100, -0.050273, -0.061796
#*# 	  -0.090051, -0.073021, -0.068626, -0.063932, -0.059617, -0.053556, -0.049875, -0.048370, -0.048074, -0.046039, -0.042031, -0.048060, -0.048138, -0.041925, -0.046845, -0.048383, -0.048591, -0.047254, -0.047234, -0.045414, -0.045959, -0.045889, -0.044652, -0.040545, -0.042315
#*# 	  -0.072776, -0.065743, -0.059824, -0.058369, -0.048754, -0.040167, -0.043949, -0.037241, -0.046325, -0.025228, -0.029312, -0.026236, -0.030294, -0.024460, -0.028740, -0.029814, -0.026672, -0.026384, -0.031841, -0.025646, -0.026218, -0.030703, -0.026651, -0.024778, -0.024178
#*# 	  -0.074461, -0.064406, -0.052895, -0.048308, -0.046668, -0.042728, -0.037606, -0.031025, -0.025416, -0.026026, -0.024720, -0.024676, -0.025191, -0.025001, -0.026080, -0.023586, -0.025398, -0.024883, -0.025172, -0.025417, -0.022094, -0.024347, -0.022773, -0.019866, -0.024647
#*# 	  -0.071908, -0.059192, -0.048947, -0.052678, -0.048226, -0.039068, -0.025323, -0.024891, -0.020557, -0.022216, -0.017270, -0.018652, -0.018017, -0.018116, -0.019869, -0.019493, -0.024101, -0.022388, -0.017549, -0.013943, -0.017614, -0.013119, -0.018391, -0.008904, -0.016585
#*# 	  -0.069041, -0.054441, -0.049381, -0.049177, -0.047217, -0.037540, -0.027853, -0.023150, -0.019414, -0.011349, -0.001962, -0.020242, -0.009800, -0.012086, -0.001926, -0.008394, -0.004179, 0.001189, -0.004400, -0.020517, -0.008364, -0.002503, -0.001840, -0.012342, -0.008917
#*# 	  -0.061669, -0.047575, -0.050027, -0.049464, -0.047122, -0.039716, -0.025347, -0.018445, -0.011994, -0.002181, -0.008771, -0.003372, -0.002439, -0.004236, -0.009955, -0.001450, -0.004427, -0.001184, -0.001992, -0.002161, -0.002810, -0.001884, -0.001587, -0.001463, -0.002994
#*# 	  -0.053560, -0.048204, -0.048403, -0.048530, -0.038373, -0.028596, -0.024545, -0.016753, -0.007188, -0.003254, -0.006537, -0.001591, -0.002329, -0.000508, -0.001284, -0.001130, -0.000311, -0.001524, -0.001753, -0.001984, -0.000158, -0.000001, -0.000824, -0.001556, -0.001189
#*# 	  -0.047399, -0.044913, -0.042287, -0.039214, -0.025570, -0.027097, -0.017036, -0.011343, -0.004447, -0.000373, -0.000493, 0.000331, -0.000638, 0.001068, -0.000087, -0.000555, -0.000406, -0.000638, 0.005650, 0.000712, 0.001623, -0.000783, -0.000515, 0.000723, 0.002648
#*# 	  -0.032627, -0.024759, -0.029850, -0.028114, -0.024639, -0.021229, -0.008159, -0.003131, -0.003401, 0.001388, 0.002117, 0.003117, 0.007841, 0.006910, 0.003763, 0.006963, 0.006052, 0.005221, 0.009803, 0.005835, 0.004830, 0.006087, 0.007036, 0.005837, 0.001762
#*# 	  -0.025907, -0.024709, -0.024751, -0.022143, -0.019799, -0.014331, -0.001794, -0.003286, 0.000147, 0.002504, 0.005135, 0.005251, 0.004859, 0.007350, 0.011288, 0.012198, 0.011278, 0.008523, 0.010287, 0.006230, 0.012724, 0.007229, 0.011668, 0.016743, 0.009206
#*# 	  -0.023906, -0.019525, -0.018740, -0.012630, -0.000816, -0.001339, 0.000381, 0.007924, 0.004384, 0.008545, 0.010824, 0.002949, 0.017949, 0.005156, 0.015811, 0.023115, 0.014630, 0.011731, 0.021548, -0.000982, 0.023538, 0.002241, 0.011322, 0.023183, 0.021085
#*# 	  -0.018224, -0.014873, -0.024060, -0.019776, -0.003801, -0.001081, -0.000458, 0.002244, 0.005220, 0.008779, 0.023066, 0.021915, 0.020238, 0.020850, 0.020722, 0.019199, 0.021103, 0.022079, 0.017974, 0.016941, 0.022841, 0.021615, 0.023184, 0.023573, 0.021919
#*# 	  -0.018146, -0.018360, -0.013556, -0.001106, -0.002041, -0.001347, -0.000296, -0.000780, 0.006446, 0.010914, 0.013125, 0.012995, 0.022417, 0.011682, 0.015047, 0.023570, 0.010377, 0.016345, 0.018754, 0.021383, 0.021290, 0.024350, 0.021683, 0.022586, 0.022643
#*# 	  -0.022710, -0.017863, -0.008331, -0.015331, -0.015958, -0.001273, -0.000579, -0.000162, 0.005545, 0.005124, 0.003608, 0.007254, 0.009136, 0.002256, 0.020432, 0.024018, 0.006201, 0.019728, 0.022766, 0.020070, 0.022182, 0.022753, 0.023008, 0.024619, 0.022805
#*# 	  -0.018429, -0.011448, -0.012125, -0.001260, -0.001797, -0.001574, 0.000367, -0.000378, 0.000765, 0.003205, 0.006193, 0.010061, 0.023542, 0.018868, 0.011555, 0.005952, 0.019315, 0.021792, 0.023114, 0.023354, 0.023369, 0.025196, 0.025617, 0.031083, 0.027744
#*# 	  -0.016127, -0.014262, -0.003696, -0.008006, -0.001358, -0.001369, 0.001677, 0.001823, 0.005555, 0.011662, -0.000305, 0.021501, 0.021228, 0.020112, 0.020898, 0.023091, 0.022588, 0.024291, 0.023634, 0.027116, 0.031635, 0.035748, 0.026699, 0.044629, 0.036967
#*# 	  0.000280, -0.004246, -0.001573, -0.000928, -0.000627, -0.000249, 0.001127, 0.006194, 0.007582, 0.020934, 0.021856, 0.021865, 0.022708, 0.023010, 0.024314, 0.023750, 0.024147, 0.026852, 0.030169, 0.034606, 0.045521, 0.047766, 0.044219, 0.044327, 0.041441
#*# 	  -0.020823, -0.001428, -0.003348, -0.001482, 0.000027, -0.001029, 0.001921, 0.005780, 0.005894, 0.001685, 0.023150, 0.019294, 0.022240, 0.023729, 0.023573, 0.026165, 0.029244, 0.026858, 0.031529, 0.033675, 0.035929, 0.044930, 0.039572, 0.045982, 0.047159
#*# 	  -0.011198, -0.017101, -0.005863, -0.001839, -0.008441, -0.003680, -0.000860, -0.000634, 0.001594, 0.011712, 0.023091, 0.021285, 0.021469, 0.023209, 0.022356, 0.023345, 0.023717, 0.026370, 0.026012, 0.031048, 0.038107, 0.045722, 0.041181, 0.043419, 0.041685
#*# 	  -0.018820, -0.014280, -0.003690, -0.001078, -0.004361, -0.004117, -0.001438, -0.000539, -0.000069, 0.006735, 0.007572, 0.023052, 0.008542, 0.018802, 0.022534, 0.020874, 0.022555, 0.023152, 0.022918, 0.024827, 0.027837, 0.031068, 0.045620, 0.043012, 0.030298
#*# 	  -0.018718, -0.011755, -0.012364, -0.000247, -0.008716, -0.004438, -0.000523, -0.000743, 0.000595, 0.007985, 0.007427, 0.009810, 0.015394, 0.018834, 0.017345, 0.021858, 0.023156, 0.023629, 0.022588, 0.023109, 0.025869, 0.033644, 0.032670, 0.045319, 0.038039
#*# 	  -0.020706, -0.019980, -0.015124, -0.007398, -0.012758, -0.005410, -0.000736, -0.001088, -0.000380, -0.000099, 0.005065, 0.010131, 0.011326, 0.010008, 0.021712, 0.020760, 0.020412, 0.019620, 0.022717, 0.024048, 0.024634, 0.026622, 0.031444, 0.034725, 0.028809
#*# 	  -0.025622, -0.018872, -0.019185, -0.015186, -0.021008, -0.011090, -0.003315, -0.003887, -0.002288, -0.001085, -0.000598, 0.002637, 0.004111, 0.008554, 0.010012, 0.007617, 0.010945, 0.002451, 0.020138, 0.018818, 0.020639, 0.023891, 0.026333, 0.030774, 0.029443
#*# 	  -0.026422, -0.026634, -0.024124, -0.021675, -0.021555, -0.019161, -0.015187, -0.017022, -0.014821, 0.000318, -0.000915, -0.003467, -0.001710, -0.000243, 0.000114, 0.000306, 0.000912, 0.005583, 0.006295, 0.006439, 0.008515, 0.017066, 0.022164, 0.022268, 0.021084
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 210.0
#*# min_y = 30.0
#*# max_y = 210.0
#*#
#*# [beacon model default]
#*# model_coef = 1.9257982386737142,
#*# 	2.1904011986275074,
#*# 	0.5881661108028357,
#*# 	0.30341866940870527,
#*# 	0.14823890288711727,
#*# 	-0.42807822476666274,
#*# 	-0.13716254071061182,
#*# 	0.612855529187592,
#*# 	0.08376843001203003,
#*# 	-0.2664564217100284
#*# model_domain = 3.352922478536077e-07,3.360945745364866e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 72.578002
#*# model_offset = -0.29500
#*#
#*# [input_shaper]
#*# shaper_type_x = zv
#*# shaper_freq_x = 77.4
#*# shaper_type_y = mzv
#*# shaper_freq_y = 51.6
