##########################
##### BASE CONFIG #######
##########################

[include mainsail.cfg]
[include ./backup/backup.cfg]

##########################
##### HARDWARE STUFF #####
##########################

[include ./hardware/xyz-stepper.cfg]
[include ./hardware/extruder.cfg]
[include ./hardware/fans.cfg] # Some fans config in canbus.cfg
[include ./hardware/canbus.cfg]

##########################
##### LIGHTS #############
##########################

[include ./hardware/led.cfg]

##########################
##### CALIBRATION ########
##########################

[include ./calibration/z-tilt.cfg]
[include ./calibration/bed-mesh.cfg]
[include ./macros/unsafe.cfg]
[include ./calibration/pressure_advance.cfg]
[include ./calibration/test_speed.cfg]
[include ./calibration/homing.cfg]
[include ./calibration/test_probe_accuracy.cfg]
[include K-ShakeTune/*.cfg]

##########################
##### MACROS #############
##########################

[include ./macros/chamber-led.cfg]
[include ./macros/conditional-homing.cfg]
[include ./macros/print-end.cfg]
[include ./macros/print-start-mmu.cfg]
[include ./macros/print-start.cfg]
[include ./macros/dump-variables.cfg]
[include ./macros/movement-check.cfg]
[include ./macros/cancel-change.cfg]
[include ./macros/pause-resume.cfg]         ; Overridden by ERCF / subsequantly disabled
[include ./macros/load-unload.cfg]
[include ./macros/filament-change.cfg]
[include ./macros/park.cfg]
[include ./macros/heatsoak.cfg]
[include ./macros/line-purge.cfg]
#[include ./macros/nozzle_scrub.cfg]

##########################
##### THIRD PARTY ########
##########################

[include KAMP_Settings.cfg]
#[include ./KOMB/KOMB.cfg]

##########################
##### ERCF ###############
##########################

[include mmu/base/mmu.cfg]
[include mmu/base/mmu_hardware.cfg]
[include mmu/base/mmu_software.cfg]
[include mmu/base/mmu_parameters.cfg]
[include mmu/base/mmu_sequence.cfg]
[include mmu/base/mmu_form_tip.cfg]
[include mmu/base/mmu_leds.cfg]
[include mmu/base/mmu_macro_vars.cfg]
[include mmu/base/mmu_state.cfg]
[include mmu/base/mmu_cut_tip.cfg]
#[include mmu/optional/mmu_menu.cfg]
[include ./macros/mmu_adds.cfg]

#[include mmu/addons/mmu_erec_cutter_hw.cfg]
#[include mmu/addons/mmu_erec_cutter.cfg]

##########################
##### LCD/MENU ###########
##########################


##########################
##### NOT ENABLED YET ####
##########################


##########################
#### REPLACEMENT #########
##########################

[include ./replacement_macros/replace-m117.cfg]

[exclude_object]

[gcode_arcs]
resolution: 0.1

[respond]
default_type: echo
default_prefix:  

[force_move]
# Enable commands that force potentially unsafe movement
enable_force_move: True

[idle_timeout]
timeout: 14400

[mcu]
##  Obtain definition by "ls -l /dev/serial/by-id/" then unplug to verify
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_290040000750314D35323820-if00
restart_method: command

[mcu rpi]
# Add Rpi as secondary MCU to allow for ADXL use through SPI ribbon/adapter from LDO
serial: /tmp/klipper_host_mcu

[mcu sht]
canbus_uuid: f4416bafceb2 # FLY-SHT36 v2 Ordered from Etsy on 2/12/24

#[mcu mmb]  See MMU.CFG in ERCF Confog
#canbus_uuid: a7f4653c0a73

[printer]
kinematics: corexy           # TESTING HIGHER SPEEDS ON 2/7/24 DUE TO SLICER SLOWWWWWWWW / ALSO SET IN PRINT START
max_velocity: 350            # Changed from 200 on 7.11.23
max_accel: 6000             # tuned on 7.11.23 after beacon install.
#max_accel_to_decel:5000
max_z_velocity: 15           #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 350
square_corner_velocity: 5.0 # Changed on 7.11.23

#####################################################################
#   Input Shaper
#####################################################################

[input_shaper]
shaper_freq_x: 71.0
shaper_type_x: mzv # 14900
shaper_freq_y: 47.8
shaper_type_y: mzv # 6700
damping_ratio_x: 0.043
damping_ratio_y: 0.055
# Not Noisy: 20-22.5 / 60.6-96.7 / 30.2-48 / 111.4-200 mm/s

#####################################################################
#   Axis Twist
#####################################################################

[axis_twist_compensation]
#speed: 50
#   The speed (in mm/s) of non-probing moves during the calibration.
#   The default is 50.
#horizontal_move_z: 5
#   The height (in mm) that the head should be commanded to move to
#   just prior to starting a probe operation. The default is 5.
calibrate_start_x: 20
#   Defines the minimum X coordinate of the calibration
#   This should be the X coordinate that positions the nozzle at the starting
#   calibration position. This parameter must be provided.
calibrate_end_x: 230
#   Defines the maximum X coordinate of the calibration
#   This should be the X coordinate that positions the nozzle at the ending
#   calibration position. This parameter must be provided.
calibrate_y: 127.5
#   Defines the Y coordinate of the calibration
#   This should be the Y coordinate that positions the nozzle during the
#   calibration process. This parameter must be provided and is recommended to
#   be near the center of the bed


#####################################################################
#   AutoTune / https://github.com/andrewmcgr/klipper_tmc_autotune
#####################################################################

#[motor_constants ldo-42sth48-2004mah_vrn]
#resistance: 1.45
#inductance: 0.002
#holding_torque: 0.40
#max_current: 2.0
#steps_per_revolution: 400

#[autotune_tmc stepper_x]
#motor: ldo-42sth48-2004mah_vrn
#sg4_thrs: 105
#tuning_goal: silent
#[autotune_tmc stepper_y]
#motor: ldo-42sth48-2004mah_vrn
#tuning_goal: silent

#[autotune_tmc stepper_z]
#motor: ldo-42sth40-1684l300e
#[autotune_tmc stepper_z1]
#motor: ldo-42sth40-1684l300e
#[autotune_tmc stepper_z2]
#motor: ldo-42sth40-1684l300e

#[autotune_tmc extruder]
#motor: moons-cse14hra1l410a

#####################################################################
#   Bed Heater
#####################################################################

##  SSR Pin - HE1
##  Thermistor - TB
[heater_bed]
heater_pin: PA2 #PA2 is LDO default
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF3
##  Adjust Max Power so your heater doesn't warp your bed. Rule of thumb is 0.4 watts / cm^2 .
max_power: 1
min_temp: 0
max_temp: 125
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

#####################################################################
#   TEMPORARY
#####################################################################

##  WAS TAP - NOW BEACON in CANBUS

#[beacon]
#serial: /dev/serial/by-path/platform-fd500000.pcie-pci-0000:01:00.0-usb-0:1.3.4:1.0
#serial: /dev/serial/by-path/platform-fd500000.pcie-pci-0000:01:00.0-usb-0:1.3.4:1.0
#   Path to the serial port for the beacon device. Typically has the form
#   /dev/serial/by-id/usb-Beacon_Beacon_...
#speed: 5
#   Z probing dive speed.
#lift_speed: 10
#   Z probing lift speed.
#backlash_comp: 0.5
#   Backlash compensation distance for removing Z backlash before measuring
#   the sensor response.
#x_offset: 0.
#   X offset of beacon from the nozzle.
#y_offset: 21.953
#   Y offset of beacon from the nozzle.
#z_settling_time: 1000
#   Time to wait after dropping Z to read to avoid ringing.
#trigger_distance: 2.
#   Beacon trigger distance for homing.
#trigger_dive_threshold: 1.
#   Threshold for range vs dive mode probing. Beyond `trigger_distance +
#   trigger_dive_threshold` a dive will be used.
#trigger_hysteresis: 0.006
#   Hysteresis on trigger threshold for untriggering, as a percentage of the
#   trigger threshold.
#cal_nozzle_z: 0.1
#   Expected nozzle offset after completing manual Z offset calibration.
#cal_floor: 0.2
#   Minimum z bound on sensor response measurement.
#cal_ceil: 5.
#   Maximum z bound on sensor response measurement.
#cal_speed: 1.
#   Speed while measuring response curve.
#cal_move_speed: 10.
#   Speed while moving to position for response curve measurement.
#default_model_name: default
#   Name of default beacon model to load.
#mesh_main_direction: x
#   Primary travel direction during mesh measurement.
#mesh_overscan: -1
#   Distance to use for direction changes at mesh line ends. Omit this setting
#   and a default will be calculated from line spacing and available travel.
#mesh_cluster_size: 1
#   Radius of mesh grid point clusters.
#mesh_runs: 2
#   Number of passes to make during mesh scan.

#####################################################################
#   TEMPORARY
#####################################################################

#   Connected to MOTOR_6
#   Heater - HE0
#   Thermistor - T0
#[extruder]
#step_pin: PE2
#dir_pin: PE3
#enable_pin: !PD4
##  Update value below when you perform extruder calibration
##  If you ask for 100mm of filament, but in reality it is 98mm:
##  rotation_distance = <previous_rotation_distance> * <actual_extrude_distance> / 100
##  22.6789511 is a good starting point
#rotation_distance: 22.6789511   #Bondtech 5mm Drive Gears
##  Update Gear Ratio depending on your Extruder Type
##  Use 50:10 for Stealthburner/Clockwork 2
##  Use 50:17 for Afterburner/Clockwork (BMG Gear Ratio)
##  Use 80:20 for M4, M3.1
#gear_ratio: 50:10
#microsteps: 32
#full_steps_per_rotation: 200    #200 for 1.8 degree, 400 for 0.9 degree
#nozzle_diameter: 0.400
#filament_diameter: 1.75
## Octopus 1.0 & 1.1.  Octopus PRO 1.0
#heater_pin: PA2
## Octopus PRO 1.1
#heater_pin: PA0
## Check what thermistor type you have. See https://www.klipper3d.org/Config_Reference.html#common-thermistors for common thermistor types.
## Use "Generic 3950" for NTC 100k 3950 thermistors
#sensor_type: ATC Semitec 104NT-4-R025H42G
#sensor_pin: PF4
#heater_pin: PA1 #PA1 is LDO default
#min_temp: -273.15
#max_temp: 99999999
#max_power: 1.0
#min_temp: -273.15
#control = pid
#pid_kp = 26.213
#pid_ki = 1.304
#pid_kd = 131.721
##  Try to keep pressure_advance below 1.0
#pressure_advance: 0.05
##  Default is 0.040, leave stock
#pressure_advance_smooth_time: 0.040

##  E0 on MOTOR6
##  Make sure to update below for your relevant driver (2208 or 2209)
#[tmc2209 extruder]
#uart_pin: PE1
#interpolate: false
#run_current: 0.5
#sense_resistor: 0.110
#stealthchop_threshold: 0


#####################################################################
#   Additional Sensors
#####################################################################

[thermistor CMFB103F3950FANT]
temperature1: 0.0
resistance1: 32116.0
temperature2: 40.0
resistance2: 5309.0
temperature3: 80.0
resistance3: 1228.0

#[temperature_sensor sb_ambient_temp]
## Chamber Temperature - T1
#sensor_type: CMFB103F3950FANT
#sensor_pin: PF5
#min_temp: 0
#max_temp: 100
#gcode_id: chamber_th

[temperature_sensor back_chamber_temp]
## Chamber Temperature - T
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PF6
min_temp: 0
max_temp: 100
gcode_id: chamber_th2

[temperature_sensor RPi4]
sensor_type: temperature_host
min_temp: 0
max_temp: 100

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<5V>

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 39.889
#*# pid_ki = 0.964
#*# pid_kd = 412.851
#*#
#*# [beacon model default]
#*# model_coef = 1.430682862202608,
#*# 	  1.7426261251845159,
#*# 	  0.7493054686432258,
#*# 	  0.3671462912205665,
#*# 	  0.3673759108608409,
#*# 	  0.36730640524045816,
#*# 	  -0.14887469220940763,
#*# 	  -0.2738865212178682,
#*# 	  0.20148733956348108,
#*# 	  0.19954738301836653
#*# model_domain = 3.141941022191752e-07,3.328282656219529e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 85.769294
#*# model_offset = -0.11000
#*#
#*# [beacon model pei_hot]
#*# model_coef = 1.9263519575030055,
#*# 	2.1946743347503372,
#*# 	0.6208794249910773,
#*# 	0.2775896555222557,
#*# 	0.06526221562750463,
#*# 	-0.2611119885640586,
#*# 	-0.05461829170887029,
#*# 	0.36810740679885895,
#*# 	0.05685001457152785,
#*# 	-0.15547240310186372
#*# model_domain = 3.351987055417817e-07,3.359664588035842e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 63.925584
#*# model_offset = 0.00000
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.011364, 0.019294, 0.009507, 0.008227, 0.009745, 0.010252, 0.014921, 0.011489, 0.004656, 0.010771, 0.001782, -0.000543, -0.011636, -0.005717, -0.007216, -0.011360, -0.014422, -0.008438, -0.008972, 0.000947
#*# 	  0.012622, 0.006825, 0.007947, 0.008281, 0.008141, 0.008901, 0.010241, 0.003824, 0.012805, 0.001394, -0.001724, -0.003937, -0.013356, -0.000862, -0.010025, -0.009771, -0.021079, -0.007815, -0.013576, -0.008480
#*# 	  0.019039, 0.009467, 0.001775, 0.003548, 0.003909, 0.007573, 0.006333, 0.004405, -0.000936, -0.004238, -0.005792, -0.009624, -0.017541, -0.006487, -0.014796, -0.017640, -0.038860, -0.017742, -0.018762, -0.012020
#*# 	  0.012185, 0.003629, -0.003454, -0.000720, -0.003064, 0.004062, 0.001953, 0.007980, -0.018204, -0.009559, -0.010156, -0.015888, -0.019652, -0.013572, -0.012209, -0.018233, -0.025665, -0.023242, -0.024698, -0.019497
#*# 	  0.002265, 0.001632, -0.003186, 0.000730, -0.002478, 0.006395, 0.008403, 0.006755, -0.007367, -0.008309, -0.009026, -0.016839, -0.017675, -0.013593, -0.013261, -0.019374, -0.021511, -0.021115, -0.021367, -0.017034
#*# 	  0.009961, 0.000878, -0.004042, -0.000229, -0.001544, 0.005178, 0.008474, 0.006002, 0.002497, -0.006721, -0.002310, -0.016047, -0.014291, -0.012426, -0.014178, -0.022397, -0.025322, -0.021853, -0.019417, -0.017840
#*# 	  0.009481, 0.000513, -0.004055, -0.002967, -0.003892, 0.003597, 0.006817, -0.004635, -0.003515, -0.013836, -0.005880, -0.019567, -0.017197, -0.018074, -0.015102, -0.025759, -0.028226, -0.024797, -0.019554, -0.018954
#*# 	  0.009183, -0.000037, -0.003374, -0.002528, -0.003983, -0.003783, 0.004803, 0.005216, -0.002755, -0.014531, -0.002531, -0.018660, -0.015272, -0.023634, -0.014120, -0.033956, -0.028233, -0.026165, -0.017098, -0.017700
#*# 	  0.011583, 0.003821, 0.000264, 0.001468, 0.002158, 0.010017, 0.011618, 0.008462, 0.000896, -0.002453, 0.008214, -0.010939, -0.011072, -0.012162, -0.007252, -0.017556, -0.022598, -0.021256, -0.016188, -0.014892
#*# 	  0.017960, 0.009776, 0.008598, 0.005561, 0.009491, 0.015573, 0.016405, 0.013650, 0.006580, 0.001457, 0.005924, -0.002661, -0.007540, -0.007463, -0.002403, -0.022847, -0.019048, -0.026696, -0.018036, -0.013550
#*# 	  0.020341, 0.009661, 0.004479, 0.007169, 0.007660, 0.014150, 0.016416, 0.013922, 0.007211, 0.002046, 0.000740, -0.001434, -0.006228, -0.006281, -0.001557, -0.016020, -0.017177, -0.017995, -0.016768, -0.014354
#*# 	  0.015414, 0.006573, -0.001343, 0.005985, 0.004201, 0.011817, 0.014078, 0.011560, 0.005389, 0.001859, 0.004806, 0.000631, -0.004863, -0.005476, -0.003082, -0.016600, -0.017472, -0.014207, -0.015302, -0.014450
#*# 	  0.011224, 0.004252, 0.000073, 0.005368, 0.001819, 0.011134, 0.014102, 0.011713, 0.006476, 0.004999, 0.008775, 0.002001, -0.004963, -0.001522, 0.001554, -0.009952, -0.012668, -0.009315, -0.011492, -0.011955
#*# 	  0.007254, 0.000261, -0.006229, -0.001568, -0.003452, 0.006029, 0.007538, 0.005423, 0.002461, 0.000843, 0.000347, -0.002624, -0.010714, -0.006971, -0.004537, -0.012631, -0.017218, -0.013552, -0.012887, -0.014240
#*# 	  0.003497, -0.005155, -0.009081, -0.004495, -0.005233, 0.002490, 0.003950, 0.003677, 0.000377, -0.002010, -0.002809, -0.005940, -0.012364, -0.010108, -0.005857, -0.016120, -0.020991, -0.016971, -0.017241, -0.016607
#*# 	  0.003440, -0.004327, -0.006686, -0.002551, -0.003378, 0.004409, 0.008462, 0.007175, 0.003630, 0.001071, 0.001207, -0.003303, -0.006349, -0.010125, -0.005296, -0.014019, -0.018685, -0.014312, -0.012213, -0.014263
#*# 	  0.003087, -0.004231, -0.007117, -0.002836, 0.000880, 0.005090, 0.009605, 0.009749, 0.005624, 0.002114, 0.003209, 0.000002, -0.007197, -0.006760, -0.005461, -0.013813, -0.017227, -0.013770, -0.012308, -0.013022
#*# 	  -0.000340, -0.006482, -0.013172, -0.009557, -0.005637, 0.000495, 0.004504, 0.004771, 0.000728, -0.002656, -0.001040, -0.005269, -0.016529, -0.012437, -0.013813, -0.019125, -0.022751, -0.020312, -0.018772, -0.019496
#*# 	  -0.006199, -0.010958, -0.017144, -0.015802, -0.012466, -0.004096, 0.000106, -0.000942, -0.004623, -0.007124, -0.006190, -0.010845, -0.020550, -0.018478, -0.020759, -0.025325, -0.029186, -0.028276, -0.027848, -0.026497
#*# 	  -0.010152, -0.014027, -0.020154, -0.017015, -0.015210, -0.007711, -0.001652, -0.003900, -0.008082, -0.011982, -0.010190, -0.016449, -0.026827, -0.024746, -0.027142, -0.029924, -0.035914, -0.034437, -0.036536, -0.035643
#*# x_count = 20
#*# y_count = 20
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 21.0
#*# max_x = 224.0
#*# min_y = 21.0
#*# max_y = 224.0
#*#
#*# [axis_twist_compensation]
#*# z_compensations = -0.034952, 0.004580, 0.030372
#*# compensation_start_x = 20.0
#*# compensation_end_x = 230.0
