##########################
##### BASE CONFIG #######
##########################

[include mainsail.cfg]
[include ./backup/backup.cfg]

##########################
##### HARDWARE STUFF #####
##########################

[include ./hardware/xyz-stepper.cfg]
[include ./hardware/extruder.cfg]
#[include ./klicky/klicky-probe.cfg]
#[include ./hardware/adxl345.cfg]  This config now in canbus.cfg
[include ./hardware/fans.cfg] # Some fans config in canbus.cfg
[include ./hardware/canbus.cfg]

##########################
##### LIGHTS #############
##########################

[include ./hardware/chamber-lighting.cfg]
[include ./hardware/stealthburner-led.cfg]

##########################
##### CALIBRATION ########
##########################

[include ./calibration/z-tilt.cfg]
[include ./calibration/bed-mesh.cfg]
[include ./macros/unsafe.cfg]
[include ./calibration/pressure_advance.cfg]
[include test_probe_accuracy.cfg]

##########################
##### MACROS #############
##########################

[include ./macros/chamber-led.cfg]
[include ./macros/conditional-homing.cfg]
[include ./macros/print-end.cfg]
[include ./macros/print-start-mmu.cfg]
[include ./macros/dump-variables.cfg]
[include ./macros/movement-check.cfg]
[include ./macros/cancel-change.cfg]
[include ./macros/pause-resume.cfg]         ; Overridden by ERCF / subsequantly disabled
[include ./macros/load-unload.cfg]
[include ./macros/filament-change.cfg]
[include ./macros/park.cfg]
[include ./macros/prusaslicer-accel.cfg]

##########################
##### THIRD PARTY ########
##########################

[include ./third-party-cfg/nozzle_scrub.cfg]
[include ./kamp/Adaptive_Mesh.cfg]
[include ./kamp/Adaptive_Purge.cfg]

##########################
##### ERCF ###############
##########################


[include ercf_hardware.cfg]
[include ercf_parameters.cfg]
[include ercf_software.cfg]
[include ./calibration/ercf_additional.cfg]
#[include ercf_vars.cfg]
[include client_macros.cfg]

##########################
##### LCD/MENU ###########
##########################

#[include ./third-party-cfg/nozzle_scrub_menu.cfg]
#[include ercf_menu.cfg]
#[include ./menu/printer_menu.cfg]

##########################
##### NOT ENABLED YET ####
##########################

#[include ./todo/mini12864.cfg] Add this after adding mini12864 LED
#[include ./todo/lcd_tweaks.cfg] Need to figure this one out and then implement
#[include ./hardware/nevermore.cfg] Disabled as I prefer to chamber vent outside and needed the PWM

##########################
#### REPLACEMENT #########
##########################

[include ./replacement_macros/replace-m900.cfg]
[include ./replacement_macros/replace-m117.cfg]

[exclude_object]

[gcode_arcs]
resolution: 0.1

[respond]
default_type: echo
default_prefix:  

[force_move]
# Enable commands that force potentially unsafe movement
enable_force_move: True

[idle_timeout]
timeout: 14400

[mcu]
##  Obtain definition by "ls -l /dev/serial/by-id/" then unplug to verify
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_290040000750314D35323820-if00
restart_method: command

[mcu rpi]
# Add Rpi as secondary MCU to allow for ADXL use through SPI ribbon/adapter from LDO
serial: /tmp/klipper_host_mcu

[mcu sht]
canbus_uuid: 30993412e8e0

[printer]
kinematics: corexy
max_velocity: 600           # Changed from 200 on 7.11.23
max_accel:  6000            # tuned on 7.11.23 after beacon install.
max_z_velocity: 15          #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 350
square_corner_velocity: 8.0 # Changed on 7.11.23

#####################################################################
#   Input Shaper
#####################################################################

[input_shaper]
shaper_freq_x: 76.2               ; suggested max_accel <= 22600 mm/sec^2
shaper_type_x: zv
shaper_freq_y: 51.8               ; suggested max_accel <= 7900 mm/sec^2
shaper_type_y: mzv


#####################################################################
#   Bed Heater
#####################################################################

##  SSR Pin - HE1
##  Thermistor - TB
[heater_bed]
heater_pin: PA2 #PA2 is LDO default
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF3
##  Adjust Max Power so your heater doesn't warp your bed. Rule of thumb is 0.4 watts / cm^2 .
max_power: 0.6
min_temp: 0
max_temp: 125
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

#####################################################################
#   Probe
#####################################################################

##  WAS TAP - NOW BEACON in CANBUS
#[probe]
#pin: ^sht:PA2
#x_offset: 0
#y_offset: 25.0
#z_offset: 0
#x_offset: 0
#y_offset: 0
#z_offset: 6.42
#speed: 5.0
#lift_speed: 15
#samples: 3
#samples_result: median
#sample_retract_dist: 2.0
#samples_tolerance: 0.01
#samples_tolerance_retries: 3
# After TAP installation, with PLA, Flow Rate 98%, 0.25mm First Layer, 0.6mm CHT nozzle, Z_Offset is z_offset = -0.450
#activate_gcode:
#    {% set PROBE_TEMP = 150 %}
#    {% set MAX_TEMP = PROBE_TEMP + 5 %}
#    {% set ACTUAL_TEMP = printer.extruder.temperature %}
#    {% set TARGET_TEMP = printer.extruder.target %}
#
#    {% if TARGET_TEMP > PROBE_TEMP %}
#        { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (TARGET_TEMP, PROBE_TEMP)) }
#        M109 S{ PROBE_TEMP }
#    {% else %}
#        # Temperature target is already low enough, but nozzle may still be too hot.
#        {% if ACTUAL_TEMP > MAX_TEMP %}
#            { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (ACTUAL_TEMP, MAX_TEMP)) }
#            TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={ MAX_TEMP }
#        {% endif %}
#    {% endif %}

#####################################################################
#  Filament Runout
#####################################################################

#[filament_motion_sensor RunoutSensor]
#detection_length: 10
#extruder: extruder
#switch_pin: ^PG11
#pause_on_runout: True
#runout_gcode:
#  M117 Filament problem, runout has paused.
#  M118 Filament problem, runout has paused.
#insert_gcode:
#event_delay:
#pause_delay:

#####################################################################
#   Additional Sensors
#####################################################################

[thermistor CMFB103F3950FANT]
temperature1: 0.0
resistance1: 32116.0
temperature2: 40.0
resistance2: 5309.0
temperature3: 80.0
resistance3: 1228.0

#[temperature_sensor sb_ambient_temp]
## Chamber Temperature - T1
#sensor_type: CMFB103F3950FANT
#sensor_pin: PF5
#min_temp: 0
#max_temp: 100
#gcode_id: chamber_th

[temperature_sensor back_chamber_temp]
## Chamber Temperature - T
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PF6
min_temp: 0
max_temp: 100
gcode_id: chamber_th2

[temperature_sensor RPi4]
sensor_type: temperature_host
min_temp: 0
max_temp: 100

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################

#[safe_z_home]
##  XY Location of the Z Endstop Switch
##  Update -10,-10 to the XY coordinates of your endstop pin 
##  (such as 157,305) after going through Z Endstop Pin
##  Location Definition step.
#home_xy_position: 147,256
#speed:100
#z_hop:10
#z_hop_speed:10


########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<5V>

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 39.889
#*# pid_ki = 0.964
#*# pid_kd = 412.851
#*#
#*# [probe]
#*# z_offset = -1.290
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.070652, -0.050043, -0.042271, -0.038088, -0.039300, -0.038096, -0.036366, -0.031767, -0.032761, -0.034603, -0.035552, -0.023766, -0.027615, -0.032677, -0.032673, -0.032448, -0.034397, -0.034951, -0.034854, -0.034688, -0.035629, -0.035093, -0.030925, -0.031213, -0.035433
#*# 	  -0.046224, -0.043186, -0.033877, -0.035078, -0.034292, -0.027821, -0.025701, -0.028901, -0.027292, -0.019096, -0.018910, -0.018234, -0.023573, -0.019177, -0.024729, -0.028103, -0.034803, -0.027245, -0.024605, -0.038398, -0.031943, -0.036384, -0.025108, -0.029804, -0.028361
#*# 	  -0.041905, -0.041874, -0.035093, -0.032981, -0.032031, -0.024487, -0.029475, -0.018827, -0.022040, -0.015598, -0.012895, -0.013046, -0.013870, -0.013572, -0.025177, -0.019138, -0.027201, -0.024880, -0.019845, -0.019423, -0.026857, -0.030617, -0.026443, -0.025259, -0.013443
#*# 	  -0.047246, -0.036860, -0.036363, -0.039317, -0.030469, -0.022591, -0.026607, -0.019912, -0.013660, -0.013810, -0.011566, -0.010361, -0.013019, -0.011777, -0.013549, -0.024587, -0.026415, -0.018871, -0.025804, -0.024498, -0.023658, -0.025775, -0.026579, -0.028785, -0.033356
#*# 	  -0.051197, -0.053380, -0.033473, -0.040654, -0.033172, -0.031189, -0.021873, -0.011828, -0.012765, -0.014833, -0.012423, -0.011065, -0.011194, -0.014547, -0.015412, -0.026649, -0.022307, -0.025245, -0.025612, -0.027659, -0.027404, -0.032469, -0.026377, -0.028187, -0.030881
#*# 	  -0.054909, -0.050124, -0.048882, -0.051772, -0.033445, -0.028017, -0.025078, -0.019202, -0.008848, -0.007910, -0.010987, -0.010569, -0.009329, -0.010533, -0.016433, -0.022194, -0.024772, -0.024971, -0.029213, -0.027471, -0.014220, -0.025958, -0.022347, -0.029944, -0.029668
#*# 	  -0.053205, -0.049448, -0.045726, -0.044407, -0.039714, -0.030708, -0.021150, -0.019375, -0.012241, -0.006260, -0.007490, -0.006643, -0.007628, -0.010819, -0.008910, -0.018732, -0.023494, -0.025164, -0.016523, -0.023835, -0.023382, -0.022095, -0.022670, -0.023361, -0.028977
#*# 	  -0.049394, -0.034988, -0.033599, -0.034675, -0.029102, -0.028374, -0.023873, -0.016044, -0.010131, -0.005367, -0.006571, -0.006009, -0.007495, -0.007092, -0.005711, -0.019619, -0.023180, -0.023107, -0.018049, -0.022361, -0.026197, -0.023770, -0.029162, -0.028524, -0.030780
#*# 	  -0.034491, -0.031422, -0.031965, -0.030274, -0.030999, -0.025008, -0.012763, -0.017446, -0.016010, -0.008028, -0.007877, -0.007390, -0.007158, -0.008408, -0.007789, -0.025232, -0.018269, -0.024894, -0.019902, -0.023741, -0.025159, -0.028770, -0.027980, -0.028623, -0.034422
#*# 	  -0.029194, -0.023434, -0.024240, -0.025326, -0.022105, -0.017468, -0.013171, -0.013823, -0.005152, -0.008195, -0.008390, -0.012796, -0.010400, -0.006080, -0.014042, -0.020467, -0.022029, -0.019964, -0.023897, -0.023079, -0.026525, -0.029996, -0.032294, -0.031922, -0.040718
#*# 	  -0.020743, -0.023326, -0.013790, -0.018286, -0.012551, -0.015016, -0.010795, -0.013974, -0.005650, -0.002672, -0.001259, -0.007640, -0.005210, -0.007291, -0.012517, -0.012091, -0.014279, -0.013102, -0.021554, -0.025670, -0.024160, -0.025364, -0.027531, -0.037056, -0.035044
#*# 	  -0.015888, -0.007990, -0.013568, -0.006441, -0.001108, -0.009696, -0.007224, 0.000653, -0.001488, -0.000922, -0.001294, -0.005485, -0.001964, -0.001459, -0.010505, -0.011320, -0.015478, -0.017921, -0.017895, -0.016780, -0.015206, -0.023350, -0.023547, -0.024245, -0.031241
#*# 	  -0.005688, 0.000142, -0.000657, -0.003901, -0.002673, -0.006275, -0.002385, 0.000976, -0.003965, 0.000178, 0.001762, -0.000476, 0.000000, -0.010115, -0.008541, -0.013065, -0.014039, -0.016371, -0.020810, -0.026671, -0.024470, -0.025387, -0.025454, -0.029274, -0.033975
#*# 	  -0.011846, -0.005025, -0.005735, 0.001065, -0.011758, -0.013439, -0.009771, -0.005587, -0.000021, -0.000392, -0.000634, -0.001504, -0.002134, -0.009254, -0.011615, -0.013133, -0.013827, -0.020570, -0.022469, -0.018130, -0.022996, -0.023550, -0.026454, -0.031127, -0.035976
#*# 	  -0.011369, -0.007934, -0.005911, -0.006512, -0.001489, -0.003265, -0.002641, -0.007249, 0.000479, -0.002065, -0.000921, -0.009477, -0.007592, -0.010576, -0.011017, -0.013694, -0.015605, -0.014866, -0.024801, -0.024342, -0.024022, -0.022848, -0.027269, -0.034858, -0.030983
#*# 	  0.007594, 0.001804, 0.000849, 0.000956, 0.001478, -0.004277, 0.002572, -0.000377, -0.000711, -0.001587, -0.008523, -0.010806, -0.001316, -0.004501, -0.009226, -0.011554, -0.011734, -0.021327, -0.013587, -0.018078, -0.025123, -0.022551, -0.016486, -0.024419, -0.035210
#*# 	  0.002365, 0.002247, 0.007966, 0.005110, -0.000282, 0.000961, 0.001638, 0.004163, 0.007139, -0.000412, 0.001272, -0.009084, -0.008950, 0.002051, -0.005939, -0.007497, -0.008161, -0.010045, -0.014265, -0.016536, -0.016517, -0.013276, -0.015239, -0.019478, -0.020316
#*# 	  0.014161, 0.014744, 0.014291, 0.008870, 0.010936, 0.011319, 0.008156, 0.004574, 0.009141, 0.007673, 0.006845, 0.004008, 0.004397, 0.005026, 0.000127, 0.000104, 0.002461, -0.006210, -0.007007, -0.010223, -0.011939, -0.008961, -0.012160, -0.012486, -0.015317
#*# 	  0.019064, 0.019956, 0.019405, 0.016407, 0.016114, 0.014150, 0.011108, 0.009975, 0.010673, 0.011559, 0.010973, 0.010117, 0.005436, 0.008121, 0.000260, 0.002949, -0.004094, -0.006671, -0.006043, -0.009961, -0.005893, -0.012684, -0.008847, -0.012058, -0.019450
#*# 	  0.016085, 0.016271, 0.019661, 0.015341, 0.016265, 0.011661, 0.010913, 0.006769, 0.009435, 0.003785, 0.004244, 0.001553, 0.004060, -0.008037, 0.003451, 0.001280, -0.006120, -0.006503, -0.010113, -0.008081, -0.011601, -0.013424, -0.013649, -0.015621, -0.023367
#*# 	  0.016085, 0.020420, 0.015348, 0.012545, 0.015486, 0.011999, 0.011030, 0.009625, 0.005039, 0.002810, 0.004191, 0.005318, 0.004201, 0.005450, -0.006835, -0.003000, -0.008122, -0.010988, -0.009877, -0.013744, -0.013760, -0.018437, -0.019372, -0.020741, -0.023826
#*# 	  0.018550, 0.018272, 0.018989, 0.016704, 0.011944, 0.010100, 0.008981, 0.005969, 0.003954, 0.007005, 0.003067, -0.008616, -0.005794, 0.004112, 0.001600, -0.003966, -0.006719, -0.014519, -0.013202, -0.013822, -0.014696, -0.020497, -0.016694, -0.023915, -0.029293
#*# 	  0.023161, 0.020549, 0.023356, 0.018908, 0.015742, 0.014197, 0.012067, 0.008235, 0.005123, 0.007294, 0.002724, 0.005596, -0.005366, -0.012027, -0.002478, -0.006548, -0.004713, -0.011330, -0.014722, -0.016645, -0.016358, -0.018997, -0.025046, -0.030315, -0.030108
#*# 	  0.016930, 0.023100, 0.021947, 0.019214, 0.015111, 0.014350, 0.013777, 0.009333, 0.008570, 0.003515, -0.000350, 0.002293, -0.002507, -0.006142, -0.006487, -0.010044, -0.016057, -0.014794, -0.015795, -0.018844, -0.015917, -0.027388, -0.028555, -0.027011, -0.036562
#*# 	  0.023955, 0.026094, 0.021780, 0.018894, 0.013596, 0.013247, 0.011751, 0.005301, 0.006732, 0.005475, -0.003393, -0.006787, -0.009180, -0.012253, -0.016336, -0.011872, -0.017039, -0.024469, -0.018307, -0.029110, -0.028969, -0.031524, -0.033836, -0.038760, -0.041337
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 210.0
#*# min_y = 30.0
#*# max_y = 210.0
#*#
#*# [beacon model default]
#*# model_coef = 1.9257982386737142,
#*# 	2.1904011986275074,
#*# 	0.5881661108028357,
#*# 	0.30341866940870527,
#*# 	0.14823890288711727,
#*# 	-0.42807822476666274,
#*# 	-0.13716254071061182,
#*# 	0.612855529187592,
#*# 	0.08376843001203003,
#*# 	-0.2664564217100284
#*# model_domain = 3.352922478536077e-07,3.360945745364866e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 72.578002
#*# model_offset = -0.31000
