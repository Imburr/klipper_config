##########################
##### BASE CONFIG #######
##########################

[include mainsail.cfg]
[include ./backup/backup.cfg]

##########################
##### HARDWARE STUFF #####
##########################

[include ./hardware/xyz-stepper.cfg]
[include ./hardware/extruder.cfg]
#[include ./klicky/klicky-probe.cfg]
#[include ./hardware/adxl345.cfg]  This config now in canbus.cfg
[include ./hardware/fans.cfg] # Some fans config in canbus.cfg
[include ./hardware/canbus.cfg]

##########################
##### LIGHTS #############
##########################

[include ./hardware/chamber-lighting.cfg]
[include ./hardware/stealthburner-led.cfg]

##########################
##### CALIBRATION ########
##########################

[include ./calibration/z-tilt.cfg]
[include ./calibration/bed-mesh.cfg]
[include ./macros/unsafe.cfg]
[include ./calibration/pressure_advance.cfg]
[include test_probe_accuracy.cfg]

##########################
##### MACROS #############
##########################

[include ./macros/chamber-led.cfg]
[include ./macros/conditional-homing.cfg]
[include ./macros/print-end.cfg]
[include ./macros/print-start-mmu.cfg]
[include ./macros/dump-variables.cfg]
[include ./macros/movement-check.cfg]
[include ./macros/cancel-change.cfg]
[include ./macros/pause-resume.cfg]         ; Overridden by ERCF / subsequantly disabled
[include ./macros/load-unload.cfg]
[include ./macros/filament-change.cfg]
[include ./macros/park.cfg]
#[include ./macros/prusaslicer-accel.cfg]

##########################
##### THIRD PARTY ########
##########################

[include ./third-party-cfg/nozzle_scrub.cfg]
#[include ./kamp/Adaptive_Mesh.cfg]
#[include ./kamp/Adaptive_Purge.cfg]
[include ./KAMP/KAMP_Settings.cfg]
[include ./KAMP/Adaptive_Meshing.cfg]
[include ./KAMP/Line_Purge.cfg]
[include ./KAMP/Voron_Purge.cfg]
[include ./KAMP/Smart_Park.cfg]

##########################
##### ERCF ###############
##########################


[include ercf_hardware.cfg]
[include ercf_parameters.cfg]
[include ercf_software.cfg]
[include ./calibration/ercf_additional.cfg]
#[include ercf_vars.cfg]
[include client_macros.cfg]

##########################
##### LCD/MENU ###########
##########################

#[include ./third-party-cfg/nozzle_scrub_menu.cfg]
#[include ercf_menu.cfg]
#[include ./menu/printer_menu.cfg]

##########################
##### NOT ENABLED YET ####
##########################

#[include ./todo/mini12864.cfg] Add this after adding mini12864 LED
#[include ./todo/lcd_tweaks.cfg] Need to figure this one out and then implement
#[include ./hardware/nevermore.cfg] Disabled as I prefer to chamber vent outside and needed the PWM

##########################
#### REPLACEMENT #########
##########################

[include ./replacement_macros/replace-m900.cfg]
[include ./replacement_macros/replace-m117.cfg]

[exclude_object]

[gcode_arcs]
resolution: 0.1

[respond]
default_type: echo
default_prefix:  

[force_move]
# Enable commands that force potentially unsafe movement
enable_force_move: True

[idle_timeout]
timeout: 14400

[mcu]
##  Obtain definition by "ls -l /dev/serial/by-id/" then unplug to verify
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_290040000750314D35323820-if00
restart_method: command

[mcu rpi]
# Add Rpi as secondary MCU to allow for ADXL use through SPI ribbon/adapter from LDO
serial: /tmp/klipper_host_mcu

[mcu sht]
canbus_uuid: 30993412e8e0

[printer]
kinematics: corexy
max_velocity: 600           # Changed from 200 on 7.11.23
max_accel:  6000            # tuned on 7.11.23 after beacon install.
max_z_velocity: 15          #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 350
square_corner_velocity: 8.0 # Changed on 7.11.23

#####################################################################
#   Input Shaper
#####################################################################

[input_shaper]
shaper_freq_x: 76.2               ; suggested max_accel <= 22600 mm/sec^2
shaper_type_x: zv
shaper_freq_y: 51.8               ; suggested max_accel <= 7900 mm/sec^2
shaper_type_y: mzv


#####################################################################
#   Bed Heater
#####################################################################

##  SSR Pin - HE1
##  Thermistor - TB
[heater_bed]
heater_pin: PA2 #PA2 is LDO default
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF3
##  Adjust Max Power so your heater doesn't warp your bed. Rule of thumb is 0.4 watts / cm^2 .
max_power: 0.6
min_temp: 0
max_temp: 125
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

#####################################################################
#   Probe
#####################################################################

##  WAS TAP - NOW BEACON in CANBUS
#[probe]
#pin: ^sht:PA2
#x_offset: 0
#y_offset: 25.0
#z_offset: 0
#x_offset: 0
#y_offset: 0
#z_offset: 6.42
#speed: 5.0
#lift_speed: 15
#samples: 3
#samples_result: median
#sample_retract_dist: 2.0
#samples_tolerance: 0.01
#samples_tolerance_retries: 3
# After TAP installation, with PLA, Flow Rate 98%, 0.25mm First Layer, 0.6mm CHT nozzle, Z_Offset is z_offset = -0.450
#activate_gcode:
#    {% set PROBE_TEMP = 150 %}
#    {% set MAX_TEMP = PROBE_TEMP + 5 %}
#    {% set ACTUAL_TEMP = printer.extruder.temperature %}
#    {% set TARGET_TEMP = printer.extruder.target %}
#
#    {% if TARGET_TEMP > PROBE_TEMP %}
#        { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (TARGET_TEMP, PROBE_TEMP)) }
#        M109 S{ PROBE_TEMP }
#    {% else %}
#        # Temperature target is already low enough, but nozzle may still be too hot.
#        {% if ACTUAL_TEMP > MAX_TEMP %}
#            { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (ACTUAL_TEMP, MAX_TEMP)) }
#            TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={ MAX_TEMP }
#        {% endif %}
#    {% endif %}

#####################################################################
#  Filament Runout
#####################################################################

#[filament_motion_sensor RunoutSensor]
#detection_length: 10
#extruder: extruder
#switch_pin: ^PG11
#pause_on_runout: True
#runout_gcode:
#  M117 Filament problem, runout has paused.
#  M118 Filament problem, runout has paused.
#insert_gcode:
#event_delay:
#pause_delay:

#####################################################################
#   Additional Sensors
#####################################################################

[thermistor CMFB103F3950FANT]
temperature1: 0.0
resistance1: 32116.0
temperature2: 40.0
resistance2: 5309.0
temperature3: 80.0
resistance3: 1228.0

#[temperature_sensor sb_ambient_temp]
## Chamber Temperature - T1
#sensor_type: CMFB103F3950FANT
#sensor_pin: PF5
#min_temp: 0
#max_temp: 100
#gcode_id: chamber_th

[temperature_sensor back_chamber_temp]
## Chamber Temperature - T
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PF6
min_temp: 0
max_temp: 100
gcode_id: chamber_th2

[temperature_sensor RPi4]
sensor_type: temperature_host
min_temp: 0
max_temp: 100

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################

#[safe_z_home]
##  XY Location of the Z Endstop Switch
##  Update -10,-10 to the XY coordinates of your endstop pin 
##  (such as 157,305) after going through Z Endstop Pin
##  Location Definition step.
#home_xy_position: 147,256
#speed:100
#z_hop:10
#z_hop_speed:10


########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<5V>

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 39.889
#*# pid_ki = 0.964
#*# pid_kd = 412.851
#*#
#*# [probe]
#*# z_offset = -1.270
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.039452, -0.025354, -0.022574, -0.020106, -0.022299, -0.018501, -0.014080, -0.010956, -0.006207, -0.005872, -0.007581, -0.006837, -0.007164, -0.008337, -0.021673, -0.011669, -0.013791, -0.018038, -0.022276, -0.021537, -0.021597, -0.013786, -0.013366, -0.022100, -0.023699
#*# 	  -0.024626, -0.022060, -0.023375, -0.019649, -0.001922, -0.009988, -0.005991, -0.001537, -0.002813, -0.000874, 0.004027, -0.001203, 0.000792, -0.006307, -0.004394, -0.009436, -0.008794, -0.012039, -0.010484, -0.014211, -0.010591, -0.006359, -0.001987, -0.008642, -0.014429
#*# 	  -0.022554, -0.020248, -0.019235, -0.000010, -0.004232, -0.003452, -0.013364, -0.018945, 0.004404, 0.000487, -0.001665, 0.007553, -0.000723, 0.002950, 0.001166, 0.002921, -0.001914, -0.008958, -0.003703, -0.009161, -0.004967, -0.000615, 0.000019, -0.003585, -0.009638
#*# 	  -0.020860, -0.023808, -0.014439, -0.014558, -0.018924, -0.009373, -0.007293, 0.001564, 0.000781, 0.003788, -0.002088, 0.005203, -0.000207, -0.001308, 0.003951, -0.006428, -0.000866, -0.006707, -0.006218, -0.000538, -0.004657, -0.000942, -0.003311, -0.004140, -0.007993
#*# 	  -0.036994, -0.032627, -0.024622, -0.023993, -0.019718, -0.013159, -0.008427, -0.003988, 0.005664, 0.004959, 0.000951, 0.000976, 0.007945, -0.004069, -0.003226, 0.000699, -0.007045, -0.004205, 0.004410, -0.000052, 0.001787, -0.004949, -0.003862, -0.002419, -0.012994
#*# 	  -0.037316, -0.032492, -0.033240, -0.029943, -0.031094, -0.013284, -0.008561, -0.027133, -0.005170, -0.004664, -0.002558, -0.004121, -0.006616, 0.004582, 0.002377, -0.007997, -0.006139, -0.006253, -0.009191, -0.006620, -0.005574, -0.005548, 0.011174, -0.004563, -0.007714
#*# 	  -0.044922, -0.035540, -0.033774, -0.031266, -0.027103, -0.018616, -0.007491, -0.009712, 0.004075, -0.005979, 0.013633, -0.002075, 0.003780, 0.013610, -0.007453, -0.006390, -0.003155, -0.006510, -0.008398, -0.006172, -0.005246, -0.006182, -0.006727, -0.009313, -0.005989
#*# 	  -0.043916, -0.042990, -0.039094, -0.036314, -0.026454, -0.026566, -0.008476, -0.013426, -0.005973, -0.003861, 0.001204, -0.008734, 0.002455, -0.004303, -0.007377, -0.009318, -0.006098, -0.003135, -0.005229, -0.006188, -0.006515, -0.003020, -0.005017, -0.007248, -0.010057
#*# 	  -0.042429, -0.034596, -0.034792, -0.027648, -0.034494, -0.020831, -0.014328, -0.023072, 0.000827, 0.001672, -0.001754, -0.000883, -0.005260, -0.004575, -0.009244, -0.005162, -0.005523, -0.005215, -0.004318, -0.011625, -0.012318, -0.009601, -0.009918, -0.011942, -0.012789
#*# 	  -0.034830, -0.036114, -0.027466, -0.028043, -0.032029, -0.021914, -0.015630, -0.011892, -0.009863, -0.011142, -0.003148, -0.003555, -0.004073, 0.001929, 0.004173, -0.009248, -0.009440, -0.013213, -0.012104, -0.013098, -0.010920, -0.012226, -0.014435, -0.011350, -0.012842
#*# 	  -0.031958, -0.034975, -0.023109, -0.024470, -0.022803, -0.014580, -0.013405, -0.009885, -0.011712, 0.003468, -0.006316, -0.004618, -0.005371, -0.006654, -0.008892, -0.002447, -0.007460, -0.012105, -0.007035, -0.008488, -0.012490, -0.013249, -0.014867, -0.012077, -0.013222
#*# 	  -0.032239, -0.020834, -0.022630, -0.020553, -0.016648, -0.013861, -0.012990, -0.013545, -0.010567, -0.008640, -0.007116, -0.008791, -0.000947, -0.001575, -0.006856, -0.004765, -0.010257, -0.012409, -0.010379, -0.006259, -0.014819, -0.007638, -0.013214, -0.009645, -0.013933
#*# 	  -0.026324, -0.031186, -0.021840, -0.016110, -0.010058, -0.012236, -0.011608, -0.004214, -0.009922, -0.000724, -0.005717, -0.000030, 0.000000, -0.003927, -0.004035, -0.005968, -0.005295, -0.006802, -0.007389, -0.008067, -0.010543, -0.005506, -0.005761, -0.004612, -0.005496
#*# 	  -0.030611, -0.027831, -0.023935, -0.018177, -0.012267, -0.016835, -0.015624, -0.018057, -0.004532, -0.008413, -0.005943, -0.011198, -0.001078, -0.005447, -0.009202, -0.003677, -0.009011, -0.006665, -0.016384, -0.003772, -0.012655, -0.007067, -0.007734, -0.007220, -0.011645
#*# 	  -0.035207, -0.028608, -0.029394, -0.024879, -0.027885, -0.018582, -0.022828, -0.020820, -0.022695, -0.005584, -0.013111, -0.007519, -0.006512, -0.017349, -0.006904, -0.010503, -0.006310, -0.019462, -0.019870, -0.016130, -0.019615, -0.013123, -0.014708, -0.007207, -0.013903
#*# 	  -0.037190, -0.029943, -0.029841, -0.023346, -0.023224, -0.032481, -0.021484, -0.019376, -0.020890, -0.012419, -0.012391, -0.013300, -0.005578, -0.010739, -0.016480, -0.009767, -0.007611, -0.005321, -0.017018, -0.006779, -0.018005, -0.006790, -0.001099, 0.000251, -0.007321
#*# 	  -0.032019, -0.032175, -0.025458, -0.034780, -0.027577, -0.023526, -0.023838, -0.022569, -0.021161, -0.022577, -0.022088, -0.013149, -0.008047, -0.014322, -0.007106, -0.015768, -0.018660, -0.014704, -0.007589, -0.016032, -0.003235, -0.008496, -0.004976, -0.002268, -0.004598
#*# 	  -0.041961, -0.025488, -0.028755, -0.030859, -0.026045, -0.025170, -0.026092, -0.022384, -0.018201, -0.018251, -0.013249, -0.011558, -0.007805, -0.010665, -0.006588, -0.008599, -0.013898, -0.014478, 0.002282, 0.000013, -0.009719, -0.006090, 0.002559, -0.000541, 0.002866
#*# 	  -0.033849, -0.036344, -0.041592, -0.030015, -0.022539, -0.028172, -0.022847, -0.020843, -0.021709, -0.014983, -0.015688, -0.012527, -0.016805, -0.017375, -0.012252, -0.010219, -0.003176, -0.014179, -0.017031, -0.007865, 0.003215, -0.003524, 0.003370, -0.000810, -0.000221
#*# 	  -0.041710, -0.034803, -0.030886, -0.028433, -0.030227, -0.028316, -0.021722, -0.027150, -0.018454, -0.022164, -0.016419, -0.008926, -0.016960, -0.013319, -0.015476, -0.013312, -0.011808, -0.016912, -0.010950, -0.014258, -0.001811, -0.010810, -0.008171, -0.000565, -0.002870
#*# 	  -0.042836, -0.039389, -0.039521, -0.028895, -0.031778, -0.033474, -0.029254, -0.028261, -0.025958, -0.021167, -0.026596, -0.026160, -0.016683, -0.021620, -0.017955, -0.016509, -0.014994, -0.014370, -0.014063, -0.009398, -0.014169, -0.014622, -0.007260, -0.006091, -0.007755
#*# 	  -0.052260, -0.039525, -0.038230, -0.037350, -0.029844, -0.030436, -0.030873, -0.030233, -0.030496, -0.029982, -0.026335, -0.030209, -0.014846, -0.015921, -0.025372, -0.015739, -0.022307, -0.014767, -0.016370, -0.016116, -0.017555, -0.007135, -0.007377, -0.013392, -0.012728
#*# 	  -0.053286, -0.050474, -0.047918, -0.048793, -0.036904, -0.034570, -0.036390, -0.032575, -0.031799, -0.032618, -0.024676, -0.026201, -0.024509, -0.027135, -0.022733, -0.031522, -0.015710, -0.023170, -0.015573, -0.012126, -0.027099, -0.012384, -0.011540, -0.010689, -0.010731
#*# 	  -0.054991, -0.048031, -0.036340, -0.035047, -0.046536, -0.035239, -0.034139, -0.034343, -0.034953, -0.033943, -0.032919, -0.034485, -0.028427, -0.032593, -0.027017, -0.030095, -0.022272, -0.028627, -0.023490, -0.020957, -0.019942, -0.011612, -0.011984, -0.015328, -0.012287
#*# 	  -0.058963, -0.054185, -0.052021, -0.048049, -0.035962, -0.037306, -0.043578, -0.035672, -0.036446, -0.038364, -0.035102, -0.035800, -0.035437, -0.034380, -0.034669, -0.031609, -0.034287, -0.035354, -0.029625, -0.032883, -0.029460, -0.022194, -0.019705, -0.018555, -0.020406
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 210.0
#*# min_y = 30.0
#*# max_y = 210.0
#*#
#*# [beacon model default]
#*# model_coef = 1.9257982386737142,
#*# 	2.1904011986275074,
#*# 	0.5881661108028357,
#*# 	0.30341866940870527,
#*# 	0.14823890288711727,
#*# 	-0.42807822476666274,
#*# 	-0.13716254071061182,
#*# 	0.612855529187592,
#*# 	0.08376843001203003,
#*# 	-0.2664564217100284
#*# model_domain = 3.352922478536077e-07,3.360945745364866e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 72.578002
#*# model_offset = -0.38000
