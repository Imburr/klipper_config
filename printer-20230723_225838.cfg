##########################
##### BASE CONFIG #######
##########################

[include mainsail.cfg]
[include ./backup/backup.cfg]

##########################
##### HARDWARE STUFF #####
##########################

[include ./hardware/xyz-stepper.cfg]
[include ./hardware/extruder.cfg]
#[include ./klicky/klicky-probe.cfg]
#[include ./hardware/adxl345.cfg]  This config now in canbus.cfg
[include ./hardware/fans.cfg] # Some fans config in canbus.cfg
[include ./hardware/canbus.cfg]

##########################
##### LIGHTS #############
##########################

[include ./hardware/chamber-lighting.cfg]
[include ./hardware/stealthburner-led.cfg]

##########################
##### CALIBRATION ########
##########################

[include ./calibration/z-tilt.cfg]
[include ./calibration/bed-mesh.cfg]
[include ./macros/unsafe.cfg]
[include ./calibration/pressure_advance.cfg]
[include test_probe_accuracy.cfg]

##########################
##### MACROS #############
##########################

[include ./macros/chamber-led.cfg]
[include ./macros/conditional-homing.cfg]
[include ./macros/print-end.cfg]
[include ./macros/print-start-mmu.cfg]
[include ./macros/dump-variables.cfg]
[include ./macros/movement-check.cfg]
[include ./macros/cancel-change.cfg]
[include ./macros/pause-resume.cfg]         ; Overridden by ERCF / subsequantly disabled
[include ./macros/load-unload.cfg]
[include ./macros/filament-change.cfg]
[include ./macros/park.cfg]
#[include ./macros/prusaslicer-accel.cfg]

##########################
##### THIRD PARTY ########
##########################

[include ./third-party-cfg/nozzle_scrub.cfg]
[include ./kamp/Adaptive_Mesh.cfg]
[include ./kamp/Adaptive_Purge.cfg]

##########################
##### ERCF ###############
##########################


[include ercf_hardware.cfg]
[include ercf_parameters.cfg]
[include ercf_software.cfg]
[include ./calibration/ercf_additional.cfg]
#[include ercf_vars.cfg]
[include client_macros.cfg]

##########################
##### LCD/MENU ###########
##########################

#[include ./third-party-cfg/nozzle_scrub_menu.cfg]
#[include ercf_menu.cfg]
#[include ./menu/printer_menu.cfg]

##########################
##### NOT ENABLED YET ####
##########################

#[include ./todo/mini12864.cfg] Add this after adding mini12864 LED
#[include ./todo/lcd_tweaks.cfg] Need to figure this one out and then implement
#[include ./hardware/nevermore.cfg] Disabled as I prefer to chamber vent outside and needed the PWM

##########################
#### REPLACEMENT #########
##########################

[include ./replacement_macros/replace-m900.cfg]
[include ./replacement_macros/replace-m117.cfg]

[exclude_object]

[gcode_arcs]
resolution: 0.1

[respond]
default_type: echo
default_prefix:  

[force_move]
# Enable commands that force potentially unsafe movement
enable_force_move: True

[idle_timeout]
timeout: 14400

[mcu]
##  Obtain definition by "ls -l /dev/serial/by-id/" then unplug to verify
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_290040000750314D35323820-if00
restart_method: command

[mcu rpi]
# Add Rpi as secondary MCU to allow for ADXL use through SPI ribbon/adapter from LDO
serial: /tmp/klipper_host_mcu

[mcu sht]
canbus_uuid: 30993412e8e0

[printer]
kinematics: corexy
max_velocity: 600           # Changed from 200 on 7.11.23
max_accel:  6000            # tuned on 7.11.23 after beacon install.
max_z_velocity: 15          #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 350
square_corner_velocity: 8.0 # Changed on 7.11.23

#####################################################################
#   Input Shaper
#####################################################################

[input_shaper]
shaper_freq_x: 76.2               ; suggested max_accel <= 22600 mm/sec^2
shaper_type_x: zv
shaper_freq_y: 51.8               ; suggested max_accel <= 7900 mm/sec^2
shaper_type_y: mzv


#####################################################################
#   Bed Heater
#####################################################################

##  SSR Pin - HE1
##  Thermistor - TB
[heater_bed]
heater_pin: PA2 #PA2 is LDO default
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF3
##  Adjust Max Power so your heater doesn't warp your bed. Rule of thumb is 0.4 watts / cm^2 .
max_power: 0.6
min_temp: 0
max_temp: 125
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

#####################################################################
#   Probe
#####################################################################

##  WAS TAP - NOW BEACON in CANBUS
#[probe]
#pin: ^sht:PA2
#x_offset: 0
#y_offset: 25.0
#z_offset: 0
#x_offset: 0
#y_offset: 0
#z_offset: 6.42
#speed: 5.0
#lift_speed: 15
#samples: 3
#samples_result: median
#sample_retract_dist: 2.0
#samples_tolerance: 0.01
#samples_tolerance_retries: 3
# After TAP installation, with PLA, Flow Rate 98%, 0.25mm First Layer, 0.6mm CHT nozzle, Z_Offset is z_offset = -0.450
#activate_gcode:
#    {% set PROBE_TEMP = 150 %}
#    {% set MAX_TEMP = PROBE_TEMP + 5 %}
#    {% set ACTUAL_TEMP = printer.extruder.temperature %}
#    {% set TARGET_TEMP = printer.extruder.target %}
#
#    {% if TARGET_TEMP > PROBE_TEMP %}
#        { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (TARGET_TEMP, PROBE_TEMP)) }
#        M109 S{ PROBE_TEMP }
#    {% else %}
#        # Temperature target is already low enough, but nozzle may still be too hot.
#        {% if ACTUAL_TEMP > MAX_TEMP %}
#            { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (ACTUAL_TEMP, MAX_TEMP)) }
#            TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={ MAX_TEMP }
#        {% endif %}
#    {% endif %}

#####################################################################
#  Filament Runout
#####################################################################

#[filament_motion_sensor RunoutSensor]
#detection_length: 10
#extruder: extruder
#switch_pin: ^PG11
#pause_on_runout: True
#runout_gcode:
#  M117 Filament problem, runout has paused.
#  M118 Filament problem, runout has paused.
#insert_gcode:
#event_delay:
#pause_delay:

#####################################################################
#   Additional Sensors
#####################################################################

[thermistor CMFB103F3950FANT]
temperature1: 0.0
resistance1: 32116.0
temperature2: 40.0
resistance2: 5309.0
temperature3: 80.0
resistance3: 1228.0

#[temperature_sensor sb_ambient_temp]
## Chamber Temperature - T1
#sensor_type: CMFB103F3950FANT
#sensor_pin: PF5
#min_temp: 0
#max_temp: 100
#gcode_id: chamber_th

[temperature_sensor back_chamber_temp]
## Chamber Temperature - T
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PF6
min_temp: 0
max_temp: 100
gcode_id: chamber_th2

[temperature_sensor RPi4]
sensor_type: temperature_host
min_temp: 0
max_temp: 100

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################

#[safe_z_home]
##  XY Location of the Z Endstop Switch
##  Update -10,-10 to the XY coordinates of your endstop pin 
##  (such as 157,305) after going through Z Endstop Pin
##  Location Definition step.
#home_xy_position: 147,256
#speed:100
#z_hop:10
#z_hop_speed:10


########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<5V>

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 39.889
#*# pid_ki = 0.964
#*# pid_kd = 412.851
#*#
#*# [probe]
#*# z_offset = -1.270
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.030700, -0.036619, -0.036158, -0.036489, -0.036170, -0.018220, -0.017366, -0.011550, -0.014296, -0.012036, -0.021021, -0.010264, -0.009549, -0.010257, -0.013536, -0.015048, -0.014517, -0.016897, -0.017538, -0.020815, -0.013338, -0.008992, -0.016276, -0.019223, -0.014113
#*# 	  -0.031247, -0.019784, -0.014308, -0.012762, -0.008248, -0.011498, -0.017274, -0.004811, -0.013889, -0.013936, -0.013382, -0.009720, -0.000111, -0.015734, -0.012804, -0.011848, -0.010232, -0.014035, -0.013166, -0.017852, -0.014387, -0.011284, -0.010006, -0.001346, -0.016538
#*# 	  -0.028632, -0.019867, -0.015343, -0.013296, -0.011614, -0.009508, -0.002031, -0.006574, 0.003859, -0.005129, -0.003084, -0.000771, -0.006613, -0.011808, 0.003275, -0.002433, -0.009170, -0.022719, -0.009597, -0.008532, -0.010136, -0.011218, -0.010018, -0.007799, -0.005290
#*# 	  -0.028808, -0.028383, -0.025250, -0.016516, -0.013248, -0.012317, -0.004955, -0.000724, -0.002120, -0.001074, 0.003317, -0.000862, 0.003053, 0.003383, -0.001325, -0.002423, -0.007482, -0.008937, -0.010337, -0.007623, -0.002129, -0.003161, -0.005169, -0.003712, -0.001400
#*# 	  -0.038748, -0.028217, -0.033917, -0.031663, -0.018379, -0.011944, -0.023003, -0.009725, -0.008703, -0.002687, -0.000369, -0.002053, -0.000677, -0.005307, -0.003444, -0.007143, -0.004445, -0.002470, -0.009577, -0.008451, -0.001223, -0.009132, -0.003730, -0.007378, -0.009270
#*# 	  -0.047324, -0.038839, -0.041095, -0.031758, -0.018025, -0.016439, -0.017664, -0.008190, -0.006125, 0.000442, 0.000446, 0.002168, -0.000892, 0.008240, 0.003595, -0.007083, -0.003101, -0.003178, -0.002300, -0.003781, -0.001791, -0.009675, -0.002824, 0.001888, -0.002776
#*# 	  -0.050214, -0.042326, -0.037650, -0.032317, -0.027927, -0.019298, -0.023004, -0.006274, -0.003388, 0.003841, -0.003475, 0.001189, -0.001967, 0.003428, -0.001996, -0.002154, -0.003453, -0.001858, -0.002426, -0.000645, 0.000089, -0.007635, -0.003541, -0.002513, -0.006560
#*# 	  -0.044730, -0.041681, -0.037211, -0.033185, -0.026474, -0.025497, -0.009818, -0.018306, -0.002426, -0.004351, -0.002287, 0.004165, -0.000714, -0.002851, -0.003900, -0.002784, -0.006105, -0.000512, -0.008084, -0.007501, -0.003115, -0.001973, -0.004536, 0.000614, -0.008226
#*# 	  -0.044288, -0.028972, -0.035431, -0.035647, -0.026771, -0.019155, -0.014876, -0.015216, -0.006452, 0.002517, -0.004410, 0.007284, 0.006774, -0.005829, -0.003156, 0.008148, 0.000440, -0.010105, -0.001708, -0.004901, -0.001407, -0.008294, -0.003770, -0.008872, -0.004926
#*# 	  -0.032923, -0.032845, -0.027755, -0.023164, -0.023551, -0.020878, -0.015221, -0.010556, -0.004600, -0.000567, 0.001555, -0.001403, 0.005607, 0.001652, 0.006310, 0.003068, -0.003493, -0.000205, -0.004061, 0.001438, -0.002671, -0.003920, -0.003642, -0.000147, -0.010791
#*# 	  -0.025956, -0.020452, -0.022819, -0.025409, -0.022796, -0.014860, -0.007911, -0.004291, -0.002770, -0.002035, -0.001464, 0.001251, 0.011321, 0.002852, 0.002880, 0.005095, -0.001055, 0.000459, -0.001338, -0.005752, -0.001948, -0.003242, 0.001883, -0.002422, -0.001647
#*# 	  -0.026624, -0.025223, -0.023447, -0.010626, -0.005447, -0.005464, -0.003391, -0.002925, 0.001471, 0.003459, 0.002938, 0.003266, 0.010041, 0.008497, 0.010220, 0.004171, 0.002063, 0.007588, 0.007583, 0.003972, -0.000389, 0.003555, 0.003578, 0.004009, 0.004997
#*# 	  -0.026307, -0.019136, -0.017622, -0.017974, -0.004174, -0.003444, 0.002305, -0.002038, -0.002199, 0.002765, 0.010391, 0.013149, 0.000000, 0.006308, -0.001318, 0.000680, 0.003046, 0.001967, 0.010240, -0.000712, 0.002591, 0.002276, 0.003844, 0.005353, 0.003808
#*# 	  -0.026910, -0.021906, -0.014651, -0.017277, -0.013162, -0.004579, -0.008099, -0.006534, 0.000257, -0.002180, -0.000900, 0.007722, 0.003221, 0.003060, 0.009214, 0.000412, 0.007623, 0.003450, 0.000324, 0.002272, -0.004955, 0.002573, 0.006766, 0.010068, 0.003080
#*# 	  -0.028477, -0.028831, -0.023163, -0.014459, -0.009124, -0.010211, -0.007652, -0.004864, 0.000850, -0.000912, -0.000687, 0.000160, -0.003669, 0.007635, 0.006998, 0.007476, 0.005232, -0.002922, 0.000488, 0.008774, 0.002991, 0.006602, 0.004355, -0.000331, 0.000732
#*# 	  -0.026089, -0.027312, -0.023989, -0.023558, -0.009218, -0.007477, -0.006840, -0.006593, -0.008925, 0.000983, -0.001744, 0.003532, 0.002562, 0.011306, 0.000147, -0.002615, 0.010519, 0.002656, 0.001043, 0.012961, 0.000983, 0.015060, 0.015931, 0.008165, 0.016036
#*# 	  -0.027499, -0.026827, -0.022013, -0.010009, -0.008800, -0.009584, -0.007725, -0.000940, -0.003481, -0.000807, 0.000126, -0.001875, 0.006071, 0.008338, 0.015319, -0.001803, -0.004002, 0.001541, 0.010184, 0.009806, 0.013673, 0.015252, 0.011534, 0.018796, 0.013982
#*# 	  -0.022275, -0.017856, -0.018276, -0.018683, -0.010247, -0.009249, -0.010574, -0.005140, 0.002023, 0.006786, 0.013201, 0.001940, 0.015059, 0.008939, 0.003248, 0.009790, 0.010259, 0.010730, 0.015403, 0.014234, 0.020420, 0.021650, 0.022220, 0.023997, 0.020339
#*# 	  -0.022797, -0.030120, -0.024849, -0.018600, -0.014448, -0.016877, -0.005119, -0.009312, 0.002570, 0.001717, 0.002962, 0.008745, 0.007734, 0.013706, 0.013978, 0.008674, 0.009069, 0.010322, 0.015390, 0.015655, 0.017284, 0.022487, 0.021166, 0.024751, 0.018238
#*# 	  -0.021913, -0.023689, -0.018730, -0.023574, -0.017002, -0.008250, -0.013972, -0.009582, -0.009520, -0.000048, 0.002290, 0.008895, 0.004902, 0.006034, 0.011167, 0.003078, 0.005315, 0.005138, 0.004629, 0.005448, 0.012591, 0.017137, 0.014577, 0.015871, 0.015670
#*# 	  -0.021507, -0.023746, -0.021686, -0.021613, -0.018877, -0.011896, -0.010677, -0.010917, -0.009846, -0.009113, -0.010446, -0.000642, 0.000949, 0.003352, 0.002760, 0.001659, 0.000847, 0.009206, 0.002815, -0.000905, 0.009669, 0.012877, 0.012429, 0.014714, 0.009107
#*# 	  -0.024628, -0.017712, -0.017917, -0.017256, -0.018156, -0.017062, -0.010563, -0.005977, -0.013127, -0.006847, 0.002263, 0.002149, -0.001254, 0.004328, 0.004939, 0.001695, 0.002065, 0.007712, 0.008869, 0.008209, 0.005867, 0.011251, 0.018453, 0.014345, 0.012573
#*# 	  -0.035105, -0.023563, -0.014800, -0.012802, -0.016405, -0.011710, -0.015440, -0.014677, -0.008372, -0.007005, -0.003401, 0.007325, 0.000983, 0.000636, 0.006006, 0.007077, 0.003560, 0.006287, 0.003641, 0.006526, 0.010685, 0.005273, 0.012562, 0.013248, 0.015056
#*# 	  -0.037558, -0.033390, -0.033298, -0.019634, -0.017377, -0.021786, -0.015799, -0.015316, -0.014566, -0.005168, -0.005815, -0.009462, 0.003190, 0.002292, 0.003347, 0.002537, -0.012849, 0.007581, 0.001003, 0.003147, -0.001942, 0.009036, 0.001446, 0.014319, 0.002954
#*# 	  -0.039159, -0.032553, -0.029183, -0.020462, -0.018080, -0.028956, -0.019515, -0.023936, -0.014832, -0.016810, -0.014237, -0.007827, -0.009385, -0.007620, -0.008838, -0.007511, -0.008732, -0.006665, -0.003191, 0.003543, 0.006601, -0.006538, 0.008498, 0.007028, 0.005496
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 34.9
#*# max_x = 210.0
#*# min_y = 30.0
#*# max_y = 210.0
#*#
#*# [beacon model default]
#*# model_coef = 1.9257982386737142,
#*# 	  2.1904011986275074,
#*# 	  0.5881661108028357,
#*# 	  0.30341866940870527,
#*# 	  0.14823890288711727,
#*# 	  -0.42807822476666274,
#*# 	  -0.13716254071061182,
#*# 	  0.612855529187592,
#*# 	  0.08376843001203003,
#*# 	  -0.2664564217100284
#*# model_domain = 3.352922478536077e-07,3.360945745364866e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 72.578002
#*# model_offset = -0.58000
