##########################
##### BASE CONFIG #######
##########################

[include mainsail.cfg]
[include ./backup/backup.cfg]

##########################
##### HARDWARE STUFF #####
##########################

[include ./hardware/xyz-stepper.cfg]
[include ./hardware/extruder.cfg]
#[include ./klicky/klicky-probe.cfg]
#[include ./hardware/adxl345.cfg]  This config now in canbus.cfg
[include ./hardware/fans.cfg] # Some fans config in canbus.cfg
[include ./hardware/canbus.cfg]

##########################
##### LIGHTS #############
##########################

[include ./hardware/chamber-lighting.cfg]
[include ./hardware/stealthburner-led.cfg]

##########################
##### CALIBRATION ########
##########################

[include ./calibration/z-tilt.cfg]
[include ./calibration/bed-mesh.cfg]
[include ./macros/unsafe.cfg]
[include ./calibration/pressure_advance.cfg]
[include test_probe_accuracy.cfg]

##########################
##### MACROS #############
##########################

[include ./macros/chamber-led.cfg]
[include ./macros/conditional-homing.cfg]
[include ./macros/print-end.cfg]
[include ./macros/print-start-mmu.cfg]
[include ./macros/dump-variables.cfg]
[include ./macros/movement-check.cfg]
[include ./macros/cancel-change.cfg]
[include ./macros/pause-resume.cfg]         ; Overridden by ERCF / subsequantly disabled
[include ./macros/load-unload.cfg]
[include ./macros/filament-change.cfg]
[include ./macros/park.cfg]
#[include ./macros/prusaslicer-accel.cfg]

##########################
##### THIRD PARTY ########
##########################

[include ./third-party-cfg/nozzle_scrub.cfg]
[include ./kamp/Adaptive_Mesh.cfg]
[include ./kamp/Adaptive_Purge.cfg]

##########################
##### ERCF ###############
##########################


[include ercf_hardware.cfg]
[include ercf_parameters.cfg]
[include ercf_software.cfg]
[include ./calibration/ercf_additional.cfg]
#[include ercf_vars.cfg]
[include client_macros.cfg]

##########################
##### LCD/MENU ###########
##########################

#[include ./third-party-cfg/nozzle_scrub_menu.cfg]
#[include ercf_menu.cfg]
#[include ./menu/printer_menu.cfg]

##########################
##### NOT ENABLED YET ####
##########################

#[include ./todo/mini12864.cfg] Add this after adding mini12864 LED
#[include ./todo/lcd_tweaks.cfg] Need to figure this one out and then implement
#[include ./hardware/nevermore.cfg] Disabled as I prefer to chamber vent outside and needed the PWM

##########################
#### REPLACEMENT #########
##########################

[include ./replacement_macros/replace-m900.cfg]
[include ./replacement_macros/replace-m117.cfg]

[exclude_object]

[gcode_arcs]
resolution: 0.1

[respond]
default_type: echo
default_prefix:  

[force_move]
# Enable commands that force potentially unsafe movement
enable_force_move: True

[idle_timeout]
timeout: 14400

[mcu]
##  Obtain definition by "ls -l /dev/serial/by-id/" then unplug to verify
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_290040000750314D35323820-if00
restart_method: command

[mcu rpi]
# Add Rpi as secondary MCU to allow for ADXL use through SPI ribbon/adapter from LDO
serial: /tmp/klipper_host_mcu

[mcu sht]
canbus_uuid: 30993412e8e0

[printer]
kinematics: corexy
max_velocity: 600           # Changed from 200 on 7.11.23
max_accel:  6000            # tuned on 7.11.23 after beacon install.
max_z_velocity: 15          #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 350
square_corner_velocity: 8.0 # Changed on 7.11.23

#####################################################################
#   Input Shaper
#####################################################################

[input_shaper]
shaper_freq_x: 76.2               ; suggested max_accel <= 22600 mm/sec^2
shaper_type_x: zv
shaper_freq_y: 51.8               ; suggested max_accel <= 7900 mm/sec^2
shaper_type_y: mzv


#####################################################################
#   Bed Heater
#####################################################################

##  SSR Pin - HE1
##  Thermistor - TB
[heater_bed]
heater_pin: PA2 #PA2 is LDO default
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF3
##  Adjust Max Power so your heater doesn't warp your bed. Rule of thumb is 0.4 watts / cm^2 .
max_power: 0.6
min_temp: 0
max_temp: 125
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

#####################################################################
#   Probe
#####################################################################

##  WAS TAP - NOW BEACON in CANBUS
#[probe]
#pin: ^sht:PA2
#x_offset: 0
#y_offset: 25.0
#z_offset: 0
#x_offset: 0
#y_offset: 0
#z_offset: 6.42
#speed: 5.0
#lift_speed: 15
#samples: 3
#samples_result: median
#sample_retract_dist: 2.0
#samples_tolerance: 0.01
#samples_tolerance_retries: 3
# After TAP installation, with PLA, Flow Rate 98%, 0.25mm First Layer, 0.6mm CHT nozzle, Z_Offset is z_offset = -0.450
#activate_gcode:
#    {% set PROBE_TEMP = 150 %}
#    {% set MAX_TEMP = PROBE_TEMP + 5 %}
#    {% set ACTUAL_TEMP = printer.extruder.temperature %}
#    {% set TARGET_TEMP = printer.extruder.target %}
#
#    {% if TARGET_TEMP > PROBE_TEMP %}
#        { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (TARGET_TEMP, PROBE_TEMP)) }
#        M109 S{ PROBE_TEMP }
#    {% else %}
#        # Temperature target is already low enough, but nozzle may still be too hot.
#        {% if ACTUAL_TEMP > MAX_TEMP %}
#            { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (ACTUAL_TEMP, MAX_TEMP)) }
#            TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={ MAX_TEMP }
#        {% endif %}
#    {% endif %}

#####################################################################
#  Filament Runout
#####################################################################

#[filament_motion_sensor RunoutSensor]
#detection_length: 10
#extruder: extruder
#switch_pin: ^PG11
#pause_on_runout: True
#runout_gcode:
#  M117 Filament problem, runout has paused.
#  M118 Filament problem, runout has paused.
#insert_gcode:
#event_delay:
#pause_delay:

#####################################################################
#   Additional Sensors
#####################################################################

[thermistor CMFB103F3950FANT]
temperature1: 0.0
resistance1: 32116.0
temperature2: 40.0
resistance2: 5309.0
temperature3: 80.0
resistance3: 1228.0

#[temperature_sensor sb_ambient_temp]
## Chamber Temperature - T1
#sensor_type: CMFB103F3950FANT
#sensor_pin: PF5
#min_temp: 0
#max_temp: 100
#gcode_id: chamber_th

[temperature_sensor back_chamber_temp]
## Chamber Temperature - T
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PF6
min_temp: 0
max_temp: 100
gcode_id: chamber_th2

[temperature_sensor RPi4]
sensor_type: temperature_host
min_temp: 0
max_temp: 100

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################

#[safe_z_home]
##  XY Location of the Z Endstop Switch
##  Update -10,-10 to the XY coordinates of your endstop pin 
##  (such as 157,305) after going through Z Endstop Pin
##  Location Definition step.
#home_xy_position: 147,256
#speed:100
#z_hop:10
#z_hop_speed:10


########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<5V>

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 39.889
#*# pid_ki = 0.964
#*# pid_kd = 412.851
#*#
#*# [probe]
#*# z_offset = -1.270
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.040202, -0.038867, -0.038803, -0.039524, -0.032455, -0.028247, -0.022680, -0.019829, -0.021422, -0.020853, -0.015794, -0.016659, -0.018287, -0.021886, -0.024101, -0.026366, -0.019826, -0.032469, -0.037278, -0.024165, -0.025366, -0.029091, -0.025810, -0.025908, -0.025766
#*# 	  -0.037877, -0.030314, -0.030203, -0.029177, -0.018602, -0.020237, -0.027979, -0.018578, -0.015357, -0.018167, -0.017879, -0.016362, -0.015398, -0.020786, -0.030010, -0.017500, -0.017608, -0.022220, -0.029025, -0.025943, -0.024601, -0.018414, -0.019229, -0.016052, -0.022245
#*# 	  -0.038337, -0.026574, -0.040940, -0.024371, -0.017841, -0.014613, -0.016326, -0.012000, -0.016670, -0.008333, -0.015632, -0.017578, -0.018311, -0.017629, -0.014974, -0.022640, -0.016915, -0.019696, -0.018850, -0.016215, -0.017290, -0.015936, -0.017658, -0.017671, -0.016355
#*# 	  -0.036021, -0.039664, -0.043459, -0.032711, -0.019362, -0.018539, -0.022745, -0.017450, -0.012066, -0.007126, -0.005326, -0.017733, -0.001482, -0.015516, -0.016556, -0.016568, -0.014594, -0.016094, -0.021150, -0.022527, -0.015800, -0.014637, -0.016618, -0.015007, -0.017508
#*# 	  -0.048423, -0.040521, -0.040544, -0.039316, -0.030578, -0.021347, -0.015571, -0.019530, -0.009251, -0.012994, -0.013320, -0.016182, -0.009891, -0.012950, -0.017943, -0.019586, -0.023412, -0.017547, -0.017387, -0.017587, -0.017274, -0.018950, -0.016765, -0.017532, -0.015423
#*# 	  -0.048933, -0.044423, -0.042002, -0.041462, -0.020601, -0.028061, -0.018084, -0.018191, -0.013773, -0.012546, -0.014251, -0.002489, -0.000779, -0.008934, -0.017630, -0.012969, -0.019661, -0.016736, -0.016715, -0.016306, -0.017963, -0.015217, -0.017910, -0.017382, -0.019033
#*# 	  -0.059737, -0.048878, -0.046279, -0.039739, -0.039667, -0.035114, -0.019989, -0.015389, -0.013953, -0.001265, -0.006376, -0.018496, -0.005719, -0.004255, -0.002281, -0.012855, -0.013966, -0.010665, -0.010287, -0.010010, -0.013698, -0.018010, -0.017396, -0.017305, -0.019147
#*# 	  -0.048445, -0.047820, -0.040579, -0.039716, -0.040876, -0.034022, -0.016319, -0.019391, -0.016403, -0.009396, -0.007847, -0.018017, -0.015281, -0.013104, -0.010340, -0.009785, -0.018271, -0.017226, -0.017066, -0.018860, -0.017969, -0.019377, -0.015219, -0.016652, -0.019659
#*# 	  -0.044376, -0.047484, -0.055577, -0.039074, -0.033846, -0.033626, -0.020606, -0.025365, -0.009312, -0.017906, -0.006552, -0.008100, -0.002173, -0.005571, -0.016454, -0.016803, -0.015694, -0.015730, -0.018295, -0.015536, -0.016056, -0.019999, -0.020898, -0.019128, -0.017790
#*# 	  -0.042102, -0.039984, -0.043580, -0.030479, -0.025052, -0.021887, -0.026156, -0.015044, -0.016648, -0.016287, -0.001212, -0.000856, -0.007905, -0.001541, -0.007280, -0.008149, -0.011179, -0.017027, -0.015718, -0.014222, -0.016860, -0.017224, -0.017599, -0.017224, -0.017748
#*# 	  -0.039086, -0.028225, -0.027164, -0.024610, -0.026317, -0.017229, -0.018004, -0.016151, -0.009361, -0.007626, -0.008182, -0.001840, -0.004639, -0.002478, -0.005273, -0.008429, -0.013119, -0.013815, -0.008945, -0.008142, -0.003805, -0.003087, -0.009002, -0.008654, -0.018016
#*# 	  -0.026961, -0.031660, -0.022688, -0.024949, -0.020324, -0.015264, -0.016721, -0.002000, -0.003367, -0.001893, -0.006885, 0.000987, -0.004043, -0.004501, -0.003883, -0.007158, -0.008161, -0.000769, -0.002719, -0.000728, -0.013697, -0.002776, -0.004392, -0.011652, -0.016371
#*# 	  -0.030388, -0.022371, -0.015918, -0.018909, -0.018273, -0.013697, -0.006590, -0.010858, -0.006429, -0.001370, -0.001498, 0.002408, 0.000000, -0.000619, -0.001122, -0.001205, -0.002703, -0.002498, -0.000655, -0.012408, -0.009045, -0.014619, -0.007856, -0.000530, -0.011587
#*# 	  -0.030206, -0.026531, -0.025641, -0.024408, -0.018312, -0.029718, -0.012963, -0.015409, -0.006297, -0.015143, -0.014481, -0.006736, -0.005649, -0.015958, -0.008935, -0.009727, -0.007930, -0.003492, -0.016069, -0.006584, -0.008621, -0.007430, -0.002019, -0.001635, -0.000224
#*# 	  -0.042801, -0.027108, -0.034897, -0.024804, -0.029855, -0.024405, -0.018032, -0.015354, -0.010726, -0.019419, -0.005535, -0.013837, -0.006446, -0.008309, -0.012657, -0.006149, -0.005906, -0.006238, -0.012615, -0.002667, -0.012524, -0.011535, -0.009195, -0.005284, -0.013344
#*# 	  -0.032193, -0.026878, -0.029060, -0.026860, -0.024869, -0.026370, -0.028591, -0.016589, -0.020425, -0.009481, -0.014217, -0.012005, -0.003200, -0.008470, -0.005830, -0.001835, -0.002988, -0.015358, -0.008451, -0.002447, -0.005016, -0.009041, -0.002004, -0.001075, -0.004857
#*# 	  -0.029799, -0.028041, -0.030282, -0.026248, -0.025997, -0.027726, -0.013849, -0.014223, -0.012941, -0.009428, -0.010372, -0.004119, -0.003182, -0.003330, -0.003493, -0.007493, -0.005409, -0.002371, -0.006879, 0.001072, -0.002196, -0.005570, -0.000447, -0.000512, 0.005843
#*# 	  -0.035518, -0.027693, -0.026424, -0.024230, -0.020319, -0.023290, -0.028734, -0.014108, -0.012607, -0.013040, -0.003635, -0.007398, -0.003297, -0.004180, -0.003999, -0.003073, -0.003067, -0.001950, -0.003512, 0.007264, -0.004600, 0.000890, 0.004110, 0.009398, 0.007311
#*# 	  -0.030047, -0.028022, -0.026177, -0.026065, -0.023590, -0.021038, -0.014239, -0.014966, -0.012277, -0.005035, -0.011435, -0.004314, -0.002176, 0.002635, 0.000320, 0.002916, -0.004838, 0.001078, 0.000864, 0.000450, 0.010927, 0.007281, 0.007913, 0.001387, 0.011134
#*# 	  -0.032595, -0.028384, -0.023169, -0.025984, -0.023337, -0.018974, -0.016103, -0.016360, -0.022116, -0.012547, -0.009652, -0.007239, -0.005812, -0.006108, -0.005121, -0.003940, -0.004854, -0.005521, 0.004009, -0.003133, -0.000983, 0.009495, 0.007232, 0.008189, 0.001027
#*# 	  -0.031733, -0.034260, -0.027826, -0.030265, -0.024127, -0.027835, -0.025074, -0.021494, -0.026399, -0.020909, -0.010838, -0.010359, -0.008192, -0.003431, -0.005341, 0.002672, -0.005771, -0.006272, -0.005520, -0.005682, -0.005972, -0.000714, 0.007123, -0.000012, 0.000966
#*# 	  -0.033812, -0.032689, -0.029204, -0.019838, -0.021768, -0.023226, -0.022089, -0.027385, -0.012092, -0.013157, -0.007645, -0.007840, -0.011117, -0.008296, -0.007394, -0.008451, -0.007619, -0.009744, -0.001318, -0.008085, 0.001863, 0.005344, 0.002751, 0.004083, 0.001680
#*# 	  -0.032689, -0.031798, -0.029440, -0.024569, -0.028981, -0.027180, -0.020382, -0.023302, -0.013867, -0.010062, -0.010990, -0.010481, -0.009081, -0.008679, -0.006959, -0.006920, -0.009054, -0.008362, -0.006302, -0.003643, -0.004065, 0.000018, 0.000041, -0.002673, -0.001609
#*# 	  -0.032019, -0.031899, -0.032366, -0.027680, -0.029964, -0.029738, -0.025084, -0.027031, -0.022961, -0.026925, -0.024822, -0.009309, -0.015023, -0.008733, -0.014850, -0.008309, -0.010356, -0.009354, -0.008172, -0.008584, -0.007672, -0.006991, -0.006910, -0.007734, -0.006416
#*# 	  -0.044349, -0.035124, -0.032164, -0.032268, -0.031825, -0.032360, -0.026559, -0.029075, -0.028954, -0.026744, -0.025551, -0.025093, -0.023111, -0.024232, -0.018653, -0.017473, -0.024122, -0.010919, -0.018886, -0.014329, -0.008735, -0.012096, -0.008724, -0.008521, -0.007467
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 34.9
#*# max_x = 210.0
#*# min_y = 30.0
#*# max_y = 210.0
#*#
#*# [beacon model default]
#*# model_coef = 1.9257982386737142,
#*# 	  2.1904011986275074,
#*# 	  0.5881661108028357,
#*# 	  0.30341866940870527,
#*# 	  0.14823890288711727,
#*# 	  -0.42807822476666274,
#*# 	  -0.13716254071061182,
#*# 	  0.612855529187592,
#*# 	  0.08376843001203003,
#*# 	  -0.2664564217100284
#*# model_domain = 3.352922478536077e-07,3.360945745364866e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 72.578002
#*# model_offset = -0.38000
