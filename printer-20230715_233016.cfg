##########################
##### BASE CONFIG #######
##########################

[include mainsail.cfg]
[include ./backup/backup.cfg]

##########################
##### HARDWARE STUFF #####
##########################

[include ./hardware/xyz-stepper.cfg]
[include ./hardware/extruder.cfg]
#[include ./klicky/klicky-probe.cfg]
#[include ./hardware/adxl345.cfg]  This config now in canbus.cfg
[include ./hardware/fans.cfg] # Some fans config in canbus.cfg
[include ./hardware/canbus.cfg]

##########################
##### LIGHTS #############
##########################

[include ./hardware/chamber-lighting.cfg]
[include ./hardware/stealthburner-led.cfg]

##########################
##### CALIBRATION ########
##########################

[include ./calibration/z-tilt.cfg]
[include ./calibration/bed-mesh.cfg]
[include ./macros/unsafe.cfg]
[include ./calibration/pressure_advance.cfg]
[include test_probe_accuracy.cfg]

##########################
##### MACROS #############
##########################

[include ./macros/chamber-led.cfg]
[include ./macros/conditional-homing.cfg]
[include ./macros/print-end.cfg]
[include ./macros/print-start-mmu.cfg]
[include ./macros/dump-variables.cfg]
[include ./macros/movement-check.cfg]
[include ./macros/cancel-change.cfg]
[include ./macros/pause-resume.cfg]         ; Overridden by ERCF / subsequantly disabled
[include ./macros/load-unload.cfg]
[include ./macros/filament-change.cfg]
[include ./macros/park.cfg]
#[include ./macros/prusaslicer-accel.cfg]

##########################
##### THIRD PARTY ########
##########################

[include ./third-party-cfg/nozzle_scrub.cfg]
[include ./kamp/Adaptive_Mesh.cfg]
[include ./kamp/Adaptive_Purge.cfg]

##########################
##### ERCF ###############
##########################


[include ercf_hardware.cfg]
[include ercf_parameters.cfg]
[include ercf_software.cfg]
[include ./calibration/ercf_additional.cfg]
#[include ercf_vars.cfg]
[include client_macros.cfg]

##########################
##### LCD/MENU ###########
##########################

#[include ./third-party-cfg/nozzle_scrub_menu.cfg]
#[include ercf_menu.cfg]
#[include ./menu/printer_menu.cfg]

##########################
##### NOT ENABLED YET ####
##########################

#[include ./todo/mini12864.cfg] Add this after adding mini12864 LED
#[include ./todo/lcd_tweaks.cfg] Need to figure this one out and then implement
#[include ./hardware/nevermore.cfg] Disabled as I prefer to chamber vent outside and needed the PWM

##########################
#### REPLACEMENT #########
##########################

[include ./replacement_macros/replace-m900.cfg]
[include ./replacement_macros/replace-m117.cfg]

[exclude_object]

[gcode_arcs]
resolution: 0.1

[respond]
default_type: echo
default_prefix:  

[force_move]
# Enable commands that force potentially unsafe movement
enable_force_move: True

[idle_timeout]
timeout: 14400

[mcu]
##  Obtain definition by "ls -l /dev/serial/by-id/" then unplug to verify
serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_290040000750314D35323820-if00
restart_method: command

[mcu rpi]
# Add Rpi as secondary MCU to allow for ADXL use through SPI ribbon/adapter from LDO
serial: /tmp/klipper_host_mcu

[mcu sht]
canbus_uuid: 30993412e8e0

[printer]
kinematics: corexy
max_velocity: 600           # Changed from 200 on 7.11.23
max_accel:  6000            # tuned on 7.11.23 after beacon install.
max_z_velocity: 15          #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 350
square_corner_velocity: 8.0 # Changed on 7.11.23

#####################################################################
#   Input Shaper
#####################################################################

[input_shaper]
shaper_freq_x: 76.2               ; suggested max_accel <= 22600 mm/sec^2
shaper_type_x: zv
shaper_freq_y: 51.8               ; suggested max_accel <= 7900 mm/sec^2
shaper_type_y: mzv


#####################################################################
#   Bed Heater
#####################################################################

##  SSR Pin - HE1
##  Thermistor - TB
[heater_bed]
heater_pin: PA2 #PA2 is LDO default
sensor_type: ATC Semitec 104NT-4-R025H42G
sensor_pin: PF3
##  Adjust Max Power so your heater doesn't warp your bed. Rule of thumb is 0.4 watts / cm^2 .
max_power: 0.6
min_temp: 0
max_temp: 125
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

#####################################################################
#   Probe
#####################################################################

##  WAS TAP - NOW BEACON in CANBUS
#[probe]
#pin: ^sht:PA2
#x_offset: 0
#y_offset: 25.0
#z_offset: 0
#x_offset: 0
#y_offset: 0
#z_offset: 6.42
#speed: 5.0
#lift_speed: 15
#samples: 3
#samples_result: median
#sample_retract_dist: 2.0
#samples_tolerance: 0.01
#samples_tolerance_retries: 3
# After TAP installation, with PLA, Flow Rate 98%, 0.25mm First Layer, 0.6mm CHT nozzle, Z_Offset is z_offset = -0.450
#activate_gcode:
#    {% set PROBE_TEMP = 150 %}
#    {% set MAX_TEMP = PROBE_TEMP + 5 %}
#    {% set ACTUAL_TEMP = printer.extruder.temperature %}
#    {% set TARGET_TEMP = printer.extruder.target %}
#
#    {% if TARGET_TEMP > PROBE_TEMP %}
#        { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (TARGET_TEMP, PROBE_TEMP)) }
#        M109 S{ PROBE_TEMP }
#    {% else %}
#        # Temperature target is already low enough, but nozzle may still be too hot.
#        {% if ACTUAL_TEMP > MAX_TEMP %}
#            { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (ACTUAL_TEMP, MAX_TEMP)) }
#            TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={ MAX_TEMP }
#        {% endif %}
#    {% endif %}

#####################################################################
#  Filament Runout
#####################################################################

#[filament_motion_sensor RunoutSensor]
#detection_length: 10
#extruder: extruder
#switch_pin: ^PG11
#pause_on_runout: True
#runout_gcode:
#  M117 Filament problem, runout has paused.
#  M118 Filament problem, runout has paused.
#insert_gcode:
#event_delay:
#pause_delay:

#####################################################################
#   Additional Sensors
#####################################################################

[thermistor CMFB103F3950FANT]
temperature1: 0.0
resistance1: 32116.0
temperature2: 40.0
resistance2: 5309.0
temperature3: 80.0
resistance3: 1228.0

#[temperature_sensor sb_ambient_temp]
## Chamber Temperature - T1
#sensor_type: CMFB103F3950FANT
#sensor_pin: PF5
#min_temp: 0
#max_temp: 100
#gcode_id: chamber_th

[temperature_sensor back_chamber_temp]
## Chamber Temperature - T
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PF6
min_temp: 0
max_temp: 100
gcode_id: chamber_th2

[temperature_sensor RPi4]
sensor_type: temperature_host
min_temp: 0
max_temp: 100

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################

#[safe_z_home]
##  XY Location of the Z Endstop Switch
##  Update -10,-10 to the XY coordinates of your endstop pin 
##  (such as 157,305) after going through Z Endstop Pin
##  Location Definition step.
#home_xy_position: 147,256
#speed:100
#z_hop:10
#z_hop_speed:10


########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<5V>

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 39.889
#*# pid_ki = 0.964
#*# pid_kd = 412.851
#*#
#*# [probe]
#*# z_offset = -1.270
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.057482, -0.054364, -0.054082, -0.043553, -0.042487, -0.039574, -0.038215, -0.043269, -0.033823, -0.033021, -0.038066, -0.038787, -0.028279, -0.026770, -0.036104, -0.045162, -0.043748, -0.046830, -0.047632, -0.046586, -0.044005, -0.047367, -0.041638, -0.046160, -0.050153
#*# 	  -0.048335, -0.046898, -0.036737, -0.038594, -0.022514, -0.023198, -0.026683, -0.024798, -0.014549, -0.021051, -0.015176, -0.021530, -0.023733, -0.023755, -0.024010, -0.025281, -0.034953, -0.034029, -0.036801, -0.036386, -0.035944, -0.035774, -0.035355, -0.038509, -0.038742
#*# 	  -0.041454, -0.036352, -0.033079, -0.032243, -0.030343, -0.022322, -0.017764, -0.018269, -0.017090, -0.015390, -0.017369, -0.012483, -0.018300, -0.015581, -0.021765, -0.024957, -0.035030, -0.035381, -0.043120, -0.035350, -0.034105, -0.025444, -0.037001, -0.040864, -0.033685
#*# 	  -0.043148, -0.043817, -0.039774, -0.035216, -0.026459, -0.021531, -0.021257, -0.018572, -0.010212, -0.012794, -0.014484, -0.015237, -0.013930, -0.019560, -0.019097, -0.020836, -0.022719, -0.031607, -0.032062, -0.024257, -0.023670, -0.026980, -0.037586, -0.030478, -0.032288
#*# 	  -0.045706, -0.043862, -0.045614, -0.037912, -0.034990, -0.020004, -0.016801, -0.012509, -0.019697, -0.012295, -0.005112, -0.008179, -0.011929, -0.011081, -0.018323, -0.024194, -0.023990, -0.027371, -0.039341, -0.025548, -0.045284, -0.038816, -0.031299, -0.027663, -0.044985
#*# 	  -0.045733, -0.046390, -0.043632, -0.040433, -0.035442, -0.025592, -0.018888, -0.012759, -0.008610, -0.004587, -0.010927, -0.009274, -0.008699, -0.018396, -0.016906, -0.018796, -0.019639, -0.022963, -0.024851, -0.025190, -0.028902, -0.034471, -0.038932, -0.035590, -0.039509
#*# 	  -0.045180, -0.046162, -0.040488, -0.031600, -0.030961, -0.019451, -0.009226, -0.016867, -0.011137, -0.012749, 0.002003, -0.011531, -0.002534, -0.006797, -0.018766, -0.019952, -0.022034, -0.024360, -0.023467, -0.024849, -0.027642, -0.037939, -0.025759, -0.036268, -0.039881
#*# 	  -0.036252, -0.035971, -0.032420, -0.032655, -0.020226, -0.019232, -0.016983, -0.009749, -0.008492, 0.000141, -0.008044, -0.004801, 0.000895, -0.005791, -0.008906, -0.018303, -0.011463, -0.020857, -0.022137, -0.027857, -0.024793, -0.039643, -0.028334, -0.035425, -0.039745
#*# 	  -0.021218, -0.035231, -0.022896, -0.019758, -0.022013, -0.017005, -0.007111, -0.004321, 0.000491, 0.000043, -0.004514, 0.001202, -0.001294, -0.002512, -0.012635, -0.015103, -0.016552, -0.021121, -0.022692, -0.025327, -0.031242, -0.025980, -0.024935, -0.039716, -0.040187
#*# 	  -0.026683, -0.018759, -0.020839, -0.019330, -0.018436, -0.009086, -0.019141, 0.001134, 0.004713, 0.005515, 0.000831, -0.010247, -0.002732, -0.002203, -0.018808, -0.019753, -0.016406, -0.020774, -0.013793, -0.023950, -0.023733, -0.025964, -0.027760, -0.028813, -0.041549
#*# 	  -0.012049, -0.009309, -0.005511, -0.014525, -0.003464, -0.019225, -0.006480, -0.001018, 0.001166, 0.000249, 0.001036, 0.001310, -0.000901, -0.006442, -0.018665, -0.020864, -0.018715, -0.017837, -0.018376, -0.019387, -0.033461, -0.022184, -0.028534, -0.026121, -0.044797
#*# 	  -0.005265, -0.003431, -0.003408, 0.004304, -0.006011, -0.004030, 0.003207, -0.001411, 0.005351, -0.004133, 0.005995, -0.003235, -0.002030, -0.002313, -0.007332, -0.003226, -0.014258, -0.016637, -0.022473, -0.024171, -0.020479, -0.024812, -0.028808, -0.029510, -0.044822
#*# 	  0.000207, 0.004089, 0.004640, -0.003245, 0.005259, 0.007009, 0.006626, 0.002695, 0.012763, 0.006188, 0.004418, -0.003069, 0.000000, -0.003291, -0.003447, -0.008479, -0.007183, -0.018181, -0.017766, -0.028574, -0.028409, -0.024088, -0.021367, -0.029955, -0.039478
#*# 	  0.001581, 0.006812, 0.006526, 0.007397, 0.006031, -0.000853, 0.008203, 0.001833, 0.001859, 0.009419, 0.000185, -0.006808, 0.004239, 0.001940, 0.001183, -0.015909, -0.013256, -0.016870, -0.020227, -0.026981, -0.028301, -0.024902, -0.029413, -0.032226, -0.033031
#*# 	  0.006283, 0.004397, 0.012361, 0.003976, 0.011544, 0.008432, 0.009441, 0.004255, 0.006304, -0.003210, 0.004185, 0.001753, -0.004789, -0.002348, -0.010005, -0.005900, -0.006499, -0.023006, -0.020210, -0.015505, -0.023347, -0.016544, -0.022404, -0.029124, -0.036960
#*# 	  0.011010, 0.007581, 0.006680, 0.000941, 0.009563, 0.008896, 0.004152, 0.002582, 0.003962, 0.002093, 0.014500, 0.006871, 0.007546, 0.003602, -0.003481, -0.003879, -0.013521, -0.009121, -0.010939, -0.016280, -0.022987, -0.015077, -0.021302, -0.025446, -0.030860
#*# 	  0.012020, 0.016283, 0.014261, 0.017896, 0.018209, 0.007959, 0.011055, 0.011024, 0.019727, 0.016807, 0.011630, 0.011338, 0.013712, 0.007548, 0.003117, -0.003898, -0.004952, -0.006082, -0.010445, -0.010727, -0.010150, -0.015210, -0.014952, -0.018420, -0.034353
#*# 	  0.020816, 0.023494, 0.020683, 0.023048, 0.015186, 0.016726, 0.019271, 0.012918, 0.022124, 0.017360, 0.017691, 0.016327, 0.013739, 0.014980, 0.015635, 0.006728, 0.001129, -0.006918, -0.003759, -0.007367, -0.001534, -0.004625, -0.007661, -0.007157, -0.014834
#*# 	  0.027737, 0.032817, 0.028521, 0.027266, 0.015204, 0.019531, 0.021012, 0.025482, 0.019181, 0.025159, 0.018861, 0.018682, 0.016931, 0.017937, 0.013354, 0.012882, 0.013963, 0.002522, -0.000201, -0.006836, -0.000240, -0.000904, -0.009473, -0.006375, -0.014132
#*# 	  0.037739, 0.015495, 0.030966, 0.035138, 0.032644, 0.026850, 0.016529, 0.019224, 0.020218, 0.022248, 0.021939, 0.016803, 0.014614, 0.016288, 0.015656, 0.010063, 0.002750, 0.003364, 0.009371, -0.004836, -0.006304, -0.007641, -0.006485, -0.008321, -0.021454
#*# 	  0.036472, 0.038171, 0.035139, 0.031295, 0.032433, 0.024546, 0.025914, 0.020464, 0.020176, 0.016365, 0.021860, 0.019156, 0.018300, 0.012309, 0.016805, 0.012627, 0.008052, -0.001306, -0.000190, -0.008501, -0.004500, -0.010580, -0.010478, -0.012607, -0.011499
#*# 	  0.035322, 0.032189, 0.028783, 0.036310, 0.038426, 0.029700, 0.021866, 0.019563, 0.022674, 0.021174, 0.020250, 0.014469, 0.018255, 0.015207, 0.014638, 0.013466, 0.001843, -0.000013, -0.001027, -0.004140, -0.010677, -0.009105, -0.010436, -0.011406, -0.010940
#*# 	  0.035568, 0.037343, 0.033401, 0.028497, 0.029675, 0.036787, 0.026266, 0.036165, 0.024805, 0.025431, 0.024724, 0.023747, 0.014417, 0.012337, 0.017000, 0.000427, 0.013624, 0.004990, 0.000106, 0.000557, -0.003111, -0.006319, -0.011617, -0.013386, -0.016603
#*# 	  0.038007, 0.038726, 0.041031, 0.038696, 0.036793, 0.037149, 0.036648, 0.030067, 0.024996, 0.018993, 0.025858, 0.016225, 0.021418, 0.015618, 0.008709, -0.000828, -0.006825, 0.000098, -0.000945, -0.004463, -0.003663, -0.013907, -0.012951, -0.011592, -0.014706
#*# 	  0.038681, 0.038538, 0.041456, 0.036289, 0.034025, 0.035428, 0.034406, 0.031953, 0.022242, 0.025130, 0.013955, 0.017180, 0.015941, 0.012899, 0.002633, -0.001787, -0.005251, 0.000226, -0.009960, -0.012159, -0.012831, -0.013831, -0.029815, -0.029343, -0.023196
#*# x_count = 25
#*# y_count = 25
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 210.0
#*# min_y = 30.0
#*# max_y = 210.0
#*#
#*# [beacon model default]
#*# model_coef = 1.9257982386737142,
#*# 	2.1904011986275074,
#*# 	0.5881661108028357,
#*# 	0.30341866940870527,
#*# 	0.14823890288711727,
#*# 	-0.42807822476666274,
#*# 	-0.13716254071061182,
#*# 	0.612855529187592,
#*# 	0.08376843001203003,
#*# 	-0.2664564217100284
#*# model_domain = 3.352922478536077e-07,3.360945745364866e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 72.578002
#*# model_offset = -0.24000
